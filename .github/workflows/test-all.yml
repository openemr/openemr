##
# OpenEMR has two different kinds of tests:
# - "Isolated tests": Tests that run without secondary services, a data layer or significant initialization requirements
# - "Tests": Tests that require a database and initialization before they can run or pass.
# This workflow runs the kind that requires initialization.
#
# Matrix strategy:
# - Pull requests: Only PHP 8.2 configurations (oldest supported) for faster feedback
# - Pull requests with "Test-Mode: full" trailer: All configurations (like nightly)
# - Push to master/rel-*: All configurations
#
# To run all configurations on a PR (useful for debugging flaky tests that only
# appear in specific configurations), add this trailer to any commit message:
#
#   Test-Mode: full
#
# Coverage is collected for one configuration (apache_82_118 on PRs, apache_84_114 on push).
# Full coverage across ALL configurations runs in the scheduled nightly workflow.

name: Test All Configurations

on:
  push:
    branches:
    - master
    - rel-*
  pull_request:
    branches:
    - master
    - rel-*

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event_name == 'pull_request' && github.event.number || github.run_id }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  collect:
    runs-on: ubuntu-24.04
    steps:
    - name: Checkout Code
      uses: actions/checkout@v6
      with:
        # For PRs, checkout the PR head ref to access commit trailers
        ref: ${{ github.event.pull_request.head.sha || github.sha }}
        # Fetch enough history to find the merge base with the target branch
        fetch-depth: 0

    - name: Check for full test mode
      id: test-mode
      if: github.event_name == 'pull_request'
      env:
        BASE_REF: ${{ github.event.pull_request.base.ref }}
      run: |
        # Find merge base with the target branch and check commits for trailer
        # The checkout with fetch-depth=0 already has full history
        merge_base=$(git merge-base "origin/${BASE_REF}" HEAD) || {
          echo "::warning::Could not find merge base, skipping trailer check"
          echo 'full=false' >> "$GITHUB_OUTPUT"
          exit 0
        }
        echo "::debug::Checking commits ${merge_base}..HEAD for Test-Mode trailer"
        if git log --format='%(trailers:key=Test-Mode,valueonly)' "${merge_base}..HEAD" | grep -qi '^full$'; then
          echo 'full=true' >> "$GITHUB_OUTPUT"
          echo "::notice::Full test mode enabled via commit trailer"
        else
          echo 'full=false' >> "$GITHUB_OUTPUT"
        fi

    - name: Collect Docker Dirs
      id: docker-dirs
      env:
        IS_PULL_REQUEST: ${{ github.event_name == 'pull_request' }}
        FULL_TEST_MODE: ${{ steps.test-mode.outputs.full }}
      ##
      # Collect the docker directory names from ci subdirectories
      # and compute display names for each configuration.
      # For PRs (without full mode): only PHP 8.2 configs (oldest supported).
      # For PRs with full mode or pushes to master/rel-*: all configs.
      run: |
        shopt -s nullglob
        shopt -s extglob
        # Remove compose-shared-* from the list
        dirs=( ci/!(compose-shared-*)/docker-compose.yml )
        dirs=( "${dirs[@]%/docker-compose.yml}" )
        dirs=( "${dirs[@]#ci/}" )

        if [[ "${IS_PULL_REQUEST}" = 'true' && "${FULL_TEST_MODE}" != 'true' ]]; then
          # For PRs without full mode: filter to only PHP 8.2 configurations
          ci/parse_docker_dir.sh "${dirs[@]}" |
            jq -rc --arg is_pr "${IS_PULL_REQUEST}" 'map({
              docker_dir: .output.docker_dir,
              php: .output.php,
              display_name: "PHP \(.output.php) - \(.output.webserver) - \(.output.database) \(.output.db)",
              save_composer_cache: .output.save_composer_cache,
              save_node_cache: .output.save_node_cache
            }) | map(select(.php == "8.2")) | "configs=\(.)"' >> "$GITHUB_OUTPUT"
        else
          # For PRs with full mode or pushes: include all configurations
          ci/parse_docker_dir.sh "${dirs[@]}" |
            jq -rc 'map({
              docker_dir: .output.docker_dir,
              display_name: "PHP \(.output.php) - \(.output.webserver) - \(.output.database) \(.output.db)",
              save_composer_cache: .output.save_composer_cache,
              save_node_cache: .output.save_node_cache
            }) | "configs=\(.)"' >> "$GITHUB_OUTPUT"
        fi
    outputs:
      configs: ${{ steps.docker-dirs.outputs.configs }}
  build:
    name: ${{ matrix.config.display_name }}
    needs: collect
    strategy:
      fail-fast: false
      matrix:
        config: ${{ fromJson(needs.collect.outputs.configs) }}
    uses: ./.github/workflows/test.yml
    secrets: inherit
    with:
      docker_dir: ${{ matrix.config.docker_dir }}
      display_name: ${{ matrix.config.display_name }}
      # Enable coverage for one config: apache_82_118 on PRs (oldest PHP), apache_84_114 on push
      # Full coverage for all configs runs in scheduled nightly workflow
      enable_coverage: ${{ (github.event_name == 'pull_request' && matrix.config.docker_dir == 'apache_82_118') || (github.event_name != 'pull_request' && matrix.config.docker_dir == 'apache_84_114') }}
      save_composer_cache: ${{ matrix.config.save_composer_cache == 'true' }}
      save_node_cache: ${{ matrix.config.save_node_cache == 'true' }}
