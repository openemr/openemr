name: Conventional Commits

on:
  pull_request:
    branches:
    - master
    - rel-*
    types:
    - opened
    - edited
    - synchronize

permissions:
  contents: read
  pull-requests: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event_name == 'pull_request' && github.event.number || github.run_id }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:

  validate_pr_title:
    runs-on: ubuntu-24.04
    name: PR Title
    strategy:
      matrix:
        php-version: ['8.4']
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
    - name: Install PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-version }}
        coverage: none
    - name: Get Composer Cache Directory
      id: composer-cache
      run: |
        {
          printf 'dir='
          composer config cache-files-dir
        } >> "$GITHUB_OUTPUT"
    - name: Cache Composer
      uses: actions/cache@v5
      with:
        path: ${{ steps.composer-cache.outputs.dir }}
        key: ${{ runner.os }}-composer-${{ matrix.php-version }}-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-composer-${{ matrix.php-version }}-
          ${{ runner.os }}-composer-
    - name: Composer Install
      run: composer install --prefer-dist --no-progress
    - name: Validate PR title
      env:
        PR_TITLE: ${{ github.event.pull_request.title }}
      run: composer conventional-commits:check -- "$PR_TITLE"

  validate_commits:
    runs-on: ubuntu-24.04
    name: Commits
    strategy:
      matrix:
        php-version: ['8.4']
    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0
    - name: Install PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: ${{ matrix.php-version }}
        coverage: none
    - name: Get Composer Cache Directory
      id: composer-cache
      run: |
        {
          printf 'dir='
          composer config cache-files-dir
        } >> "$GITHUB_OUTPUT"
    - name: Cache Composer
      uses: actions/cache@v5
      with:
        path: ${{ steps.composer-cache.outputs.dir }}
        key: ${{ runner.os }}-composer-${{ matrix.php-version }}-${{ hashFiles('**/composer.lock') }}
        restore-keys: |
          ${{ runner.os }}-composer-${{ matrix.php-version }}-
          ${{ runner.os }}-composer-
    - name: Composer Install
      run: composer install --prefer-dist --no-progress
    - name: Validate all commits in PR
      run: |
        failed=0
        while IFS= read -r commit_msg; do
          if ! composer conventional-commits:check -- "$commit_msg"; then
            failed=1
          fi
        done < <(git log --format=%s ${{ github.event.pull_request.base.sha }}..${{ github.event.pull_request.head.sha }})
        exit $failed
