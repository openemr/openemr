name: Semgrep Security Scan

on:
  push:
    branches:
    - master
    - rel-*
  pull_request:
    branches:
    - master
    - rel-*
  schedule:
    # Run weekly on Monday at 9am UTC
  - cron: 0 9 * * 1
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event_name == 'pull_request' && github.event.number || github.run_id }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  semgrep:
    name: Semgrep PHP Security Scan
    runs-on: ubuntu-latest
    container:
      image: semgrep/semgrep:latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Run Semgrep (full scan)
      if: github.event_name != 'pull_request'
      # Exclude the default echoed-request rule from p/php and use our custom
      # version in semgrep.yaml instead. Our custom rule adds OpenEMR's
      # sanitization functions (attr, text, xlt, etc.) to prevent false positives
      # while still detecting real XSS vulnerabilities.
      run: |
        semgrep \
          --config p/php \
          --config p/security-audit \
          --config ./semgrep.yaml \
          --exclude vendor \
          --exclude node_modules \
          --exclude tests \
          --exclude ccdaservice/node_modules \
          --exclude-rule php.lang.security.injection.echoed-request.echoed-request \
          --sarif \
          --output=semgrep-results.sarif \
          .

    - name: Run Semgrep (PR diff only)
      if: github.event_name == 'pull_request'
      env:
        BASE_SHA: ${{ github.event.pull_request.base.sha }}
      # Exclude the default echoed-request rule from p/php and use our custom
      # version in semgrep.yaml instead. Our custom rule adds OpenEMR's
      # sanitization functions (attr, text, xlt, etc.) to prevent false positives
      # while still detecting real XSS vulnerabilities.
      run: |
        git config --global --add safe.directory "$GITHUB_WORKSPACE"
        semgrep \
          --config p/php \
          --config p/security-audit \
          --config ./semgrep.yaml \
          --exclude vendor \
          --exclude node_modules \
          --exclude tests \
          --exclude ccdaservice/node_modules \
          --exclude-rule php.lang.security.injection.echoed-request.echoed-request \
          --baseline-commit="$BASE_SHA" \
          --sarif \
          --output=semgrep-results.sarif \
          .

    - name: Upload SARIF results
      uses: github/codeql-action/upload-sarif@v4
      if: always()
      with:
        sarif_file: semgrep-results.sarif

    - name: Upload results as artifact
      uses: actions/upload-artifact@v6
      if: always()
      with:
        name: semgrep-results
        path: semgrep-results.sarif
        retention-days: 30
