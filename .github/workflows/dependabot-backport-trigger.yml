# Triggers the dependabot backport workflow when a dependabot PR is merged or manually
#
# This workflow handles two scenarios:
# 1. Automatic: When a dependabot PR is merged to master
# 2. Manual: Via workflow_dispatch for any merged dependabot PR
#
# Generated with assistance from GitHub Copilot

name: Dependabot Backport Trigger

on:
  pull_request_target:
    types: [closed]
    branches:
      - master
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to backport (must be a merged dependabot PR)'
        required: true
        type: number

permissions:
  contents: read
  pull-requests: read

jobs:
  fetch-pr-data:
    runs-on: ubuntu-24.04
    outputs:
      pr_number: ${{ steps.pr-data.outputs.pr_number }}
      pr_title: ${{ steps.pr-data.outputs.pr_title }}
      pr_body: ${{ steps.pr-data.outputs.pr_body }}
      pr_labels: ${{ steps.pr-data.outputs.pr_labels }}
      pr_author: ${{ steps.pr-data.outputs.pr_author }}
      merge_commit: ${{ steps.pr-data.outputs.merge_commit }}
      is_dependabot: ${{ steps.pr-data.outputs.is_dependabot }}
      is_merged: ${{ steps.pr-data.outputs.is_merged }}
    
    steps:
      - name: Fetch PR information (for workflow_dispatch)
        id: fetch-pr
        if: github.event_name == 'workflow_dispatch'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ inputs.pr_number }}"
          echo "Fetching PR #${PR_NUMBER}..."
          
          # Fetch PR data using GitHub CLI and output to GITHUB_OUTPUT
          {
            echo 'pr_data<<EOF'
            gh pr view "$PR_NUMBER" --json number,title,author,labels,mergeCommit,merged,body
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"

      - name: Check if PR was merged (workflow_dispatch)
        if: github.event_name == 'workflow_dispatch' && fromJSON(steps.fetch-pr.outputs.pr_data).merged != true
        run: |
          echo "::error::PR #${{ inputs.pr_number }} is not merged. Only merged PRs can be backported."
          exit 1

      - name: Check if PR is from dependabot (workflow_dispatch)
        if: github.event_name == 'workflow_dispatch' && fromJSON(steps.fetch-pr.outputs.pr_data).author.login != 'dependabot[bot]'
        run: |
          echo "::error::PR #${{ inputs.pr_number }} is not from dependabot (author: ${{ fromJSON(steps.fetch-pr.outputs.pr_data).author.login }}). Only dependabot PRs can be backported."
          exit 1

      - name: Validate pull_request_target event
        if: github.event_name == 'pull_request_target'
        run: |
          # Check if PR was merged
          if [[ "${{ github.event.pull_request.merged }}" != "true" ]]; then
            echo "::notice::PR was closed but not merged, skipping backport"
            exit 0
          fi
          
          # Check if PR is from dependabot
          if [[ "${{ github.event.pull_request.user.login }}" != "dependabot[bot]" ]]; then
            echo "::notice::PR is not from dependabot, skipping backport"
            exit 0
          fi

      - name: Extract PR information
        id: pr-data
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Determine the source of PR data
          if [[ "${{ github.event_name }}" = "workflow_dispatch" ]]; then
            # Use fetched PR data for manual trigger
            PR_DATA='${{ steps.fetch-pr.outputs.pr_data }}'
            
            PR_NUMBER=$(echo "$PR_DATA" | jq -r '.number')
            PR_TITLE=$(echo "$PR_DATA" | jq -r '.title')
            PR_BODY=$(echo "$PR_DATA" | jq -r '.body // ""')
            MERGE_COMMIT=$(echo "$PR_DATA" | jq -r '.mergeCommit.oid')
            AUTHOR=$(echo "$PR_DATA" | jq -r '.author.login')
            
            # Extract labels using jq
            LABEL_NAMES=$(jq -cr '.labels | map(.name) | join(",")' <<< "$PR_DATA")
          else
            # Use event data for automatic trigger
            PR_NUMBER="${{ github.event.pull_request.number }}"
            PR_TITLE="${{ github.event.pull_request.title }}"
            PR_BODY="${{ github.event.pull_request.body }}"
            MERGE_COMMIT="${{ github.event.pull_request.merge_commit_sha }}"
            AUTHOR="${{ github.event.pull_request.user.login }}"
            
            # Extract labels using GitHub's toJSON function and jq
            LABELS='${{ toJSON(github.event.pull_request.labels) }}'
            LABEL_NAMES=$(jq -cr 'map(.name) | join(",")' <<< "$LABELS")
          fi
          
          echo "pr_number=${PR_NUMBER}" >> $GITHUB_OUTPUT
          echo "pr_title=${PR_TITLE}" >> $GITHUB_OUTPUT
          echo "merge_commit=${MERGE_COMMIT}" >> $GITHUB_OUTPUT
          echo "pr_author=${AUTHOR}" >> $GITHUB_OUTPUT
          echo "pr_labels=${LABEL_NAMES}" >> $GITHUB_OUTPUT
          
          # Store PR body for later use (escape for multiline)
          echo "pr_body<<EOF" >> $GITHUB_OUTPUT
          echo "$PR_BODY" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # Set flags for validation
          echo "is_dependabot=true" >> $GITHUB_OUTPUT
          echo "is_merged=true" >> $GITHUB_OUTPUT

  trigger-backports:
    needs: fetch-pr-data
    if: needs.fetch-pr-data.outputs.is_dependabot == 'true' && needs.fetch-pr-data.outputs.is_merged == 'true'
    strategy:
      fail-fast: false
      matrix:
        target_branch:
          - rel-704
    uses: ./.github/workflows/dependabot-backport-reusable.yml
    with:
      pr_number: ${{ fromJSON(needs.fetch-pr-data.outputs.pr_number) }}
      pr_title: ${{ needs.fetch-pr-data.outputs.pr_title }}
      pr_body: ${{ needs.fetch-pr-data.outputs.pr_body }}
      pr_labels: ${{ needs.fetch-pr-data.outputs.pr_labels }}
      pr_author: ${{ needs.fetch-pr-data.outputs.pr_author }}
      merge_commit: ${{ needs.fetch-pr-data.outputs.merge_commit }}
      target_branch: ${{ matrix.target_branch }}
    permissions:
      contents: write
      pull-requests: write
      issues: write
