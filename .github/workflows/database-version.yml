# Ensures v_database is aligned between version.php and sql/database.sql
# and that database.sql schema changes include corresponding upgrade SQL.
#
# The v_database value must be:
# 1. Declared in version.php as: $v_database = NNN;
# 2. Declared in sql/database.sql header as: -- v_database: NNN
# 3. Both values must match
#
# Additionally, if database.sql has schema changes and v_database was bumped,
# at least one upgrade SQL file should also be modified.
#
# This prevents database migrations from being silently skipped on upgrades.
name: Database Version Check

on:
  pull_request:
    branches:
    - master
    - rel-*
    paths:
    - version.php
    - sql/database.sql
    - sql/patch.sql
    - sql/*-to-*_upgrade.sql

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-${{ github.event.number || github.run_id }}
  cancel-in-progress: true

jobs:
  check-v-database:
    name: Check v_database alignment
    runs-on: ubuntu-24.04
    steps:
    - name: Checkout Code
      uses: actions/checkout@v6
      with:
        fetch-depth: 0

    - name: Setup PHP
      uses: ./.github/actions/setup-php-composer
      with:
        php-version: '8.2'

    - name: Check v_database alignment
      run: |
        # Extract v_database from version.php using AST parser
        php_version=$(php bin/get-v-database.php version.php)

        # Extract v_database from database.sql header comment
        sql_version=$(awk '/^-- v_database:/ { print $3; exit }' sql/database.sql)

        # Check if database.sql has the v_database comment
        if [[ -z "$sql_version" ]]; then
          {
            echo '## ❌ Missing v_database in database.sql'
            echo
            echo 'The `sql/database.sql` file must declare the database version in its header:'
            echo
            echo '```sql'
            echo '--'
            echo '-- Database: `openemr`'
            printf '%s\n' "-- v_database: $php_version"
            echo '--'
            echo '```'
            echo
            printf 'This should match the %s value in %s (currently %s).\n' '`$v_database`' '`version.php`' "$php_version"
          } >> "$GITHUB_STEP_SUMMARY"
          exit 1
        fi

        # Check if versions match
        if [[ "$php_version" != "$sql_version" ]]; then
          {
            echo '## ❌ v_database mismatch'
            echo
            echo 'The database version numbers do not match:'
            echo
            echo '| File | Value |'
            echo '|------|-------|'
            printf '| `version.php` | %s |\n' "$php_version"
            printf '| `sql/database.sql` | %s |\n' "$sql_version"
            echo
            echo '### How to fix'
            echo
            echo 'Both files must have the same v_database value. Update whichever is incorrect:'
            echo
            echo '**version.php:**'
            echo '```php'
            printf '$v_database = %s;\n' "$php_version"
            echo '```'
            echo
            echo '**sql/database.sql** (in header):'
            echo '```sql'
            printf '%s\n' "-- v_database: $php_version"
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"
          exit 1
        fi

        {
          echo '## ✅ v_database is aligned'
          echo
          printf 'Both `version.php` and `sql/database.sql` declare v_database = %s\n' "$php_version"
        } >> "$GITHUB_STEP_SUMMARY"

    - name: Check for missing upgrade SQL
      run: |
        base_ref="origin/${{ github.base_ref }}"

        # Check if database.sql was modified in this PR
        if ! git diff --name-only "$base_ref"...HEAD | grep -q '^sql/database.sql$'; then
          echo '::notice::database.sql was not modified — skipping upgrade SQL check.'
          exit 0
        fi

        # Check if changes to database.sql include schema-affecting statements
        # (CREATE TABLE, ALTER TABLE, column definitions, INSERT for schema-config tables)
        schema_diff=$(git diff "$base_ref"...HEAD -- sql/database.sql | grep '^[+-]' | grep -v '^[+-]\{3\}' || true)

        # Look for structural DDL patterns in the diff
        has_schema_changes=false
        if echo "$schema_diff" | grep -qiE '^\+.*(CREATE TABLE|ALTER TABLE|DROP TABLE|ADD COLUMN|DROP COLUMN|MODIFY COLUMN|CHANGE COLUMN)'; then
          has_schema_changes=true
        fi

        if [[ "$has_schema_changes" != "true" ]]; then
          echo '::notice::No schema-affecting DDL changes in database.sql — skipping upgrade SQL check.'
          exit 0
        fi

        # database.sql has schema changes — check if v_database was bumped
        base_v_database=$(git show "$base_ref":version.php | grep -oP '\$v_database\s*=\s*\K[0-9]+' || echo "0")
        head_v_database=$(grep -oP '\$v_database\s*=\s*\K[0-9]+' version.php || echo "0")

        if [[ "$base_v_database" == "$head_v_database" ]]; then
          {
            echo '## ⚠️ database.sql has schema changes but v_database was not bumped'
            echo
            echo 'This PR modifies `sql/database.sql` with schema-affecting changes'
            echo "(CREATE TABLE, ALTER TABLE, etc.) but \`\$v_database\` was not incremented."
            echo
            echo '### Why this matters'
            echo
            echo 'Existing installations rely on `$v_database` to determine which upgrade'
            echo 'scripts to run. Without a version bump, the upgrade system will not know'
            echo 'that new migration steps are needed.'
            echo
            echo '### How to fix'
            echo
            printf 'Increment `$v_database` from **%s** to **%s** in both:\n' "$base_v_database" "$((base_v_database + 1))"
            echo
            echo '- `version.php`'
            echo '- `sql/database.sql` header comment'
            echo
            echo 'And add the corresponding upgrade SQL to the appropriate'
            echo '`sql/*-to-*_upgrade.sql` file.'
            echo
            echo '_If this change is intentionally a fresh-install-only fix (e.g., correcting_'
            echo '_defaults that were already handled in a prior upgrade), you can ignore this warning._'
          } >> "$GITHUB_STEP_SUMMARY"
          exit 1
        fi

        # v_database was bumped — check for upgrade SQL
        upgrade_files=$(git diff --name-only "$base_ref"...HEAD | grep -E '^sql/.*-to-.*_upgrade\.sql$' || true)
        patch_file=$(git diff --name-only "$base_ref"...HEAD | grep -E '^sql/patch\.sql$' || true)

        if [[ -z "$upgrade_files" && -z "$patch_file" ]]; then
          {
            echo '## ⚠️ v_database bumped but no upgrade SQL found'
            echo
            printf 'This PR bumps `$v_database` from **%s** to **%s** and modifies\n' "$base_v_database" "$head_v_database"
            echo '`sql/database.sql` with schema changes, but no upgrade SQL file was modified.'
            echo
            echo '### How to fix'
            echo
            echo 'Add the corresponding migration statements to the appropriate upgrade file:'
            echo
            echo '```'
            echo 'sql/8_0_0-to-8_0_1_upgrade.sql  (or the current version range)'
            echo '```'
            echo
            echo 'Use the `#IfMissingColumn`, `#IfNotTable`, or similar conditional'
            echo 'constructs to make the migration idempotent.'
          } >> "$GITHUB_STEP_SUMMARY"
          exit 1
        fi

        {
          echo '## ✅ Upgrade SQL is present'
          echo
          printf 'v_database bumped from %s → %s with upgrade SQL in:\n' "$base_v_database" "$head_v_database"
          echo
          for f in $upgrade_files $patch_file; do
            echo "- \`$f\`"
          done
        } >> "$GITHUB_STEP_SUMMARY"
