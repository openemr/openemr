# ============================================================================
# OpenEMR Apache Configuration File
# ============================================================================
# This file configures Apache HTTP Server for OpenEMR in a Docker container.
# It provides security hardening, SSL/TLS support, and FastCGI integration.
#
# Key Features:
#   - Security headers and protocol restrictions
#   - SSL/TLS configuration with modern cipher suites
#   - FastCGI integration
#   - Directory access controls
#   - Logging configuration for Docker
#
# This file is included by the main Apache configuration and applies to
# the OpenEMR application running in the container.
# ============================================================================

# ============================================================================
# REQUIRED MODULES
# ============================================================================
# Load modules required for OpenEMR functionality

# mod_rewrite: Required for URL rewriting and .htaccess support
LoadModule rewrite_module modules/mod_rewrite.so

# mod_allowmethods: Required for HTTP method restrictions (security)
LoadModule allowmethods_module modules/mod_allowmethods.so

# ============================================================================
# HTTP REQUEST LIMITS
# ============================================================================
# Increase maximum HTTP header field size to support large API client scopes
# Default is 8192 bytes, but OpenEMR API may send larger headers with many scopes
LimitRequestFieldSize 32768

# ============================================================================
# SECURITY CONFIGURATION
# ============================================================================

# HTTP Protocol Options
# Strict mode prevents HTTP/0.9 and HTTP/1.0 requests, improving security
HTTPProtocolOptions Strict

# Supported Protocols
# Only allow HTTP/1.1 (HTTP/2 would require mod_http2, not included)
Protocols http/1.1

# Server Information Disclosure Prevention
# Hide Apache version and server signature to reduce attack surface
ServerSignature off
ServerTokens Prod
Header unset Server

# ETag Removal
# Disable ETags to prevent information leakage about file system structure
FileETag None
Header unset ETag

# XSS Protection Header
# Enable browser's built-in XSS protection
Header set X-XSS-Protection "1; mode=block"

# ============================================================================
# DOCUMENT ROOT
# ============================================================================
# Set the document root to the OpenEMR installation directory
DocumentRoot /var/www/localhost/htdocs/openemr

# ============================================================================
# LOGGING CONFIGURATION
# ============================================================================
# Configure logging to work with Docker container logs
# rotatelogs is used to rotate log files daily while sending output to stdout/stderr
# This allows Docker to capture logs while maintaining file-based logging

# Error Log: Rotate daily, keep 5 files, send to stderr for Docker
ErrorLog "|/usr/sbin/rotatelogs -e -n 5 ${APACHE_LOG_DIR}/error.log 86400 >&2"

# Access Log: Rotate daily, keep 5 files, use combined log format
CustomLog "|/usr/sbin/rotatelogs -e -n 5 ${APACHE_LOG_DIR}/access.log 86400" combined

# ============================================================================
# DIRECTORY ACCESS CONTROLS
# ============================================================================
# These are the overrides if a virtual host does not exist.

# Main OpenEMR Directory
# These settings apply to the OpenEMR installation root
<Directory /var/www/localhost/htdocs/openemr>
    # HTTP Methods: Only allow safe and necessary HTTP methods
    # GET, POST, PUT, PATCH, DELETE: Standard REST API methods
    # HEAD, OPTIONS: Required for HTTP protocol compliance
    AllowMethods GET POST PUT PATCH DELETE HEAD OPTIONS

    # Directory Listing: Disable directory indexes for security
    # Prevents users from browsing directory contents
    Options -Indexes

    # .htaccess Override: Allow FileInfo overrides (for URL rewriting)
    # This allows OpenEMR to use .htaccess files for URL rewriting
    AllowOverride FileInfo

    # Access Control: Grant access to all (authentication handled by OpenEMR)
    Require all granted

    # Client Certificate Authentication (commented out by default)
    # Uncomment these lines to enable client certificate authentication (mTLS)
    # This requires proper CA certificate configuration via ssl.sh script
    #SSLVerifyClient require
    #SSLVerifyDepth 2
    #SSLOptions +StdEnvVars
</Directory>

# Sites Directory
# Prevent .htaccess overrides in the sites directory for security
# This directory contains site-specific configurations that shouldn't be modifiable via .htaccess
<Directory "/var/www/localhost/htdocs/openemr/sites">
    AllowOverride None
</Directory>

# Documents Directory
# Deny direct HTTP access to documents directory
# Documents should only be accessed through OpenEMR's authentication system
# This prevents direct file access without proper authorization
<Directory "/var/www/localhost/htdocs/openemr/sites/*/documents">
    Require all denied
</Directory>

# ============================================================================
# HTTP VIRTUAL HOST (Port 80)
# ============================================================================
# Configure HTTP virtual host for non-SSL connections
# By default, HTTP is allowed. To force HTTPS redirect, uncomment the RewriteRule lines below.
#
# Note: When HTTPS redirect is enabled, this requires SSL to be properly configured below

<VirtualHost *:80>
    # HTTPS Redirect Configuration (commented out by default)
    # Uncomment the following 3 lines to enable automatic HTTPS redirection
    # This will redirect all HTTP requests to HTTPS
    #
    # RewriteEngine On
    # RewriteCond %{HTTPS} off
    # RewriteRule (.*) https://%{HTTP_HOST}/$1 [R,L]
    #
    # Note: When enabled, this requires SSL to be properly configured below
</VirtualHost>

# ============================================================================
# HTTPS VIRTUAL HOST (Port 443)
# ============================================================================
# Configure SSL/TLS virtual host for secure connections
# This virtual host handles all HTTPS traffic

<VirtualHost _default_:443>
    # SSL Engine
    # Enable SSL/TLS encryption for this virtual host
    SSLEngine on

    # SSL Protocol Configuration
    # Only allow TLS 1.2 and TLS 1.3 (disable older, insecure protocols)
    # - SSLv3: Disabled (vulnerable to POODLE attack)
    # - TLSv1.0: Disabled (deprecated, vulnerable)
    # - TLSv1.1: Disabled (deprecated, vulnerable)
    # - TLSv1.2: Enabled (widely supported, secure)
    # - TLSv1.3: Enabled (modern, most secure)
    #
    # Configuration based on Mozilla SSL Configuration Generator (Intermediate profile):
    # https://ssl-config.mozilla.org/#server=apache&version=2.4.60&config=intermediate&openssl=3.4.0&guideline=5.7
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1

    # SSL Cipher Suite Configuration
    # Only allow strong, modern cipher suites that provide forward secrecy
    # Cipher suites are ordered by preference (server preference when SSLHonorCipherOrder is off)
    # ECDHE: Elliptic Curve Diffie-Hellman Ephemeral (forward secrecy)
    # AES-GCM: Advanced Encryption Standard with Galois/Counter Mode (authenticated encryption)
    # CHACHA20-POLY1305: ChaCha20 stream cipher with Poly1305 MAC (modern alternative)
    # DHE: Diffie-Hellman Ephemeral (fallback for forward secrecy)
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384

    # Cipher Order Preference
    # When off, client preference is used (better compatibility)
    # When on, server preference is used (better security, but may break some clients)
    SSLHonorCipherOrder off

    # SSL Session Tickets
    # Disable session tickets to prevent session hijacking attacks
    # Session tickets can be intercepted and reused by attackers
    SSLSessionTickets off

    # SSL Certificate Files
    # Certificate and key files are managed by ssl.sh script
    # - Self-signed certificate: Used by default (development/testing)
    # - Let's Encrypt certificate: Used when DOMAIN environment variable is set (production)
    # Files are symlinked to webserver.cert.pem and webserver.key.pem
    SSLCertificateFile    /etc/ssl/certs/webserver.cert.pem
    SSLCertificateKeyFile /etc/ssl/private/webserver.key.pem

    # Client Certificate Authentication (commented out by default)
    # Uncomment to enable client certificate authentication (mTLS)
    # This requires proper CA certificate configuration via ssl.sh script
    #SSLCACertificateFile /etc/ssl/certs/CAcustomclientbasedwebserver.cert.pem

    # HTTP Strict Transport Security (HSTS)
    # HSTS is set here (HTTPS only) so it is NOT sent on HTTP (port 80/8300) responses.
    # Sending HSTS over HTTP caused browsers to store a localhost HSTS policy, which
    # then caused the browser to upgrade HTTP sub-resource requests (CSS/JS) to HTTPS
    # on port 8300 — a port that has no HTTPS listener — resulting in assets failing
    # to load and the UI appearing completely unstyled.
    # RFC 6797 §7.2 says HSTS over HTTP SHOULD be ignored, but browsers vary, and
    # visiting https://localhost:9300 stores the policy which applies across ports.
    Header set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
</VirtualHost>

# ============================================================================
# FASTCGI CONFIGURATION
# ============================================================================
# Configure Apache to proxy PHP requests to FastCGI
# This provides better performance and resource isolation compared to mod_php
#
# Note: .htaccess files are still fully supported and processed by Apache
# before requests are proxied to FastCGI. The AllowOverride FileInfo directive
# above enables .htaccess URL rewriting rules to work correctly.

<FilesMatch \.php$>
    # Proxy PHP requests to FastCGI server
    # 127.0.0.1:9000 is the default listen address
    SetHandler "proxy:fcgi://127.0.0.1:9000"
</FilesMatch>
