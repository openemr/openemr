{#
  Telecom Form Template
  Handles editing, creating, and deleting telecom records
#}

<style>
    div.table_edit_telecoms div.label_custom, div.form_telecoms div.label_custom {
        text-align: left !important;
    }
    .telecom-inactive {
        opacity: 0.6;
        background-color: #f8f9fa;
    }
</style>

<div id="{{ table_id|attr }}" class="row mt-3">
    <div class="table_edit_telecoms col-12">
        <div class="display_telecoms_header pl-1" style="display: flex; justify-content: space-between; align-items: center; line-height: 1.5; padding-top: 0.1rem; background-color: var(--gray300)">
            <div style="display: flex; align-items: center;">
                <div class="label_custom mb-0">
                    {% if foreign_table == 'patient_data' %}
                        {{ 'Additional Telecom Contacts'|xlt }}
                    {% else %}
                        {{ 'Telecom Contacts'|xlt }}
                    {% endif %}
                </div>
                <div id="btn_add_telecom_{{ table_id|attr }}" class="fas fa-plus-square text-primary pl-3" style="display: inline-block; line-height: 1.5; cursor: pointer;"></div>
            </div>
            <div class="form-check mr-3" style="margin-bottom: 0;">
                <input type="checkbox" class="form-check-input" id="show_inactive_telecoms_{{ table_id|attr }}">
                <label class="form-check-label" for="show_inactive_telecoms_{{ table_id|attr }}" style="font-size: 0.9em;">
                    {{ 'Show Inactive'|xlt }}
                </label>
            </div>
        </div>

        {% if telecoms|length == 0 %}
        <div class="no_telecoms">
            <span class="label_custom pl-1" style="line-height: 2.0;">{{ 'NONE'|xlt }}</span>
            <hr class="m-0 p-0" style="border-top-width: 2px; border-color: var(--gray300)" />
        </div>
        {% endif %}

        {# Render existing telecoms #}
        {% for telecom in telecoms %}
        {% set is_inactive = telecom.status != 'A' %}
        {% set telecom_index = loop.index0 %}
        <div class="telecoms_group col-12 pl-0 {{ is_inactive ? 'telecom-inactive d-none' : '' }}" data-status="{{ telecom.status|attr }}" data-index="{{ telecom_index }}">

            {# Hidden fields - always submitted #}
            <input type="hidden" class="form_telecoms_data_action"
                name="{{ name_field_id|attr }}[{{ telecom_index }}][data_action]" value="NO CHANGE" />
            <input type="hidden" class="form_telecoms_contact_telecom_id"
                name="{{ name_field_id|attr }}[{{ telecom_index }}][contact_telecom_id]" value="{{ telecom.id|attr }}" />
            <input type="hidden" class="form_telecoms_contact_id"
                name="{{ name_field_id|attr }}[{{ telecom_index }}][contact_id]" value="{{ telecom.contact_id|attr }}" />
            <input type="hidden" class="form_telecoms_status"
                name="{{ name_field_id|attr }}[{{ telecom_index }}][status]" value="{{ telecom.status|attr }}" />

            <div class="display_telecoms form-row no-gutters justify-content-between pl-1">
                <div class="display_telecoms_system_column px-1" style="flex: 0 0 9em;">
                    <i class="fas fa-solid fa-caret-right fa-lg text-primary btn-edit-telecom" style="width:10px; line-height: 1.2; cursor: pointer;"></i>
                    <i class="fas fa-{{ telecom.system == 'phone' or telecom.system == 'mobile' ? 'phone' : (telecom.system == 'email' ? 'envelope' : (telecom.system == 'fax' ? 'fax' : 'link')) }} mr-1"></i>
                    <span class="display_telecoms_system label_custom px-0" style="vertical-align: 0.1rem;">
                        {{ list_telecom_systems[telecom.system]|text }}
                        {% if is_inactive %}
                            <span class="badge badge-secondary ml-1" style="font-size: 0.7em;">{{ 'Inactive'|xlt }}</span>
                        {% endif %}
                    </span>
                </div>

                <div class="col-6 px-0">
                    <span class="display_telecoms_value label_custom" style="vertical-align: 0.1rem;">
                        {{ telecom.value|text }}
                    </span>
                </div>

                <div class="col-2 display_telecoms_use_column px-0">
                    <span class="display_telecoms_use label_custom" style="vertical-align: 0.1rem;">
                        {{ list_telecom_uses[telecom.use]|text }}
                    </span>
                </div>

                {% if is_inactive %}
                    <div class="fas fa-fw fa-solid fa-phone-circle-check text-success btn-activate-telecom text-center" role="button" style="flex: 0 0 2em; line-height: 1.5; cursor: pointer; font-size: 0.7em; margin-top: 0.3em;"></div>
                {% else %}
                    <div class="fas fa-fw fa-solid fa-phone-slash text-danger btn-inactivate-telecom text-center" role="button" style="flex: 0 0 2em; line-height: 1.5; cursor: pointer; font-size: 0.7em; margin-top: 0.3em;"></div>
                {% endif %}
            </div>

            <div class='d-none form_telecoms form-row mx-3 my-2'>
                {% include 'patient/demographics/telecom_form_fields.html.twig' with {
                    'telecom': telecom,
                    'field_id_esc': field_id_esc,
                    'name_field_id': 'form_' ~ field_id_esc,
                    'telecom_index': telecom_index,
                    'is_new': false
                } %}
            </div>
            <hr class="m-0 p-0" style="border-top-width: 2px; border-color: var(--gray300)" />
        </div>
        {% endfor %}
    </div>
</div>

{# Template for adding new telecoms #}
<template class="template_add_telecom">
    <div class="telecoms_group col-12 pl-0" data-status="A" data-index="__INDEX__">

        {# Hidden fields #}
        <input type="hidden" class="form_telecoms_data_action"
            name="{{ name_field_id|attr }}[__INDEX__][data_action]" value="ADD" />
        <input type="hidden" class="form_telecoms_id"
            name="{{ name_field_id|attr }}[__INDEX__][id]" value="" />
        <input type="hidden" class="form_telecoms_contact_id"
            name="{{ name_field_id|attr }}[__INDEX__][contact_id]" value="{{ contact_id|attr }}" />
        <input type="hidden" class="form_telecoms_status"
            name="{{ name_field_id|attr }}[__INDEX__][status]" value="A" />

        <div class="display_telecoms form-row no-gutters justify-content-between pl-1">
            <div class="display_telecoms_system_column px-1" style="flex: 0 0 9em;">
                <i class="fas fa-solid fa-caret-down fa-lg text-primary btn-edit-telecom" style="width:10px; line-height: 1.2; cursor: pointer;"></i>
                <i class="fas fa-phone mr-1"></i>
                <span class="display_telecoms_system label_custom px-0" style="vertical-align: 0.1rem;"></span>
            </div>

            <div class="col-6 px-0">
                <span class="display_telecoms_value label_custom" style="vertical-align: 0.1rem;"></span>
            </div>

            <div class="col-2 display_telecoms_use_column px-0">
                <span class="display_telecoms_use label_custom" style="vertical-align: 0.1rem;"></span>
            </div>

            <div class="fas fa-fw fa-solid fa-phone-slash text-danger btn-inactivate-telecom text-center" role="button" style="flex: 0 0 2em; line-height: 1.5; cursor: pointer; font-size: 0.7em; margin-top: 0.3em;"></div>
        </div>

        <div class='form_telecoms form-row mx-3 my-2'>
            {% include 'patient/demographics/telecom_form_fields.html.twig' with {
                'telecom': {
                    'system': 'phone',
                    'use': 'home',
                    'rank': 1,
                    'period_start': 'now'|date('Y-m-d'),
                },
                'field_id_esc': field_id_esc,
                'name_field_id': 'form_' ~ field_id_esc,
                'telecom_index': '__INDEX__',
                'is_new': true,
                'widget_constants': widget_constants
            } %}
        </div>
        <hr class="m-0 p-0" style="border-top-width: 2px; border-color: var(--gray300)" />
    </div>
</template>

<script type="text/javascript">
    (function() {
        let TELECOM_ACTION_VALUES = {
            'INACTIVATE': 'INACTIVATE',
            'ADD': 'ADD',
            'UPDATE': 'UPDATE'
        };

        let telecomDatePickerSettings = {};

        {{ DateToYYYYMMDD_js()|raw }}

        // IE Compatibility Polyfills - Run immediately
        (function() {
            if (!Element.prototype.matches) {
                Element.prototype.matches = Element.prototype.msMatchesSelector || Element.prototype.webkitMatchesSelector;
            }

            if (!Element.prototype.closest) {
                Element.prototype.closest = function (s) {
                    var el = this;
                    do {
                        if (Element.prototype.matches.call(el, s)) return el;
                        el = el.parentElement || el.parentNode;
                    } while (el !== null && el.nodeType === 1);
                    return null;
                };
            }
        })();

        let telecomTableConfig = {
            tableId: {{ table_id|js_escape|raw }},
            listTelecomSystems: {{ list_telecom_systems|json_encode|raw }},
            listTelecomUses: {{ list_telecom_uses|js_escape|raw }}
        };

        (function () {
            initTelecoms(telecomTableConfig.tableId);
            
            // Also set up a global event listener for dynamically added telecom forms
            // This handles cases where telecom forms are nested in collapsed/hidden sections
            if (!window.telecomGlobalListenerSet) {
                window.telecomGlobalListenerSet = true;
                
                // Use event delegation on document for add telecom buttons
                document.addEventListener('click', function(event) {
                    // Check if the clicked element or any of its parents is an add telecom button
                    let addBtn = null;
                    let element = event.target;
                    
                    // Safety check - make sure element exists and is a DOM element
                    if (!element || !element.nodeType) {
                        console.error('Invalid event.target:', element);
                        return;
                    }
                    
                    // Walk up the DOM tree to find the button (max 5 levels)
                    let maxLevels = 5;
                    let currentLevel = 0;
                    
                    while (element && element !== document && currentLevel < maxLevels) {
                        if (element.id && typeof element.id === 'string' && element.id.indexOf('btn_add_telecom_') === 0) {
                            addBtn = element;
                            break;
                        }
                        element = element.parentElement || element.parentNode;
                        currentLevel++;
                    }
                    
                    if (addBtn) {
                        console.log('Global click handler triggered for:', addBtn.id);
                        
                        // Check if this specific table has been initialized
                        let tableId = addBtn.id.replace('btn_add_telecom_', '');
                        let tableElement = document.getElementById(tableId);
                        
                        if (tableElement && !tableElement.dataset.telecomInitialized) {
                            console.log('Initializing telecom table on-demand:', tableId);
                            initTelecoms(tableId);
                        }
                        
                        // Create a new event object with currentTarget set to the button
                        let buttonEvent = {
                            currentTarget: addBtn,
                            target: addBtn,
                            preventDefault: function() {
                                if (event.preventDefault) event.preventDefault();
                            },
                            stopPropagation: function() {
                                if (event.stopPropagation) event.stopPropagation();
                            }
                        };
                        
                        addTelecom(buttonEvent);
                        
                        if (event.preventDefault) event.preventDefault();
                        if (event.stopPropagation) event.stopPropagation();
                        return false;
                    }
                });
            }
        })();

        function initTelecoms(tableId) {
            var tableElement = document.getElementById(tableId);
            if (!tableElement) {
                console.error('Telecom table element not found:', tableId);
                return;
            }
            
            // Mark as initialized
            tableElement.dataset.telecomInitialized = 'true';
            console.log('Initializing telecom table:', tableId);

            // Event listeners for form changes
            tableElement.addEventListener('keyup', changeTelecomEdit);
            tableElement.addEventListener('mouseup', changeTelecomEdit);
            tableElement.addEventListener('touchend', changeTelecomEdit);

            tableElement.addEventListener('input', telecomUpdated);
            tableElement.addEventListener('change', telecomUpdated);

            // Setup existing telecom buttons
            tableElement.querySelectorAll('.telecoms_group .display_telecoms').forEach(function (row) {
                setupTelecomsRowButtonEventListeners(row);
            });

            tableElement.querySelectorAll('.form_telecoms').forEach(function (row) {
                setupContainerDatePickers(row);
                setupContainerListAddButtons(row);
            });

            // Setup show inactive checkbox
            var showInactiveCheckbox = document.getElementById("show_inactive_telecoms_" + tableId);
            if (showInactiveCheckbox) {
                // Remove any existing listeners
                var newCheckbox = showInactiveCheckbox.cloneNode(true);
                showInactiveCheckbox.parentNode.replaceChild(newCheckbox, showInactiveCheckbox);
                
                newCheckbox.addEventListener('change', function() {
                    toggleInactiveTelecoms(tableId);
                });
            }

            // Setup add button - use event delegation instead of direct attachment
            var addButton = document.getElementById("btn_add_telecom_" + tableId);
            if (addButton) {
                console.log('Found add button:', addButton.id);
                // Remove any existing listeners
                var newButton = addButton.cloneNode(true);
                addButton.parentNode.replaceChild(newButton, addButton);
                
                newButton.addEventListener('click', function(event) {
                    console.log('Add telecom button clicked:', tableId);
                    addTelecom(event);
                    event.preventDefault();
                    return false;
                });
            } else {
                console.warn('Add telecom button not found for table:', tableId);
            }
        }

        function toggleInactiveTelecoms(tableId) {
            const checkbox = document.getElementById('show_inactive_telecoms_' + tableId);
            const inactiveTelecoms = document.querySelectorAll('#' + tableId + ' .telecom-inactive');

            inactiveTelecoms.forEach(function (telecom) {
                if (checkbox.checked) {
                    telecom.classList.remove('d-none');
                } else {
                    telecom.classList.add('d-none');
                }
            });
        }

        function addTelecom(event) {
            console.log('addTelecom called', event);
            
            // Get the button element - should be provided by global handler or direct listener
            let target = event.currentTarget || event.target;
            
            if (!target) {
                console.error('No target element in event:', event);
                alert('Error: Could not determine which button was clicked.');
                return;
            }
            
            console.log('Event target:', target, 'ID:', target.id);
            
            // Find the table container - button is INSIDE .table_edit_telecoms
            // So we need to check if target itself or any PARENT has this class
            let container = null;
            let element = target;
            let maxLevels = 15; // Increased for deeply nested structures
            let currentLevel = 0;
            
            console.log('Walking up DOM to find .table_edit_telecoms...');
            
            // Walk up to find .table_edit_telecoms
            while (element && element !== document && currentLevel < maxLevels) {
                console.log('  Level', currentLevel, ':', 
                           element.tagName, 
                           'class:', element.className,
                           'id:', element.id || '(none)');
                
                if (element.classList && element.classList.contains('table_edit_telecoms')) {
                    container = element;
                    console.log('  âœ“ Found container at level', currentLevel);
                    break;
                }
                element = element.parentElement || element.parentNode;
                currentLevel++;
            }
            
            if (!container) {
                console.error('âŒ Could not find .table_edit_telecoms container from target:', target);
                console.error('Walked up', currentLevel, 'levels');
                console.error('Last element checked:', element);
                
                // Try alternative: find by table ID pattern
                // The button ID is btn_add_telecom_TABLEID, so extract TABLEID
                console.log('Trying fallback: lookup by table ID...');
                if (target.id && target.id.indexOf('btn_add_telecom_') === 0) {
                    let tableId = target.id.replace('btn_add_telecom_', '');
                    console.log('  Extracted table ID:', tableId);
                    
                    let tableElement = document.getElementById(tableId);
                    console.log('  Table element:', tableElement);
                    
                    if (tableElement) {
                        container = tableElement.querySelector('.table_edit_telecoms');
                        if (container) {
                            console.log('  âœ“ Found container via table ID lookup (fallback)');
                        } else {
                            console.error('  âŒ Table element found but no .table_edit_telecoms inside it');
                        }
                    } else {
                        console.error('  âŒ Could not find table element with ID:', tableId);
                    }
                }
                
                if (!container) {
                    alert('Error: Could not find telecom container. Check console for details.');
                    return;
                }
            }
            
            console.log('âœ“ Container found:', container);

            // Find the table root (element with an ID) - walk up from container
            let tableRoot = null;
            element = container;
            currentLevel = 0;
            maxLevels = 10;
            
            while (element && element !== document && currentLevel < maxLevels) {
                if (element.id) {
                    tableRoot = element;
                    break;
                }
                element = element.parentElement || element.parentNode;
                currentLevel++;
            }
            
            console.log('Table root:', tableRoot, 'ID:', tableRoot ? tableRoot.id : 'none');
            
            let row_telecom_template = null;
            
            if (tableRoot) {
                console.log('Strategy 1: Looking for immediate next sibling...');
                // Strategy 1: Look for template as immediate next sibling
                let nextSibling = tableRoot.nextElementSibling;
                while (nextSibling) {
                    console.log('  Checking sibling:', nextSibling.tagName, nextSibling.className);
                    if (nextSibling.tagName === 'TEMPLATE' && nextSibling.classList.contains('template_add_telecom')) {
                        row_telecom_template = nextSibling;
                        console.log('  âœ“ Found template as immediate sibling');
                        break;
                    }
                    nextSibling = nextSibling.nextElementSibling;
                }
                
                // Strategy 2: Look within the same parent container (for nested cases)
                if (!row_telecom_template && tableRoot.parentElement) {
                    console.log('Strategy 2: Looking within parent container...');
                    let templatesInParent = tableRoot.parentElement.querySelectorAll('template.template_add_telecom');
                    console.log('  Found', templatesInParent.length, 'templates in parent');
                    
                    // Find the closest template after our table
                    templatesInParent.forEach(function(template) {
                        if (!row_telecom_template) {
                            // Check if this template comes after our tableRoot
                            let current = tableRoot;
                            while (current) {
                                if (current === template) {
                                    row_telecom_template = template;
                                    console.log('  âœ“ Found template in parent');
                                    break;
                                }
                                current = current.nextElementSibling;
                            }
                        }
                    });
                }
                
                // Strategy 3: Search within broader context (for deeply nested cases like relation forms)
                if (!row_telecom_template) {
                    console.log('Strategy 3: Looking in broader context...');
                    // Look for any template_add_telecom in the broader container that contains our table
                    let broadContainer = tableRoot.closest('.form_relations, .relations_group, body');
                    console.log('  Broad container:', broadContainer ? broadContainer.className : 'none');
                    
                    if (broadContainer) {
                        let allTemplates = broadContainer.querySelectorAll('template.template_add_telecom');
                        console.log('  Found', allTemplates.length, 'templates in broad container');
                        
                        // Try a simpler approach: find the closest template that's within our relation
                        allTemplates.forEach(function(template, idx) {
                            console.log('    Template', idx, ':', template);
                            if (!row_telecom_template) {
                                // Check if tableRoot and template share a common ancestor within reasonable distance
                                let tableParent = tableRoot.parentElement;
                                let templateParent = template.parentElement;
                                
                                // Walk up from template to see if we find tableRoot or its parent
                                let current = template;
                                let depth = 0;
                                while (current && depth < 10) {
                                    if (current.contains(tableRoot)) {
                                        row_telecom_template = template;
                                        console.log('    âœ“ Found template containing our table at depth', depth);
                                        break;
                                    }
                                    current = current.parentElement;
                                    depth++;
                                }
                            }
                        });
                    }
                }
                
                // Strategy 4: Just use ANY template in the relation if we're in one
                if (!row_telecom_template) {
                    console.log('Strategy 4: Fallback - looking for any nearby template...');
                    let relationGroup = tableRoot.closest('.relations_group');
                    if (relationGroup) {
                        let templateInRelation = relationGroup.querySelector('template.template_add_telecom');
                        if (templateInRelation) {
                            row_telecom_template = templateInRelation;
                            console.log('  âœ“ Found template in relation group (fallback)');
                        }
                    }
                }
            }
            
            if (!row_telecom_template) {
                console.error('âŒ Could not find template for this telecom table');
                console.error('  TableRoot:', tableRoot);
                console.error('  TableRoot ID:', tableRoot ? tableRoot.id : 'no ID');
                console.error('  Container:', container);
                console.error('  Parent:', tableRoot ? tableRoot.parentElement : 'no parent');
                
                // List all templates on the page for debugging
                let allTemplates = document.querySelectorAll('template.template_add_telecom');
                console.error('  All templates on page:', allTemplates.length);
                allTemplates.forEach((t, i) => {
                    console.error('    Template', i, ':', t, 'Parent:', t.parentElement);
                });
                
                alert('Error: Could not find telecom template. Check console for details.');
                return;
            }
            
            console.log('âœ“ Using template:', row_telecom_template);

            // Find no_telecoms element within this specific container
            let noTelecomsElement = container.querySelector(".no_telecoms");  // ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ Scoped to container

            if (noTelecomsElement && !noTelecomsElement.classList.contains('d-none')) {
                hideElement(noTelecomsElement);
            }

            // Find the highest existing index
            var allGroups = container.querySelectorAll('.telecoms_group[data-index]');
            var maxIndex = -1;
            allGroups.forEach(function(group) {
                var idx = parseInt(group.getAttribute('data-index'));
                if (!isNaN(idx) && idx > maxIndex) {
                    maxIndex = idx;
                }
            });
            var newIndex = maxIndex + 1;

            // Clone and replace __INDEX__ with actual index
            var tempDiv = document.createElement('div');
            tempDiv.innerHTML = row_telecom_template.innerHTML;
            var html = tempDiv.innerHTML;
            
            // First, check if we're inside a relation form (nested scenario)
            // In this case, we need to find the relation's index and use it for the field names
            var relationGroup = container.closest('.relations_group');
            var relationIndex = null;
            
            if (relationGroup) {
                relationIndex = relationGroup.getAttribute('data-index');
                console.log('Found parent relation with index:', relationIndex);
            }
            
            // Replace __INDEX__ with actual index
            html = html.replace(/__INDEX__/g, newIndex);
            
            // If we're in a nested relation form, we need to fix the field naming
            // The template might have form_related_persons[telecoms][__INDEX__] 
            // but it should be form_related_persons[RELATION_INDEX][telecoms][TELECOM_INDEX]
            if (relationIndex !== null) {
                console.log('Fixing nested field names for relation index:', relationIndex);
                
                // Fix the pattern: [telecoms][NUMBER] should become [RELATION_INDEX][telecoms][NUMBER]
                // This handles cases where the relation template was already processed
                var namePattern = /name="([^"]*)\[telecoms\]\[(\d+)\]/g;
                html = html.replace(namePattern, function(match, prefix, telecomIdx) {
                    // Check if it already has the relation index
                    if (prefix.match(/\[\d+\]$/)) {
                        // Already has index, just return as-is
                        return match;
                    }
                    // Add the relation index
                    return 'name="' + prefix + '[' + relationIndex + '][telecoms][' + telecomIdx + ']';
                });
            }
            
            tempDiv.innerHTML = html;
            var row_telecom_clone = tempDiv.firstElementChild;

            let row_form_telecoms = row_telecom_clone.querySelector(".form_telecoms");
            let row_display_telecoms = row_telecom_clone.querySelector(".display_telecoms");

            container.appendChild(row_telecom_clone);

            setupTelecomsRowButtonEventListeners(row_display_telecoms);
            setupContainerDatePickers(row_form_telecoms);
            setupContainerListAddButtons(row_form_telecoms);

            showElement(row_form_telecoms);
            let firstInput = row_form_telecoms.querySelector('input.form_telecoms_value');
            if (firstInput) {
                firstInput.focus();
            }

            console.log('Added new telecom with index:', newIndex);
        }

        function changeTelecomEdit(event) {
            var row_form_telecoms = event.target.closest('.form_telecoms');
            if (!row_form_telecoms) {
                return;
            }

            var telecoms_group = row_form_telecoms.closest('.telecoms_group');
            if (!telecoms_group) {
                return;
            }
            var row_display_telecoms = telecoms_group.querySelector('.display_telecoms');
            if (!row_display_telecoms) {
                return;
            }

            let record = createTelecomRecordFromInput(row_form_telecoms);
            let systemDisplay = getSelectDisplay(row_form_telecoms, "select.form_telecoms_system");
            let useDisplay = getSelectDisplay(row_form_telecoms, "select.form_telecoms_use");

            row_display_telecoms.querySelector(".display_telecoms_system").innerText = systemDisplay;
            row_display_telecoms.querySelector(".display_telecoms_value").innerText = record.value;
            row_display_telecoms.querySelector(".display_telecoms_use").innerText = useDisplay;

            // Update icon based on system
            let iconContainer = row_display_telecoms.querySelector(".display_telecoms_system_column");
            let icon = iconContainer.querySelector("i.fa-phone, i.fa-envelope, i.fa-fax, i.fa-link");
            if (icon) {
                let newIconClass = 'fas mr-1 fa-' + getTelecomIcon(record.system);
                icon.className = newIconClass;
            }
        }

        function getTelecomIcon(system) {
            switch (system) {
                case 'phone':
                case 'mobile':
                    return 'phone';
                case 'email':
                    return 'envelope';
                case 'fax':
                    return 'fax';
                case 'url':
                    return 'link';
                default:
                    return 'phone';
            }
        }

        function editTelecom(event) {
            event.preventDefault();
            let element = event.currentTarget;
            let toggleElement = element.closest('.telecoms_group').querySelector('.form_telecoms');

            if (element.className.includes("fa-caret-right")) {
                toggleElement.classList.remove('d-none');
                element.className = "fas fa-solid fa-caret-down fa-lg text-primary btn-edit-telecom";
            } else {
                toggleElement.classList.add('d-none');
                element.className = "fas fa-solid fa-caret-right fa-lg text-primary btn-edit-telecom";
            }
        }

        function changeTelecomStatus(event) {
            event.preventDefault();
            var row_display_telecoms = event.currentTarget.closest('.display_telecoms');
            if (!row_display_telecoms) {
                return;
            }

            var telecoms_group = row_display_telecoms.closest('.telecoms_group');
            var currentStatus = telecoms_group.getAttribute('data-status');
            var inactivateIcon = event.currentTarget;

            var statusInput = telecoms_group.querySelector('input.form_telecoms_status');
            var actionInput = telecoms_group.querySelector('input.form_telecoms_data_action');

            if (currentStatus === 'I') {
                // REACTIVATE
                let prompt = window.xl("Reactivate this contact information?");
                if (confirm(prompt)) {
                    telecoms_group.classList.remove('telecom-inactive');
                    telecoms_group.setAttribute('data-status', 'A');

                    var systemSpan = row_display_telecoms.querySelector('.display_telecoms_system');
                    var badge = systemSpan.querySelector('.badge');
                    if (badge) {
                        badge.remove();
                    }

                    inactivateIcon.classList.remove('fa-phone-circle-check', 'text-success');
                    inactivateIcon.classList.add('fa-phone-slash', 'text-danger');
                    inactivateIcon.setAttribute('title', window.xl('Inactivate Contact'));

                    if (actionInput) {
                        actionInput.value = TELECOM_ACTION_VALUES.UPDATE;
                    }
                    if (statusInput) {
                        statusInput.value = 'A';
                    }

                    console.log('Reactivated telecom:', telecoms_group.querySelector('input.form_telecoms_contact_telecom_id')?.value);
                }
            } else {
                // INACTIVATE
                let prompt = window.xl("Are you sure you wish to inactivate this contact information?");
                if (confirm(prompt)) {
                    telecoms_group.classList.add('telecom-inactive');
                    telecoms_group.setAttribute('data-status', 'I');

                    var systemSpan = row_display_telecoms.querySelector('.display_telecoms_system');
                    if (!systemSpan.querySelector('.badge')) {
                        var badge = document.createElement('span');
                        badge.className = 'badge badge-secondary ml-1';
                        badge.style.fontSize = '0.7em';
                        badge.textContent = window.xl('Inactive');
                        systemSpan.appendChild(badge);
                    }

                    inactivateIcon.classList.remove('fa-phone-slash', 'text-danger');
                    inactivateIcon.classList.add('fa-phone-circle-check', 'text-success');
                    inactivateIcon.setAttribute('title', window.xl('Reactivate Contact'));

                    if (actionInput) {
                        actionInput.value = TELECOM_ACTION_VALUES.INACTIVATE;
                    }
                    if (statusInput) {
                        statusInput.value = 'I';
                    }

                    // Hide if "Show Inactive" is not checked
                    const tableId = telecoms_group.closest('[id^="table_edit_telecoms_"]').id;
                    const checkbox = document.getElementById('show_inactive_telecoms_' + tableId);
                    if (!checkbox || !checkbox.checked) {
                        telecoms_group.classList.add('d-none');
                    }

                    console.log('Marked telecom as inactive:', telecoms_group.querySelector('input.form_telecoms_contact_telecom_id')?.value);
                }
            }
        }

        function setupTelecomsRowButtonEventListeners(row) {
            let buttonEdit = row.querySelector(".btn-edit-telecom");
            if (buttonEdit) {
                buttonEdit.addEventListener('click', editTelecom);
            }

            let buttonInactivate = row.querySelector(".btn-inactivate-telecom");
            if (buttonInactivate) {
                buttonInactivate.addEventListener('click', changeTelecomStatus);
            }

            let buttonActivate = row.querySelector(".btn-activate-telecom");
            if (buttonActivate) {
                buttonActivate.addEventListener('click', changeTelecomStatus);
            }
        }

        function setupContainerDatePickers(container) {
            let datepickers = container.querySelectorAll(".datepicker");
            $(datepickers).datetimepicker(telecomDatePickerSettings);
        }

        function setupContainerListAddButtons(container) {
            if (window.oeUI && window.oeUI.optionWidgets) {
                $(container).find(".addtolist").on("click", function (event) {
                    window.oeUI.optionWidgets.AddToList(this, event);
                });
            }
        }

        function createTelecomRecordFromInput(row_form_telecoms) {
            var record = {};
            record.system = getSelectValue(row_form_telecoms, "select.form_telecoms_system");
            record.use = getSelectValue(row_form_telecoms, "select.form_telecoms_use");
            record.value = getInputValue(row_form_telecoms, "input.form_telecoms_value");
            record.rank = getInputValue(row_form_telecoms, "input.form_telecoms_rank");
            record.notes = getInputValue(row_form_telecoms, "textarea.form_telecoms_notes");
            return record;
        }

        function telecomUpdated(event) {
            const formTelecoms = event.target.closest('.form_telecoms');
            if (!formTelecoms) {
                return;
            }

            const telecomsGroup = formTelecoms.closest('.telecoms_group');
            if (!telecomsGroup) {
                return;
            }

            const actionInput = telecomsGroup.querySelector('input.form_telecoms_data_action');
            if (!actionInput) {
                return;
            }

            const currentAction = actionInput.value;
            if (currentAction === 'ADD' || currentAction === 'INACTIVATE') {
                return;
            }

            if (currentAction === 'NO CHANGE') {
                actionInput.value = TELECOM_ACTION_VALUES.UPDATE;
                console.log('Changed action to UPDATE for telecom:', telecomsGroup.querySelector('input.form_telecoms_contact_telecom_id')?.value);
            }
        }

        // Utility functions
        function setInputValue(root, selector, value) {
            let node = root.querySelector(selector);
            if (node) node.value = value;
        }

        function getInputValue(root, selector) {
            let node = root.querySelector(selector);
            return node ? node.value : "";
        }

        function getSelectDisplay(root, selector) {
            let node = root.querySelector(selector);
            if (!node) return "";
            let options = node.selectedOptions;
            return options && options.length ? options[0].textContent : "";
        }

        function getSelectValue(root, selector) {
            let node = root.querySelector(selector);
            if (!node) return "";
            let options = node.selectedOptions;
            return options && options.length ? options[0].value : "";
        }

        function hideElement(element) {
            element.classList.add('d-none');
        }

        function showElement(element) {
            element.classList.remove('d-none');
        }
    })();
</script>
