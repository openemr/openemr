{#
  Relation Display Template
  Displays relationships with addresses and telecoms included
#}

<style>
    .relation-inactive-display {
        opacity: 0.6;
        background-color: #f8f9fa;
        font-style: italic;
    }
    .relation-card {
        border: 1px solid #dee2e6;
        border-radius: 0.25rem;
        margin-bottom: 1rem;
        background-color: #fff;
    }
    .relation-card-header {
        background-color: #f8f9fa;
        padding: 0.75rem 1rem;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .relation-card-body {
        padding: 1rem;
    }
    .relation-section {
        margin-top: 1rem;
        padding-top: 1rem;
        border-top: 1px solid #e9ecef;
    }
</style>

<div id="{{ table_id|attr }}" class="row mt-3">
    <div class="table_text_relations col-12">
        <div class="text_relations_header label_custom pl-1" style="display: flex; justify-content: space-between; align-items: center; padding-top: 0.2rem; padding-bottom: 0.2rem; background-color: var(--gray300)">
            <div>{{ 'Related Persons'|xlt }}</div>
            {% if relatedPersons|length > 0 %}
            <div class="form-check mr-3" style="margin-bottom: 0; display: flex; align-items: center;">
                <input type="checkbox" class="form-check-input" id="show_inactive_relations_display_{{ table_id|attr }}" onchange="toggleInactiveRelationsDisplay('{{ table_id|attr }}')" style="margin-top: 0; position: static; margin-right: 0.25rem;">
                <label class="form-check-label" for="show_inactive_relations_display_{{ table_id|attr }}" style="font-size: 0.9em; margin-bottom: 0;">
                    {{ 'Show Inactive'|xlt }}
                </label>
            </div>
            {% endif %}
        </div>

        {% set has_active_relations = false %}
        {% for relatedPerson in relatedPersons %}
            {% if relatedPerson.active %}
                {% set has_active_relations = true %}
            {% endif %}
        {% endfor %}

        {% if not has_active_relations %}
        <div class="no_relations">
            <span class="text data pl-1">{{ 'NO RELATED PERSONS'|xlt }}</span>
            <hr class="m-0 p-0" style="border-top-width: 2px; border-color: var(--gray300)" />
        </div>
        {% endif %}

        {% for relatedPerson in relatedPersons %}
        {% set is_inactive = not relatedPerson.active %}
        <div class="relation-card {{ is_inactive ? 'relation-inactive-display d-none' : '' }}" data-active="{{ relatedPerson.active ? '1' : '0' }}">
            <div class="relation-card-header">
                <div>
                    <h5 class="mb-0">
                        {{ relatedPerson.first_name|text }} {{ relatedPerson.last_name|text }}
                        {% if is_inactive %}
                            <span class="badge badge-secondary ml-2">{{ 'Inactive'|xlt }}</span>
                        {% endif %}
                    </h5>
                    <small class="text-muted">
                        {% if relatedPerson.relationship %}
                            {{ list_relationships[relatedPerson.relationship]|text }}
                        {% endif %}
                        {% if relatedPerson.role %}
                            - {{ list_roles[relatedPerson.role]|text }}
                        {% endif %}
                        {% if relatedPerson.gender %}
                            - {{ relatedPerson.gender|text }}
                        {% endif %}
                        {% if relatedPerson.birth_date %}
                            - {{ 'Birth Date'|xlt }}: {{ relatedPerson.birth_date|shortDate }}
                        {% endif %}
                        {% if relatedPerson.notes %}
                            - {{ 'Notes'|xlt }}: {{ relatedPerson.notes|text }}
                        {% endif %}
                    </small>
                </div>
                <div class="text-right">
                    {% if relatedPerson.is_emergency_contact %}
                        <span class="badge badge-danger">{{ 'Emergency Contact'|xlt }}</span>
                    {% endif %}
                    {% if relatedPerson.is_primary_contact %}
                        <span class="badge badge-primary">{{ 'Primary Contact'|xlt }}</span>
                    {% endif %}
                    {% if relatedPerson.can_make_medical_decisions %}
                        <p class="mb-1"><i class="fas fa-check-circle text-success"></i> {{ 'Can Make Medical Decisions'|xlt }}</p>
                    {% endif %}
                    {% if relatedPerson.can_receive_medical_info %}
                        <p class="mb-1"><i class="fas fa-check-circle text-success"></i> {{ 'Can Receive Medical Information'|xlt }}</p>
                    {% endif %}
               </div>
            </div>

            <div class="relation-card-body pt-0">

                {# Telecoms Section #}
                <div class="relation-section1">
                    {% set telecom_table_id = uniqid("table_text_telecoms_") %}
                    {% include 'patient/demographics/telecom_display.html.twig' with {
                        'foreign_table': 'person',
                        'table_id': telecom_table_id,
                        'telecoms': relatedPerson.telecoms,
                        'list_telecom_systems': list_telecom_systems,
                        'list_telecom_uses': list_telecom_uses
                    } only %}
                </div>

                {# Addresses Section #}
                <div class="relation-section2">
                    {% set address_table_id = uniqid("table_text_addresses_") %}
                    {% include 'patient/demographics/address_display.html.twig' with {
                        'foreign_table': 'person',
                        'table_id': address_table_id,
                        'addresses': relatedPerson.addresses,
                        'list_address_types': list_address_types,
                        'list_address_uses': list_address_uses
                    } only %}
                </div>

            </div>
        </div>
        {% endfor %}
    </div>
</div>

<script type="text/javascript">
    function toggleInactiveRelationsDisplay(tableId) {
        const checkbox = document.getElementById('show_inactive_relations_display_' + tableId);
        const table = document.getElementById(tableId);

        if (!table) {
            console.error('Table not found:', tableId);
            return;
        }

        const inactiveRelations = table.querySelectorAll('.relation-inactive-display');

        console.log('Toggle inactive relations:', {
            tableId: tableId,
            checked: checkbox.checked,
            foundRelations: inactiveRelations.length
        });

        inactiveRelations.forEach(function(relation) {
            if (checkbox.checked) {
                relation.classList.remove('d-none');
            } else {
                relation.classList.add('d-none');
            }
        });
    }
</script>
