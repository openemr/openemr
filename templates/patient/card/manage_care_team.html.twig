{% extends "patient/card/card_base.html.twig" %}
{% block content %}
    <html>
    <head>
        {% block head %}
            {{ setupHeader(['no_bootstrap','datetime-picker']) }}
        {% endblock %}
        <script>
            $(function () {
                $('.datepicker').datetimepicker({
                    timepicker: false,
                    formatDate: 'Y-m-d',
                    format: 'Y-m-d'
                });
            });

            function toggleEditMode(enable = true) {
                document.querySelectorAll('.editShow').forEach(el => el.classList.toggle('d-none', !enable));
                document.querySelectorAll('.viewOnly').forEach(el => el.classList.toggle('d-none', enable));
            }

            const existingCareTeam = {{ existing_care_team|js_escape }};
            const userOptions = {{ user_options|js_escape }};
            const facilityOptions = {{ facility_options|js_escape }};
            const roleOptions = {{ role_options|js_escape }};
            const statusOptions = {{ status_options|js_escape }};

            function preloadTeamRows() {
                if (!existingCareTeam.length) return;
                existingCareTeam.forEach((member, idx) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>
                            <span class="viewOnly">${member.user_display || ''}</span>
                            <select name="team[${idx}][user_id]" class="form-control form-control-sm editShow d-none">${userOptions}</select>
                        </td>
                        <td>
                            <span class="viewOnly">${member.role_display || ''}</span>
                            <select name="team[${idx}][role]" class="form-control form-control-sm editShow d-none">${roleOptions}</select>
                        </td>
                        <td>
                            <span class="viewOnly">${member.facility_display || ''}</span>
                            <select name="team[${idx}][facility_id]" class="form-control form-control-sm editShow d-none">${facilityOptions}</select>
                        </td>
                        <td>
                            <span class="viewOnly">${member.provider_since || ''}</span>
                            <input type="text" name="team[${idx}][provider_since]" value="${member.provider_since || ''}" class="datepicker form-control form-control-sm editShow d-none">
                        </td>
                        <td>
                            <span class="viewOnly">${member.status_display || ''}</span>
                            <select name="team[${idx}][status]" class="form-control form-control-sm editShow d-none">${statusOptions}</select>
                        </td>
                        <td>
                            <span class="viewOnly">${member.note || ''}</span>
                            <input name="team[${idx}][note]" value="${member.note || ''}" class="form-control form-control-sm editShow d-none">
                        </td>
                        <td>
                            <button type="button" class="btn btn-danger btn-sm float-right editShow d-none" onclick="this.closest('tr').remove()">×</button>
                        </td>
                        `;
                    document.querySelector('#care_team_table tbody').appendChild(row);

                    // Set Edit mode visibility
                    const userSel = row.querySelector(`select[name="team[${idx}][user_id]"]`);
                    const roleSel = row.querySelector(`select[name="team[${idx}][role]"]`);
                    const facilitySel = row.querySelector(`select[name="team[${idx}][facility_id]"]`);
                    const statusSel = row.querySelector(`select[name="team[${idx}][status]"]`);
                    userSel.value = member.user_id;
                    roleSel.value = member.role;
                    facilitySel.value = member.facility_id;
                    statusSel.value = member.status;
                    // Set view mode text
                    userSel.closest('td').querySelector('.viewOnly').textContent = userSel.selectedOptions[0]?.text || '';
                    roleSel.closest('td').querySelector('.viewOnly').textContent = roleSel.selectedOptions[0]?.text || '';
                    facilitySel.closest('td').querySelector('.viewOnly').textContent = facilitySel.selectedOptions[0]?.text || '';
                    statusSel.closest('td').querySelector('.viewOnly').textContent = statusSel.selectedOptions[0]?.text || '';
                });

                if (existingCareTeam[0]?.team_name) {
                    document.getElementById("team_name").value = existingCareTeam[0].team_name;
                }
            }
            // Function to add a new team member row
            function addTeamRow() {
                const idx = document.querySelectorAll('#care_team_table tbody tr').length;
                const row = document.createElement('tr');
                row.innerHTML = `
                <td><select name="team[${idx}][user_id]" class="form-control form-control-sm" required>${userOptions}</select></td>
                <td><select name="team[${idx}][role]" class="form-control form-control-sm">${roleOptions}</select></td>
                <td><select name="team[${idx}][facility_id]" class="form-control form-control-sm">${facilityOptions}</select></td>
                <td><input type="text" name="team[${idx}][provider_since]" class="datepicker-new form-control form-control-sm"required></td>
                <td><select name="team[${idx}][status]" class="form-control form-control-sm">${statusOptions}</select></td>
                <td><input name="team[${idx}][note]" class="form-control form-control-sm"></td>
                <td><button type="button" class="btn btn-danger btn-sm float-right" onclick="this.closest('tr').remove()">×</button></td>
            `;
                document.querySelector('#care_team_table tbody').appendChild(row);
                $(row).find('.datepicker-new').datetimepicker({
                    timepicker: false,
                    formatDate: 'Y-m-d',
                    format: 'Y-m-d'
                }).removeClass('datepicker-new').addClass('datepicker');
            }

            document.addEventListener("DOMContentLoaded", preloadTeamRows);
        </script>
    </head>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <form method="POST" action="" onsubmit="return confirm({{ translations.save_care_team_confirm|attr_js }});" class="mt-3">
                    <input type="hidden" name="pid" value="{{ pid|attr }}">
                    <input type="hidden" name="csrf_token_form" value="{{ csrf_token|attr }}">
                    <div class="form-group p-0 col-md-3">
                        <label for="team_name">{{ translations.care_team_name|text }}</label>
                        <input type="text" name="team_name" id="team_name" value="{{ team_name|attr }}" class="form-control form-control-sm" required>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-sm table-striped" id="care_team_table">
                            <thead class="thead-light bg-light text-dark">
                            <tr>
                                <th>{{ translations.member|text }}</th>
                                <th>{{ translations.role|text }}</th>
                                <th>{{ translations.facility|text }}</th>
                                <th>{{ translations.since|text }}</th>
                                <th>{{ translations.status|text }}</th>
                                <th>{{ translations.note|text }}</th>
                                <th>{{ translations.remove|text }}</th>
                            </tr>
                            </thead>
                            <tbody>
                            {# Populated by JS #}
                            </tbody>
                        </table>
                    </div>
                    <div class="form-actions mt-3">
                        <button type="button" class="btn btn-outline-secondary btn-sm me-2 editShow d-none" onclick="addTeamRow()">
                            {{ translations.add_team_member|text }}
                        </button>
                        <button type="submit" name="save_care_team" class="btn btn-primary btn-sm editShow d-none" value="true">
                            {{ translations.save_care_team|text }}
                        </button>
                        <button type="button" class="btn btn-outline-danger btn-cancel btn-sm editShow d-none" id="toggleEditBtn" onclick="toggleEditMode(false)">
                            {{ translations.cancel|text }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    </html>
{% endblock %}
