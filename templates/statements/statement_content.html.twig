<div style="padding-left:25px; page-break-inside: avoid;">
    {{ report_header|raw }}

    {% if use_dunning_message and (ins_paid != 0 or level_closed == 4) %}
	{% if age <= first_dun_msg_set %}
	    {% set dun_message = first_dun_msg_text %}
	{% elseif age <= second_dun_msg_set %}
	    {% set dun_message = second_dun_msg_text %}
	{% elseif age <= third_dun_msg_set %}
	    {% set dun_message = third_dun_msg_text %}
	{% elseif age <= fourth_dun_msg_set %}
	    {% set dun_message = fourth_dun_msg_text %}
	{% elseif age >= fifth_dun_msg_set %}
	    {% set dun_message = fifth_dun_msg_text %}
	{% endif %}
    {% endif %}

    {% set label_addressee = 'ADDRESSED TO'|xl %}
    {% set label_remitto = 'REMIT TO'|xl %}
    {% set label_chartnum = 'Chart Number'|xl %}
    {% set label_insinfo = 'Insurance information on file'|xl %}
    {% set label_totaldue = 'Total amount due'|xl %}
    {% set label_payby = 'If paying by'|xl %}
    {% set label_cards = 'VISA/MC/Discovery/HSA'|xl %}
    {% set label_cardnum = 'Card'|xl %}
    {% set label_expiry = 'Exp'|xl %}
    {% set label_cvv = 'CVV'|xl %}
    {% set label_sign = 'Signature'|xl %}
    {% set label_retpay = 'Please return this bottom part with your payment'|xl %}
    {% set label_pgbrk = 'STATEMENT SUMMARY'|xl %}
    {% set label_visit = 'Visit Date'|xl %}
    {% set label_desc = 'Description'|xl %}
    {% set label_amt = 'Amount'|xl %}
</div>
    <div style='margin-left:60px;margin-top:20px;'>
	<pre>
	    <br>
	    _______________________ {{ label_pgbrk }} _______________________<br>
	    <br>
    {{ label_visit|e('html')|pad(11, ' ', 'right') }} {{ label_desc|e('html')|pad(46, ' ', 'right') }} {{ label_amt|e('html') }}<br>

	    {% set count = 5 %}
		{% set aging = [0.00, 0.00, 0.00, 0.00] %}
		{% set todays_time = date().timestamp %}

		{% for line in stmt.lines %}
		{% set description = line.desc|slice(0, 30) %}
		{% if description|slice(0, 14) in ['Procedure 9920', 'Procedure 9921', 'Procedure 9200', 'Procedure 9201'] %}
		    {% set description = description|replace({'Procedure': 'Office Visit'|xl ~ ':'}) %}
		{% endif %}

		{% set dos = line.dos %}
		{% set adj_flag = false %}
		{% set note_flag = false %}
		{% set pt_paid_flag = false %}
		{% set prev_ddate = '' %}
		{% set last_activity_date = dos %}

		{% for dkey, ddata in line.detail %}
		    {% set ddate = dkey|slice(0, 10) %}
		    {% if ddate|match('/^(\\d\\d\\d\\d)(\\d\\d)(\\d\\d)\\s*$/') %}
			{% set ddate = ddate|replace({(ddate|slice(0, 4)): ddate|slice(0, 4) ~ '-', (ddate|slice(4, 2)): ddate|slice(4, 2) ~ '-', (ddate|slice(6, 2)): ddate|slice(6, 2)}) %}
		    {% endif %}

		    {% if ddate and ddate > last_activity_date %}
			{% set last_activity_date = ddate %}
		    {% endif %}

		    {% set amount = '' %}

		    {% if ddata.pmt is not empty %}
			{% set amount = '%.2f'|format(0 - ddata.pmt) %}
			{% set desc = 'Paid'|xl ~ ' ' ~ ddate|shortDate|slice(0, 6) ~ ddate|shortDate|slice(8, 2) ~ ': ' ~ ddata.src ~ ' ' ~ ddata.pmt_method ~ ' ' ~ ddata.insurance_company %}
			{% if ddata.src == 'Pt Paid' or ddata.plv == '0' %}
			    {% set pt_paid_flag = true %}
			    {% set desc = 'Pt paid'|xl ~ ' ' ~ ddate|shortDate|slice(0, 6) ~ ddate|shortDate|slice(8, 2) %}
			{% endif %}
		    {% elseif ddata.rsn is not empty %}
			{% if ddata.chg %}
			    {% set adj_flag = true %}
			{% else %}
			    {% if ddate == prev_ddate %}
				{% if not note_flag %}
				    {% set desc = 'Note'|xlt ~ ' ' ~ ddate|shortDate|slice(0, 6) ~ ddate|shortDate|slice(8, 2) ~ ': ' ~ ': ' ~ ddata.rsn ~ ' ' ~ ddata.pmt_method ~ ' ' ~ ddata.insurance_company %}
				    {% set note_flag = true %}
				{% endif %}
			    {% endif %}
			{% endif %}
		    {% elseif ddata.chg < 0 %}
			{% set amount = '%.2f'|format(ddata.chg) %}
			{% set desc = 'Patient Payment'|xl %}
		    {% else %}
			{% set amount = '%.2f'|format(ddata.chg) %}
			{% set desc = description %}
		    {% endif %}

		    {% if not adj_flag %}
			{{ dos|shortDate|e('html')|pad(10, ' ', 'right') }}  {{ desc|e('html')|pad(45, ' ', 'right') }}{{ amount|e('html')|pad(8, ' ', 'right') }}<br>
			{% set count = count + 1 %}
		    {% endif %}

		    {% set dos = '' %}
		    {% set adj_flag = false %}
		    {% set note_flag = false %}
		    {% set prev_ddate = ddate %}
		{% endfor %}

		{% if line.adjust != '0.00' %}
		    {{ dos|shortDate|e('html')|pad(10, ' ', 'right') }}  {{ "Insurance adjusted"|e('html')|pad(45, ' ', 'right') }}{{ '%.2f'|format(0 - line.adjust)|pad(8, ' ', 'right') }}<br>
		    {% set count = count + 1 %}
		{% endif %}

		{% if not pt_paid_flag %}
		    {{ dos|shortDate|e('html')|pad(10, ' ', 'right') }}  {{ "Item balance"|e('html')|pad(45, ' ', 'right') }}{{ '%.2f'|format(line.amount - line.paid)|pad(8, ' ', 'right') }}<br>
		    {% set count = count + 1 %}
		{% endif %}

		{% set last_activity_date = (line.bill_date > last_activity_date) ? line.bill_date : last_activity_date %}
		{% if stmt.dun_count == '0' %}{% endif %}
	    {% endfor %}

	    <br>
	    {% if stmt.bill_note and stmt.bill_note|length > 0 and show_aging_on_custom_statement %}
		{{ stmt.bill_note|e('html')|pad(46, ' ', 'right') }}<br>
	    {% endif %}

	    {% if dun_message and dun_message|length > 0 %}
		{{ dun_message|e('html')|pad(46, ' ', 'right') }}<br>
	    {% endif %}

	    <br>
	    {% set label_ptname = 'Name'|xl %}
	    {% set label_today = 'Date'|xl %}
	    {% set label_due = 'Due'|xl %}
	    {{ label_ptname|e('html') }}: {{ stmt.patient|e('html')|pad(25, ' ', 'right') }} {{ label_today|e('html') }}: {{ stmt.today|shortDate|e('html')|pad(14, ' ', 'right') }} {{ label_due|e('html') }}: {{ stmt.amount|e('html')|pad(8, ' ', 'left') }}<br>
	    __________________________________________________________________<br>
	    <br>
	    {% set label_call = 'Please call or message if any of the above information is incorrect.'|xl %}
	    {% set label_prompt = 'We appreciate prompt payment of balances due.'|xl %}
	    {{ label_call|e('html') }}<br>
	    {{ label_prompt|e('html') }}<br>
	    <br>
	    {{ clinic_name|e('html') }}<br>
	    {% set label_dept = 'Billing Department'|xl %}
	      {{ label_dept|e('html') }} {{ billing_phone_number|e('html') }}<br>

	    {% if statement_message and statement_message|length > 0 %}
		<br>
		{{ statement_message|e('html')|pad(40, ' ', 'right') }}<br>
	    {% endif %}

	    {% if show_aging_on_custom_statement and ageline %}
		<br>{{ ageline|e('html') }}<br><br>
	    {% endif %}

	    {% if number_appointments_on_statement > 0 and events|length > 0 %}
		<br>
		{% set label_appointments = 'Future Appointments'|xl %}
		{{ label_appointments|e('html') }}:<br>
		{% for event in events %}
		    {% if event.pc_startTime|length > 0 %}
			{% set appt_provider = event.umname|length > 0 ? event.ufname ~ ' ' ~ event.umname ~ ' ' ~ event.ulname : event.ufname ~ ' ' ~ event.ulname %}
			{{ 'Date'|xlt }}: {{ event.pc_eventDate|shortDate|text }} {{ 'Time'|xlt }} {{ event.pc_startTime|slice(0, 5)|text }} {{ 'Provider'|xlt }} {{ appt_provider|text }}<br>
		    {% endif %}
		{% endfor %}
	    {% endif %}

	    <br>{{ label_retpay|e('html') }}<br>
	</pre>
    </div>

    <div style="width:7.0in;border-top:1pt dotted black;font-size:12px;margin:0px;"><br><br>
	<table style="width:8in;margin-left:20px;"><tr><td style="width:4.5in;"><br>
	    {{ label_payby|e('html') }} {{ label_cards|e('html') }}<br><br>
	    {{ label_cardnum|e('html') }}: {TextInput}  {{ label_expiry|e('html') }}: {smTextInput} / {smTextInput} <br><br>
	    {{ label_sign|e('html') }}  {PatientSignature}<br>
	</td><td style="width:2.0in;vertical-align:middle;">
	    {% if has_practice_cards %}
		<br><p>{{ label_totaldue|e('html') }}: {{ stmt.amount|e('html') }}</p>
	    {% endif %}
	</td></tr></table>
    </div><br>

    {% if stmt.to[3] is defined and stmt.to[3]|length > 0 %}
	<pre>   {{ stmt.to[3]|e('html')|pad(32, ' ', 'right') }}</pre>
    {% endif %}

    <pre>
    <div style="width:8in;border-top:1pt solid black;"><br>
	<table style="width:6.0in;margin-left:40px;"><tr>
	    <td style="width:3.0in;"><b>{{ label_addressee|e('html') }}</b><br>
		{{ stmt.to[0]|e('html') }}<br>
		{{ stmt.to[1]|e('html') }}<br>
		{{ stmt.to[2]|e('html') }}
	    </td>
	    <td style="width:3.0in;"><b>{{ label_remitto|e('html') }}</b><br>
		{{ remit_name|e('html') }}<br>
		{{ remit_addr|e('html') }}<br>
		{{ remit_csz|e('html') }}
	    </td>
	</tr></table>
    </div></div>
    &#x0C;
    <br><br>
    </pre>
