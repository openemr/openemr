/*! For license information please see telehealth.min.js.LICENSE.txt */
!function(){"use strict";function t(t){var e=this,i=0;return this.checkRegistration=function(){if(i++>10)return void console.error("Failed to get a valid telehealth registration for user");let n=t+"?action=check_registration";window.top.restoreSession(),window.fetch(n).then((t=>{if(!t.ok)throw new Error("Registration check failed");return t.json()})).then((t=>{t&&t.hasOwnProperty("errorCode")&&402==t.errorCode&&(e.settings={}),e.settings=t})).catch((t=>{console.error("Failed to execute check_registration action",t),setTimeout(e.checkRegistration.bind(e),2e3)}))},this}function e(t,e,i,n){let o=this,s=null,a=null;this.cancelDialog=function(){let t=a.querySelectorAll(".hangup-section"),e=a.querySelector(".hangup-section.hangup-section-start");if(t&&t.length)for(let e=0;e<t.length;e++)t[e].classList.add("d-none");e&&e.classList.remove("d-none"),s.hide()},this.processConfirmYesAction=function(t){a.querySelector(".row-confirm").classList.add("d-none"),a.querySelector(".row-update-status").classList.remove("d-none")},this.sendAppointmentStatusUpdate=function(n){console.log("Setting appointment to status ",n);let o="action=set_appointment_status&pc_eid="+encodeURIComponent(e)+"&status="+encodeURIComponent(n);window.top.restoreSession(),window.fetch(i,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:o,redirect:"manual"}).then((i=>{i.ok&&200==i.status||(alert(t.APPOINTMENT_STATUS_UPDATE_FAILED),console.error("Failed to update appointment "+e+" to status "+n))}))},this.updateAppointmentStatusAndClose=function(t){jQuery(a).on("hidden.bs.modal",(function(){try{jQuery(a).off("hidden.bs.modal"),n()}catch(t){console.error(t)}try{"CloseWithoutUpdating"!=t&&o.sendAppointmentStatusUpdate(t)}catch(t){console.error(t)}})),s.hide()},this.processHangupSetting=function(t){let e=t.currentTarget.dataset.status||"CloseWithoutUpdating";o.updateAppointmentStatusAndClose(e)},this.processSetStatusFromSelector=function(t){let e=a.querySelector(".appointment-status-update");e&&e.value?o.updateAppointmentStatusAndClose(e.value):console.error("Failed to find selector .appointment-status-update node or value is not defined for node")},this.show=function(){a=document.getElementById("telehealth-container-hangup-confirm"),s=new bootstrap.Modal(a,{keyboard:!1,focus:!0,backdrop:"static"});let t=a.querySelectorAll(".btn-telehealth-confirm-cancel");for(var e=0;e<t.length;e++)t[e].addEventListener("click",o.cancelDialog);let i=a.querySelector(".btn-telehealth-confirm-yes");i?i.addEventListener("click",o.processConfirmYesAction):console.error("Could not find selector with .btn-telehealth-confirm-yes");let n=a.querySelector(".btn-telehealth-session-select-update");for(n&&n.addEventListener("click",o.processSetStatusFromSelector),t=a.querySelectorAll(".btn-telehealth-session-close"),e=0;e<t.length;e++)t[e].addEventListener("click",o.processHangupSetting);s.show()}}function i(t,e,i){let n=this;return n.node=t,n.value=e,n.callback=i,n.enabled=!0===e,n.init=function(){n.enabled?n.attach():n.detatch()},n.attach=function(){this.node&&(this.node.addEventListener("click",this.callback),this.node.classList.remove("d-none"))},n.detatch=function(){this.node&&(this.node.removeEventListener("click",this.callback),this.node.classList.add("d-none"))},n.destruct=function(){n.detatch(),n.node=null,n.callback=null},n.toggle=function(){n.enabled=!n.enabled,n.enabled?this.attach():this.detatch()},n.init(),n}function n(t,e){var n=this;function o(){}function s(t,e,i){t.hasOwnProperty(e)||(t[e]=i)}return n.__buttons={},n.__container=t,n.init=function(){if(s(e=e||{},"notes",!1),s(e,"notesCallback",o),s(e,"microphone",!0),s(e,"microphoneCallback",o),s(e,"video",!0),s(e,"videoCallback",o),s(e,"expand",!1),s(e,"expandCallback",o),s(e,"hangup",!1),s(e,"hangupCallback",o),s(e,"screenshare",!0),s(e,"screenshareCallback",o),s(e,"invite",!1),s(e,"inviteCallback",o),["notes","microphone","video","expand","hangup","screenshare","invite"].forEach((t=>{let s=n.__container.querySelector(".telehealth-btn-"+t),a=e[t+"Callback"]||o;s?n.__buttons[t]=new i(s,e[t],a):console.error("Failed to find node for telehealth-btn-"+t)})),!n.__buttons.microphone.enabled){let t=n.__buttons.microphone,e=t.node.querySelector(".fa");t&&e?(t.toggle(),e.classList.add("fa-microphone-slash"),e.classList.remove("fa-microphone")):console.error("Failed to find microphone node and fa icon")}if(!n.__buttons.video.enabled){let t=n.__buttons.video,e=t.node.querySelector(".fa");t&&e?(t.toggle(),e.classList.add("fa-video-slash"),e.classList.remove("fa-video")):console.error("Failed to find video node and fa icon")}},n.destruct=function(){Object.values(n.__buttons).forEach((t=>t.detatch())),n.__container=null},n.toggleButtons=function(t){t.forEach((t=>{n.__buttons[t]?n.__buttons[t].toggle():console.error("Failed to find button to toggle for button "+t)}))},n.init(),n}class o{__call=null;__container=null;__video=null;constructor(t){if(this.__call=null,this.__container=document.getElementById(t),this.__video=this.__container.querySelector(".participant-video"),!this.__video)throw new Error("Failed to find #"+t+" element")}hasVideo(){return!this.isAvailable()}getVideoStream(){return this.__video.srcObject}isAvailable(){return null==this.__call}getRemotePartyId(){return this.__call?this.__call.getRemotePartyId():null}attach(t,e,i){if(this.__call=t,null==t||null==e)throw console.error("Call or stream were null.  Cannot proceed",{call:t,stream:e}),new Error("call and stream cannot be null");this.__video.srcObject=e,this.__video.play();let n=this.__container.querySelector(".participant-label");n&&(n.textContent=jsText(i)),this.__video.title=jsText(i)}detach(){this.__call&&this.__call.setUserData(null),this.__call=null,this.__video.srcObject=null}hide(){this.__container&&this.__container.classList.add("d-none")}show(){this.__container&&this.__container.classList.remove("d-none")}setPinnedStatus(t){this.__container&&(t?this.__container.classList.add("pinned"):this.__container.classList.remove("pinned"))}}class s{__videoNode=null;__screenshareNode=null;__videoSlot=null;__screenshareSlot=null;__currentSlot=null;__containerId=null;__boundInternalEvent=null;__participant=null;__isPinned=!1;__selectCallbacks=[];constructor(t,e){let i=document.getElementById(t),n="participant-list-template-node",s=i.querySelector("."+n);if(!i)throw new Error("Failed to find container id with "+t);if(!s)throw new Error("Failed to find template container with ."+n);let a="participant-video-"+e,r="participant-screenshare-"+e;this.__boundInternalEvent=this.handleSelectEvent.bind(this),this.__videoNode=this.__setupParticipantContainer(t,a,this.__boundInternalEvent),this.__screenshareNode=this.__setupParticipantContainer(t,r,this.__boundInternalEvent),this.__videoSlot=new o(a),this.__screenshareSlot=new o(r),this.__currentSlot=this.__videoSlot,this.__selectCallbacks=[],this.__isPinned=!1}__setupParticipantContainer(t,e,i){let n=document.getElementById(t),o="participant-list-template-node",s=n.querySelector("."+o);if(!n)throw new Error("Failed to find container id with "+t);if(!s)throw new Error("Failed to find template container with ."+o);let a=s.cloneNode(!0);return a.classList.remove(o),a.id=e,n.appendChild(a),a.addEventListener("click",i),a}setPinnedStatus(t){this.__isPinned=t,this.__videoSlot&&this.__videoSlot.setPinnedStatus(t),this.__screenshareSlot&&this.__screenshareSlot.setPinnedStatus(t)}isPinned(){return this.__isPinned}handleSelectEvent(t){this.__selectCallbacks.forEach((t=>t(this)))}addCallerSelectListener(t){this.__selectCallbacks.push(t)}getRemotePartyId(){return this.__currentSlot?this.__currentSlot.getRemotePartyId():null}hide(){this.__currentSlot&&this.__currentSlot.hide()}show(){this.__currentSlot&&this.__currentSlot.show()}isAvailable(){return this.__videoSlot.isAvailable()}isAvailableForCall(t){return!(!this.__videoSlot.isAvailable()&&this.__videoSlot.getRemotePartyId()!=t.getRemotePartyId())}getCurrentCallStream(){return this.__currentSlot?this.__currentSlot.getVideoStream():null}getParticipant(){return this.__participant}attach(t,e,i){if(null==t||null==e||null==i)throw console.error("Call, stream, or participant were null.  Cannot proceed",{call:t,stream:e,participant:i}),new Error("call, stream, and participant cannot be null");t.isScreenSharing()?(this.__screenshareSlot.isAvailable()||this.__screenshareSlot.detach(),this.__screenshareSlot.attach(t,e,i.callerName||""),this.showScreenshare()):(this.__videoSlot.isAvailable()||this.__videoSlot.detach(),this.__videoSlot.attach(t,e,i.callerName||""),this.showVideo()),this.__participant=i,t.setUserData(this)}showScreenshare(){this.__videoSlot.hide(),this.__screenshareSlot.show(),this.__currentSlot=this.__screenshareSlot}showVideo(){this.__videoSlot.show(),this.__screenshareSlot.hide(),this.__currentSlot=this.__videoSlot}detachScreenshare(){this.__screenshareSlot.detach(),this.__videoSlot&&this.showVideo()}detatchVideo(){this.__videoSlot.detach(),this.__currentSlot=null,this.__participant=null}detach(){this.detachScreenshare(),this.detatchVideo()}destruct(){this.detach(),this.__selectCallbacks=[],this.__screenshareNode&&(this.__screenshareNode.removeEventListener("click",this.__boundInternalEvent),this.__screenshareNode.parentNode.removeChild(this.__screenshareNode),this.__screenshareNode=null),this.__videoNode&&(this.__videoNode.removeEventListener("click",this.__boundInternalEvent),this.__videoNode.parentNode.removeChild(this.__videoNode),this.__videoNode=null)}}function a(t,e){if(!t)throw new Error(e)}function r(t){try{t()}catch(t){console.log("Ignoring exception in user callback: "+t)}}class l{constructor(t,e){this.t=t,this.i=1,this.h=e}get(){return this.t}incRef(){++this.i}decRef(){0==--this.i&&(this.h(this.t),this.h=null,this.t=null)}}class c{constructor(t){this.o=t,this.l="",this.u=new TextDecoder("utf-8"),this._=!1}cancel(){this.o.cancel()}eof(){return this._}v(){const t=this.l.indexOf("\r\n");if(-1==t)return null;const e=this.l.substr(0,t);return this.l=this.l.substr(t+2),e}p(){return this.o.read().then((t=>{if(t.done)return this._=!0,Promise.resolve(this.l);this.l+=this.u.decode(t.value);const e=this.v();return e?Promise.resolve(e):this.p()}))}readEvent(){if(this._)return Promise.reject();const t=this.v();return t?Promise.resolve(t):this.p()}}class d{constructor(t){this.g=t}I(t,e){return fetch(this.g+t,{method:"POST",cache:"no-cache",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)}).then((t=>t.ok?t.json():Promise.reject(t.status)))}C(t,e){return fetch(this.g+t,{method:"POST",cache:"no-cache",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)})}createBridge(t,e,i){const n={userId:t,passwordHash:e,type:i};return fetch(this.g+"/client/createBridge",{method:"POST",cache:"no-cache",headers:{"Content-Type":"application/json"},body:JSON.stringify(n)})}invite(t){return this.C("/client/invite",{callId:t})}call(t,e,i){return this.I("/client/call",{callerId:t,calleeId:e,isScreenSharing:i})}accept(t,e){return this.C("/client/accept",{callId:t,token:e})}reject(t,e){return this.C("/client/reject",{callId:t,token:e})}offer(t,e,i){return this.C("/client/offer",{callId:t,sdp:i,token:e})}answer(t,e,i){return this.C("/client/answer",{callId:t,sdp:i,token:e})}ice(t,e,i){return this.C("/client/ice",{callId:t,candidate:e,token:i})}end(t,e){return this.C("/client/end",{callId:t,token:e})}}const h=new class{constructor(){this.m=[],this.k=0,this.S=-1}P(){this.m.forEach((t=>t.func()))}T(){this.S=setInterval((()=>this.P()),500)}V(){clearInterval(this.S),this.S=-1}addTask(t){const e=this.k++,i={id:e,func:t};return this.m.push(i),1==this.m.length&&this.T(),e}removeTask(t){const e=this.m.findIndex((e=>e.id==t));-1!=e&&(this.m.splice(e,1),0==this.m.length&&this.V())}},u=new class{newAudioContext(){return new(window.AudioContext||window.webkitAudioContext)}};class p{constructor(){this.L=-1,this.A=u.newAudioContext(),this.j=this.A.createAnalyser(),this.j.fftSize=2048,this.j.minDecibels=-100,this.j.maxDecibels=0,this.j.smoothingTimeConstant=.8,this.B=new Uint8Array(this.j.frequencyBinCount),this.R=null,this.db=0,this.ondbthresholdexceeded=t=>{},this.dbthreshold=-50}connect(t){let e;try{e=this.A.createMediaStreamSource(t),e.connect(this.j),this.j.connect(this.A.destination)}catch(t){return}-1==this.L&&(this.L=h.addTask((()=>this.O()))),this.R&&this.R.disconnect(),this.R=e}disconnect(){-1!=this.L&&(h.removeTask(this.L),this.R.disconnect(),this.R=null,this.L=-1)}O(){this.j.getByteFrequencyData(this.B);let t=-100;for(let e=0;e<this.B.length;++e)t=Math.max(t,this.B[e]);this.db=.3921568627*t-100,this.db>=this.dbthreshold&&r((()=>this.ondbthresholdexceeded(this)))}}const _="Copyright (c) 2023 Comlink Inc.";class m{constructor(t){this.U=t.isInbound,this.N=t.isScreenSharing,t.basedOnCall&&(this.M=t.basedOnCall.M,this.M.incRef()),this.D=t.remotePartyId,this.J=t.bridge,this.H=t.callId,this.K=t.config,this.F=t.token,this.G=null,this.W=null,this.q=null,this.o=null,this.X=null,this.Y=null,this.Z=[],t.isInbound?this.$=1:this.$=0,this.oncallstarted=t=>this.tt("Unhandled event: call started: "+t.H),this.oncallrejected=t=>this.tt("Unhandled event: call rejected: "+t.H),this.oncallended=t=>this.tt("Unhandled event: call ended: "+t.H),this.onstreamupdated=(t,e)=>this.tt("Unhandled event: stream updated: "+t.H),this.onparticipantlistupdated=(t,e)=>this.tt("Unhandled event: participant list updated: "+t.H),this.onviewportlayoutupdated=(t,e)=>this.tt("Unahndled event: viewport layout updated: "+e),this.onfacialrecognizerresults=(t,e)=>this.tt("Unhandled event: facial recognizer results: "+e)}it(t){console.log("VC/"+this.H+": "+t)}st(t){console.error("VC/"+this.H+": "+t)}tt(t){console.warn("VC/"+this.H+": "+t)}et(){return this.G=new RTCPeerConnection(this.K),this.G.onicecandidate=t=>this.ht(t),this.G.ontrack=t=>this.nt(t),this.G.onremovetrack=t=>this.rt(t),this.N?this.U?Promise.resolve(this):this.ot():this.ct()}lt(t,e){this.G.addTrack(t,e),t.addEventListener("ended",(()=>this.dt(t)))}ut(t){t.getTracks().forEach((e=>this.lt(e,t)))}ct(){return this.J.getLocalMediaStream().then((t=>{this.ut(t)}))}ot(){if(!this.M){const t={video:{cursor:"always"},audio:!0};return navigator.mediaDevices.getDisplayMedia(t).then((t=>{this.ut(t),this.M=new l(t,(t=>{t.getTracks().forEach((t=>t.stop()))})),r((()=>this.onstreamupdated(this,t)))}))}{const t=this.M.get();this.ut(t),r((()=>this.onstreamupdated(this,t)))}}_t(){6!=this.$&&(this.$=6,this.J.vt(this),this.q&&(this.q.disconnect(),this.q=null),this.M&&this.M.decRef(),this.G.close(),this.G=null)}gt(t){return 6!=this.$&&4!=this.$?(this._t(),r((()=>this.oncallended(this))),t?this.J.ft.end(this.H,this.F).then((()=>this)):this):Promise.resolve(this)}bt(t){switch(a("CALL"==t.type,'Bad event type. "CALL" expected.'),t.name){case"accept":this.wt();break;case"end":this.It();break;case"reject":this.yt();break;case"sdp":this.Ct(t.sdp,t.action);break;case"ice":this.kt(t.iceCandidate);break;case"participants":this.St(t.userIds);break;case"viewportLayout":this.Et({frameWidth:t.frameWidth,frameHeight:t.frameHeight,viewports:t.viewports});break;case"facialRecognition":this.Pt({callId:t.tagCallId,tag:t.tag,confidence:t.confidence});break;default:throw new Error("Bad call state")}}St(t){this.X=t,r((()=>this.onparticipantlistupdated(this,this.X)))}Et(t){this.Y=t,r((()=>this.onviewportlayoutupdated(this,this.Y)))}Pt(t){r((()=>this.onfacialrecognizerresults(this,t)))}kt(t){this.G.remoteDescription?this.G.addIceCandidate(t):this.Z.push(t)}nt(t){this.o=t.streams[0],this.q&&this.q.connect(this.o),r((()=>this.onstreamupdated(this,this.o)))}rt(t){}dt(t){this.gt(!0)}It(){this.gt(!1)}wt(){this.G.createOffer({offerToReceiveVideo:!0,offerToReceiveAudio:!0}).then((t=>this.G.setLocalDescription(t))).then((()=>this.J.ft.offer(this.H,this.F,this.G.localDescription.sdp))).catch((t=>{throw this.Tt(t),t})),r((()=>this.oncallstarted(this)))}yt(){this.J.vt(this),this.$=4,r((()=>this.oncallrejected(this)))}Ct(t,e){const i=new RTCSessionDescription({type:e,sdp:t});"offer"==e?this.G.setRemoteDescription(i).then((()=>(this.Vt(),this.G.createAnswer()))).then((t=>this.G.setLocalDescription(t))).then((()=>this.J.ft.answer(this.H,this.F,this.G.localDescription.sdp))).then((t=>(this.$=3,t))).catch((t=>{throw this.Tt(t),t})):"answer"==e&&this.G.setRemoteDescription(i).then((()=>{this.Vt(),this.$=3})).catch((t=>{throw this.Tt(t),t}))}Vt(){this.Z.forEach((t=>{this.G.addIceCandidate(t)})),this.Z=[]}ht(t){if(t.candidate)try{this.J.ft.ice(this.H,t.candidate,this.F)}catch(t){this.tt("failed to transmit ICE candidate")}}Tt(t){this.$=4,this.st("panic: "+t.message)}getParticipantList(){return this.X}getViewportLayout(){return this.Y}getCallId(){return this.H}getVideoBridge(){return this.J}getRemotePartyId(){return this.D}isInbound(){return this.U}setUserData(t){this.W=t}getUserData(){return this.W}isScreenSharing(){return this.N}attachActivityMonitor(t,e){a(null==this.q,"Activity notifier already attached"),a(null!=e,"Activity monitor callback not defined"),this.q=new p,this.q.dbthreshold=t,this.q.ondbthresholdexceeded=t=>r((()=>e(this))),this.o&&this.q.connect(this.o)}getSoundLevel(){return this.q?this.q.db:NaN}start(){return a(0==this.$,"Call already initialized"),this.$=1,this.it("starting"),this.J.ft.call(this.J.getUserId(),this.D,this.N).then((t=>(this.H=t.callId,this.K=t.config,this.F=t.token,this.et()))).then((()=>this.J.ft.invite(this.H))).then((()=>(this.$=2,this.J.Lt(this),this))).catch((t=>{throw this.Tt(t),t}))}accept(){return a(1==this.$,"Invalid call state"),a(this.U,"Not an inbound call"),this.it("accepting"),this.et().then((()=>this.J.ft.accept(this.H,this.F))).then((t=>(this.$=2,this))).catch((t=>{throw this.Tt(t),t}))}reject(){return a(1==this.$,"Invalid call state"),a(this.U,"Not an inbound call"),this.it("rejecting"),this.J.ft.reject(this.H,this.F).then((t=>(this.$=5,this.J.vt(this),this))).catch((t=>{throw this.Tt(t),t}))}stop(){return this.gt(!0)}muteRemoteAudio(t){a("boolean"==typeof t,"Expected a boolean value"),this.G.getReceivers().forEach((e=>{"audio"==e.track.kind&&(e.track.enabled=t)}))}}class g{constructor(t){this.At=t.userId,this.jt=t.type,this.Bt=t.passwordHash,this.ft=new d(t.serviceUrl||""),this.Rt=!1,this.Ot={},this.Ut=!1,this.Nt=!1,this.xt=null,this.Mt=null,this.onbridgeactive=t=>console.log("onbridgeactive event not handled"),this.onbridgeinactive=t=>console.log("onbridgeinactive event not handled"),this.onbridgefailure=t=>console.log("onbridgefailure event not handled"),this.onincomingcall=t=>{console.log("Inbound call event not handled; call rejected."),t.reject()}}Tt(t){console.log("Catastrophic bridge failure: "+t),r((()=>this.onbridgefailure(this))),this.shutdown()}Dt(){this.Rt?this.Tt(new Error("Event stream closed unexpectedly")):r((()=>this.onbridgeinactive(this)))}Jt(){this.xt.readEvent().then((t=>{if(this.xt.eof())this.Dt();else{try{const e=JSON.parse(t);this.bt(e)}catch(t){return void this.Tt(t)}this.Jt()}}))}zt(t){const e=this.Ot[t.callId];e?e.bt(t):console.log("Invalid call identifier in the event stream: "+t.callId)}Ht(t){const e=new m({bridge:this,callId:t.callId,isInbound:!0,isScreenSharing:t.isScreenSharing,remotePartyId:t.callerId,config:t.config,token:t.token});this.Lt(e),r((()=>this.onincomingcall(e)))}Kt(t){this.Rt||(this.Rt=!0,r((()=>this.onbridgeactive(this))))}bt(t){switch(console.log(t),t.type){case"INCOMING":this.Ht(t);break;case"KEEPALIVE":this.Kt(t);break;case"CALL":this.zt(t);break;default:this.Tt(new Error("Bad event type: "+t.type+". Corrupt stream?"))}}Ft(){Object.values(this.Ot).forEach((t=>t._t())),this.Ot={}}Lt(t){this.Ot[t.getCallId()]=t}vt(t){const e=t.getCallId();this.Ot.hasOwnProperty(e)&&delete this.Ot[e]}getUserId(){return this.At}getCalls(){return Object.values(this.Ot)}hasCamera(){return this.Ut}hasMicrophone(){return this.Nt}getCallById(t){return this.Ot[t]}isActive(){return this.Rt}getLocalMediaStream(){return a(this.Rt,"VideoBridge not active"),this.Mt?Promise.resolve(this.Mt):navigator.mediaDevices.enumerateDevices().then((t=>{var e={};return null!=t.find((t=>"videoinput"==t.kind))&&(this.Ut=!0,e.video={width:800,height:600}),null!=t.find((t=>"audioinput"==t.kind))&&(this.Nt=!0,e.audio={channels:1}),navigator.mediaDevices.getUserMedia(e)})).then((t=>(this.Mt=t,t)))}closeLocalMediaStream(){a(this.Rt,"VideoBridge not active"),this.Mt&&(this.Mt.getTracks().forEach((t=>t.stop())),this.Mt=null,this.Nt=!1,this.Ut=!1)}enableCamera(t){a(this.Rt,"Video bridge not active"),a("boolean"==typeof t,"Expected a boolean value"),this.Ut&&this.Mt.getTracks().forEach((e=>{"live"==e.readyState&&"video"===e.kind&&(e.enabled=t)}))}enableMicrophone(t){a(this.Rt,"Video bridge not active"),a("boolean"==typeof t,"Expected a boolean value"),this.Nt&&this.Mt.getTracks().forEach((e=>{"live"==e.readyState&&"audio"===e.kind&&(e.enabled=t)}))}start(){a(!this.Rt,"Video bridge already active"),console.log("CVB v1.1.6. "+_),this.ft.createBridge(this.At,this.Bt,this.jt).then((t=>t.body)).then((t=>{this.xt=new c(t.getReader()),this.Jt()})).catch((t=>{console.error("Video bridge creation failure: "+t),r((()=>this.onbridgefailure(this))),this.Tt(t)}))}shutdown(){a(this.Rt,"Video bridge not active"),console.log("CVB v1.1.6. "+_),Object.values(this.Ot).slice().forEach((t=>t.stop())),this.closeLocalMediaStream(),this.Rt=!1,this.xt.cancel()}createVideoCall(t){return a(this.Rt,"Video bridge not active"),new m({bridge:this,isInbound:!1,isScreenSharing:!1,remotePartyId:t})}createScreenSharingCall(t,e){return a(this.Rt,"Video bridge not active"),new m({bridge:this,isInboud:!1,isScreenSharing:!0,remotePartyId:t,basedOnCall:e})}}class f{isShutdown=!1;userId=null;passwordHash=null;serviceUrl=null;bridge;currentLocalScreenShareCall;constructor(t,e,i){this.userId=t,this.passwordHash=e,this.serviceUrl=i,this.isRunning=!1}noop(){}startBridge(t){(t=t||{}).onincomingcall=t.onincomingcall||this.noop,t.onbridgeactive=t.onbridgeactive||this.noop,t.onbridgeinactive=t.onbridgeinactive||this.noop,t.onbridgefailure=t.onbridgefailure||this.noop,this.bridge=new g({userId:this.userId,passwordHash:this.passwordHash,type:"normal",serviceUrl:this.serviceUrl}),console.log("Instantiated bridge "+this.userId),this.bridge.onincomingcall=e=>{console.log("Receiving call from "+e.getRemotePartyId()+" for "+this.userId),t.onincomingcall(e)},this.bridge.onbridgeactive=e=>{console.log("The bridge is active "+this.userId),t.onbridgeactive(e)},this.bridge.onbridgeinactive=e=>{console.log("The bridge is inactive "+this.userId),t.onbridgeinactive(e)},this.bridge.onbridgefailure=e=>{if(console.error("The bridge failed "+this.userId),!this.isShutdown)try{t.onbridgefailure(e)}catch(t){console.error("Failure occurred in bridge shutdown handler",t)}this.isShutdown=!0,this.shutdown()},this.bridge.start(),console.log("Started bridge "+this.userId),this.isShutdown=!1}hasLocalPermissionsEnabled(){return!!this.bridge&&this.bridge.hasLocalPermissionsEnabled()}shutdown(){if(!this.isShutdown){try{this.bridge.shutdown()}catch(t){console.log("Error shutting down bridge",t)}this.isShutdown=!0}}restartMediaStream(){this.isShutdown&&console.error("Bridge is shutdown.  Cannot restart media stream")}getLocalMediaStream(){return this.bridge.getLocalMediaStream()}enableMicrophone(t){return this.bridge.enableMicrophone(t)}enableCamera(t){return this.bridge.enableCamera(t)}createScreenSharingCall(t){let e=this.bridge.createScreenSharingCall(t[0]);t.shift();let i=e.start();return t.length<=0?i.then((()=>(this.currentLocalScreenShareCall=e,this.setScreenShareCallHandlers(e),e))):i.then((()=>(this.currentLocalScreenShareCall=e,this.setScreenShareCallHandlers(e),Promise.all(t.map((t=>{let e=this.bridge.createScreenSharingCall(t,this.currentLocalScreenShareCall);return this.setScreenShareCallHandlers(e),e.start()}))).then((t=>this.currentLocalScreenShareCall)).catch((t=>{throw this.currentLocalScreenShareCall&&(console.log("multiparty screenshare failed "),this.currentLocalScreenShareCall.stop(),this.currentLocalScreenShareCall=null),t})))))}createVideoCall(t){return this.bridge.createVideoCall(t)}setCallHandlers(t){return this.bridge.setCallHandlers(t)}setScreenShareCallHandlers(t){this.currentLocalScreenShareCall.oncallended=()=>{this.currentLocalScreenShareCall=null}}}class S{videoElement=null;callerSlot=null;constructor(t){if(this.videoElement=document.getElementById(t),!this.videoElement)throw new Error("Failed to find presentation screen dom node with id "+t)}updateCallerSlotScreen(){this.callerSlot&&null!=this.callerSlot.getCurrentCallStream()&&this.videoElement&&this.callerSlot.getCurrentCallStream()!=this.videoElement.srcObject&&(this.videoElement.srcObject=this.callerSlot.getCurrentCallStream(),this.videoElement.play().catch((t=>console.error("presentation-screen failed to play updated call slot",t))))}attach(t){if(null==this.callerSlot||this.callerSlot!==t&&this.callerSlot.getRemotePartyId()!=t.getRemotePartyId()){if(this.callerSlot&&this.detach(),t&&null!=t.getCurrentCallStream()){let e=t.getParticipant()?t.getParticipant().callerName:"";this.videoElement.srcObject=t.getCurrentCallStream(),this.videoElement.play(),this.videoElement.title=e,this.callerSlot=t}}else this.updateCallerSlotScreen()}hide(){this.videoElement&&this.videoElement.classList.add("d-none")}show(){this.videoElement&&this.videoElement.classList.remove("d-none")}getVideoElement(){return this.videoElement}detach(){this.callerSlot=null,this.videoElement.srcObject=null}}class v{modal=null;container=null;pc_eid=null;scriptLocation=null;fhirLocation=null;closeCallback=null;__translations=null;__idx=0;__apiCSRFToken=null;__currentScreen=null;__updatedCallerSettings=null;__participantList=null;__updateParticipants=!1;constructor(t,e,i,n,o,s,a){this.pc_eid=i,this.scriptLocation=n,this.fhirLocation=o,this.closeCallback=a,this.__translations=e,this.__apiCSRFToken=t,this.__participantList=(s||[]).filter((t=>"provider"!==t.role)),this.__updateParticipants=!1}cancelDialog(){this.closeDialogAndSendCallerSettings()}sendSaveParticipant(t){let e=Object.assign({eid:this.pc_eid},t),i=this.scriptLocation+"?action=save_session_participant";return window.top.restoreSession(),window.fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),redirect:"manual"}).then((t=>{if(400==t.status||t.ok&&200==t.status)return t.json();throw new Error("Failed to save participant in "+this.pc_eid+" with save data")})).then((t=>{if(t.error)return void this.handleSaveParticipantErrorResponse(t);let e=t.callerSettings||{};this.showActionAlert("success",this.__translations.PATIENT_INVITATION_SUCCESS),this.__updatedCallerSettings=e;let i=(e.participantList||[]).filter((t=>"provider"!=t.role));this.__participantList=i,this.__updateParticipants=!0,this.updateParticipantControls(),this.showPrimaryScreen(),setTimeout((()=>{this.closeDialogAndSendCallerSettings()}),1e3)}))}closeDialogAndSendCallerSettings(){jQuery(this.container).on("hidden.bs.modal",(()=>{try{jQuery(this.container).off("hidden.bs.modal"),this.closeCallback(this.__updatedCallerSettings)}catch(t){console.error(t)}try{this.destruct()}catch(t){this.destruct()}})),this.modal.hide()}sendSearchResults(t){let e=this.fhirLocation+"/Patient",i=[];if(t.pid&&i.push("identifier="+encodeURIComponent(t.pid)),t.fname||t.lname){let e=[];t.fname&&e.push(encodeURIComponent(t.fname)),t.lname&&e.push(encodeURIComponent(t.lname)),i.push("name:contains="+e.join(","))}if(t.DOB&&i.push("birthdate="+encodeURIComponent(t.DOB)),t.email&&i.push("email:contains="+encodeURIComponent(t.email)),!i.length)throw alert(this.__translations.SEARCH_REQUIRES_INPUT),new Error("Failed to perform search due to missing search operator");e+="?"+i.join("&"),window.top.restoreSession();let n={apicsrftoken:this.__apiCSRFToken};return window.fetch(e,{method:"GET",redirect:"manual",headers:n}).then((t=>{if(t.ok&&200==t.status)return t.json();throw this.showActionAlert("danger",this.__translations.OPERATION_FAILED),new Error("Failed to save participant in "+this.pc_eid+" with save data")})).then((t=>t&&t.hasOwnProperty("total")&&t.total<=0?(this.showActionAlert("info",this.__translations.SEARCH_RESULTS_NOT_FOUND),[]):(this.clearActionAlerts(),t.entry)))}showPrimaryScreen(){(this.container.querySelectorAll(".screen")||[]).forEach((t=>{t.classList.contains("primary-screen")?t.classList.remove("d-none"):t.classList.add("d-none")})),this.__currentScreen="primary-screen",this.updateParticipantControls()}updateParticipantControls(){if(this.__participantList.length<=0)return this.container.querySelector(".no-third-party-patient-row").classList.remove("d-none"),void this.container.querySelectorAll(".third-party-patient-row").forEach((t=>t.classList.add("d-none")));if(this.container.querySelector(".no-third-party-patient-row").classList.add("d-none"),this.container.querySelectorAll(".third-party-patient-row").forEach((t=>t.classList.remove("d-none"))),this.__updateParticipants){let t=this.container.querySelectorAll(".patient-participant");if(!t.length)return void console.error("Failed to find dom node with selector .patient-participant");let e=null;if(t.forEach((t=>{t.classList.contains("template")?e=t:t.remove()})),!e)return void console.error("Failed to find dom node with selector .patient-participant.template");this.__participantList.length&&this.__participantList.forEach((t=>{let i=e.cloneNode(!0);this.setNodeInnerText(i,".patient-name",t.callerName),this.setNodeInnerText(i,".patient-email",t.email),i.classList.remove("template"),i.classList.remove("d-none");let n=t.invitation||{},o=i.querySelector(".btn-invitation-copy"),s=i.querySelector(".btn-link-copy"),a=i.querySelector(".btn-generate-link");n?(a&&a.addEventListener("click",this.generatePatientLink.bind(this,t.id)),o.addEventListener("click",this.copyPatientInvitationToClipboard.bind(this)),s.addEventListener("click",this.copyPatientLinkToClipboard.bind(this)),s.dataset.inviteId=t.id,n.generated&&(s.classList.remove("d-none"),o.classList.remove("d-none")),this.setNodeInnerText(i,".patient-invitation-text",n.text||"")):(console.error("Failed to find invitation data for patient ",t),o.classList.add("d-none"),s.classList.add("d-none")),e.parentNode.appendChild(i)})),this.__updateParticipants=!1}}showNewPatientScreen(){this.showSecondaryScreen("create-patient")}showSearchPatientScreen(){this.showSecondaryScreen("search-patient")}showSecondaryScreen(t){let e="."+t,i=this.container.querySelector(".primary-screen");if(!i)return void console.error("Failed to find primary-screen selector for add-patient-dialog container");i.classList.add("d-none");let n=this.container.querySelector(e);n?n.classList.remove("d-none"):console.error("Failed to find selector for add-patient-dialog container "+e),this.__currentScreen=t}getInputValues(t,e){let i={};return e.forEach((e=>{let n=this.container.querySelector("."+t+' input[name="'+e+'"]');n?i[e]=n.value:(console.error("Failed to find input node with name "+e),i[e]=null)})),i}inviteSearchResultPatient(t){this.displaySearchList(!1),this.showActionAlert("info",this.__translations.PATIENT_INVITATION_PROCESSING),this.sendSaveParticipant({pid:t}).catch((t=>{console.error(t),this.showActionAlert("danger",this.__translations.OPERATION_FAILED),this.displaySearchList(!0)}))}displaySearchList(t){let e=".search-patient .search-patient-list",i=this.container.querySelector(e);i?t?i.classList.remove("d-none"):i.classList.add("d-none"):console.error("Failed to find ",e)}populateSearchResults(t){console.log("populatingSearchResults with result ",t);let e=".search-patient .search-patient-list",i=this.container.querySelector(e);if(!i)return void console.error("Failed to find ",e);i.classList.remove("d-none");let n=i.querySelector(".duplicate-match-row-template"),o=n.parentNode;o.replaceChildren(),o.appendChild(n),t.forEach((t=>{let e=t.resource,i=n.cloneNode(!0);i.classList.remove("duplicate-match-row-template"),o.appendChild(i);let s=(e.identifier||[]).find((t=>void 0!==t.type.coding.find((t=>"PT"==t.code)))),a=s.value||"";this.setNodeInnerText(i,".pid",a);let r=e.birthDate;r&&this.setNodeInnerText(i,".dob",r);let l=(e.name||[]).find((t=>"official"==t.use));l&&(this.setNodeInnerText(i,".fname",l.given.join(" ")),this.setNodeInnerText(i,".lname",l.family));let c=(e.telecom||[]).find((t=>"email"==t.system));c?this.setNodeInnerText(i,".email",c.value):i.classList.add("missing-email"),a&&i.querySelector(".btn-select-patient").addEventListener("click",(()=>{this.inviteSearchResultPatient(a)})),i.classList.remove("d-none")}))}setNodeInnerText(t,e,i){let n=t.querySelector(e);n?n.textContent=i:console.error("Failed to find node with selector "+e)}searchParticipantsAction(){let t=this.getInputValues("search-patient",["fname","lname","DOB","email","pid"]);this.toggleActionButton(!1),this.sendSearchResults(t).then((t=>{this.toggleActionButton(!0),t.length?this.populateSearchResults(t):(this.populateSearchResults([]),this.__translations.SEARCH_RESULTS_NOT_FOUND)})).catch((t=>{this.toggleActionButton(!0),console.error(t)}))}createPatientAction(){let t=this.getInputValues("create-patient",["fname","lname","DOB","email"]);this.clearActionAlerts(),this.showActionAlert("info",this.__translations.PATIENT_INVITATION_PROCESSING),this.toggleActionButton(!1),this.sendSaveParticipant(t).then((()=>{this.toggleActionButton(!0)})).catch((t=>{this.toggleActionButton(!0),console.error(t),this.showActionAlert("danger",this.__translations.OPERATION_FAILED)}))}toggleActionButton(t){this.container.querySelectorAll(".btn-create-patient,.btn-invite-search").forEach((e=>e.disabled=!t))}handleSaveParticipantErrorResponse(t){let e=[];t.fields?(t.fields.DOB&&e.push(this.__translations.PATIENT_CREATE_INVALID_DOB),t.fields.email&&e.push(this.__translations.PATIENT_CREATE_INVALID_EMAIL),(t.fields.fname||t.fields.lname)&&e.push(this.__translations.PATIENT_CREATE_INVALID_NAME),this.showActionAlert("danger",e.join(". "))):this.showActionAlert("danger",this.__translations.OPERATION_FAILED)}clearActionAlerts(){this.container.querySelectorAll(".alert").forEach((t=>{t.classList.contains("alert-template")?t.classList.add("d-none"):t.parentNode.removeChild(t)}))}showActionAlert(t,e){this.clearActionAlerts();let i=this.container.querySelector(".alert.alert-template"),n=i.cloneNode(!0);n.innerText=e,n.classList.remove("alert-template"),n.classList.remove("d-none"),n.classList.add("alert-"+t),i.parentNode.insertBefore(n,i),n.scrollIntoView()}setupModal(){let t="telehealth-container-invite-patient",e=document.getElementById(t),i=e.cloneNode(!0);i.id=t+"-"+this.__idx++,e.parentNode.appendChild(i),this.container=i,this.modal=new bootstrap.Modal(this.container,{keyboard:!1,focus:!0,backdrop:"static"}),this.addActionToButton(".btn-telehealth-confirm-cancel",this.cancelDialog.bind(this)),this.addActionToButton(".btn-show-new-patient-screen",this.showNewPatientScreen.bind(this)),this.addActionToButton(".btn-show-search-patient-screen",this.showSearchPatientScreen.bind(this)),this.addActionToButton(".btn-cancel-screen-action",this.showPrimaryScreen.bind(this)),this.addActionToButton(".btn-create-patient",this.createPatientAction.bind(this)),this.addActionToButton(".btn-invite-search",this.searchParticipantsAction.bind(this)),this.__updateParticipants=!0,this.updateParticipantControls()}copyPatientLinkToClipboard(t){let e=t.currentTarget;if(!e)return void console.error("Failed to get a dom node cannot proceed with copy");let i=e.dataset.inviteId;if(!i)return console.error("Failed to find patient id to copy link for patient"),void this.showActionAlert("danger",this.__translations.CLIPBOARD_COPY_FAILURE);let n=this.__participantList.find((t=>t.id==i));if(n){let t=n.invitation||{};this.copyTextToClipboard(t.link||"")}else this.showActionAlert("danger",this.__translations.CLIPBOARD_COPY_FAILURE)}sendGeneratePatientLink(t){let e={pc_eid:this.pc_eid,pid:t},i=this.scriptLocation+"?action=generate_participant_link";return window.top.restoreSession(),window.fetch(i,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),redirect:"manual"}).then((t=>{if(400==t.status||401==t.status||t.ok&&200==t.status)return t.json();throw new Error("Failed to generate participant link for participant "+this.pid+" with save data for session "+this.pc_eid)}))}generatePatientLink(t,e){e.currentTarget,this.clearActionAlerts(),this.showActionAlert("info",this.__translations.PATIENT_INVITATION_PROCESSING),this.toggleActionButton(!1),this.sendGeneratePatientLink(t).then((e=>{if(this.toggleActionButton(!0),this.clearActionAlerts(),e.success){let i=e.invitation,n=this.__participantList.find((e=>e.id==t));n?(n.invitation=i,this.__updateParticipants=!0,this.updateParticipantControls(),this.showActionAlert("success",this.__translations.PATIENT_INVITATION_GENERATED)):this.showActionAlert("danger",this.__translations.PATIENT_INVITATION_FAILURE)}else this.showActionAlert("danger",this.__translations.PATIENT_INVITATION_FAILURE)})).catch((t=>{console.error(t),this.showActionAlert("danger",this.__translations.PATIENT_INVITATION_FAILURE)}))}copyPatientInvitationToClipboard(t){let e=t.target;if(!e)return void console.error("Failed to get a dom node cannot proceed with copy");let i=e.closest(".patient-participant[data-pid]");if(!i)throw this.showActionAlert("danger",this.__translations.CLIPBOARD_COPY_FAILURE),new Error("Failed to find patient to copy invitation");let n=i.querySelector(".patient-invitation-text");if(!n)throw this.showActionAlert("danger",this.__translations.CLIPBOARD_COPY_FAILURE),new Error("Failed to find invitation text with selector .patient-invitation-text");let o=n.textContent;this.copyTextToClipboard(o)}copyTextToClipboard(t){navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(t).then((()=>{this.showActionAlert("success",this.__translations.CLIPBOARD_COPY_SUCCESS)})).catch((t=>{console.error(t),this.showActionAlert("danger",this.__translations.CLIPBOARD_COPY_FAILURE)})):(console.error("clipboard.writeText does not exist"),this.showActionAlert("danger",this.__translations.CLIPBOARD_COPY_FAILURE))}addActionToButton(t,e){let i=this.container.querySelectorAll(t);for(var n=0;n<i.length;n++)i[n].addEventListener("click",e)}show(){this.modal||this.setupModal(),this.modal.show()}destruct(){this.modal=null,this.container.parentNode.removeChild(this.container),this.container=null}}class C{__isMinimized=!1;container=null;participantList=null;videoBar=null;minimizedConferenceNode=null;defaultPosition="bottom-right";initialOffset=null;constructor(t,e){this.container=t,this.defaultPosition=e.defaultPosition||"bottom-right",e.offset&&(this.initialOffset=e.offset)}isMinimized(){return this.__isMinimized}resetConferenceVideoBar(t){this.videoBar&&(this.videoBar.destruct(),this.videoBar=null);let e=this.minimizedConferenceNode.querySelector(".telehealth-button-bar");return this.videoBar=new n(e,t),this.videoBar}minimizeConferenceRoom(t){let e="minimized-telehealth-video-template",i=this.container.querySelector("."+e);if(!i)throw new Error("Failed to find template node with class ."+e);let n=i.cloneNode(!0);n.id="minimized-telehealth-video",n.classList.remove("d-none"),n.classList.remove(e),n.classList.add(this.defaultPosition),window.document.body.appendChild(n),this.minimizedConferenceNode=n,this.participantList=this.container.querySelector(".participant-list-container"),n.prepend(this.participantList),this.participantList.dataset.classMinimize&&(this.participantList.className=this.participantList.dataset.classMinimize),this.initialOffset&&window.setInteractorPosition&&window.setInteractorPosition(this.initialOffset.top,this.initialOffset.left,this.minimizedConferenceNode),window.initDragResize&&window.initDragResize(),this.__isMinimized=!0}getCurrentOffset(){let t=0,e=0;return t=this.minimizedConferenceNode.dataset.x,e=this.minimizedConferenceNode.dataset.y,{top:t,left:e}}maximizeConferenceRoom(){var t=this.container.querySelector(".sidebar");if(this.participantList&&t){var e=this.minimizedConferenceNode;this.videoBar.destruct(),t.appendChild(this.participantList),this.participantList.dataset.classMaximize&&(this.participantList.className=this.participantList.dataset.classMaximize),e&&e.parentNode&&e.parentNode.removeChild(e),this.minimizedConferenceNode=null}else console.error("Failed to find remote video or remote video container");this.__isMinimized=!1}destruct(){this.participantList=null,this.container=null;let t=document.getElementById("minimized-telehealth-video");t&&t.parentNode&&t.parentNode.removeChild(t),this.__isMinimized=!1}}class b{__container=null;__localVideoElement=null;__selectCallbacks=[];__localParticipant=null;__isPinned=!1;constructor(t,e){this.__container=t,this.__localVideoElement=t.querySelector(".local-video"),this.__selectCallbacks=[],this.__isPinned=!1,this.__localParticipant=e,t.addEventListener("click",this.handleSelectEvent.bind(this))}attach(t){this.__localVideoElement.srcObject=t,this.__localVideoElement.play().catch((t=>{console.error("Failed to play local video error object ",t)}))}getRemotePartyId(){return this.__localParticipant?this.__localParticipant.uuid:null}getParticipant(){return this.__localParticipant}getCurrentCallStream(){return this.__localVideoElement?this.__localVideoElement.srcObject:null}setMuted(t){this.__localVideoElement.muted=!0}hasMediaStream(){return this.__localVideoElement&&null!=this.__localVideoElement.srcObject}stop(){this.__localVideoElement&&(this.__localVideoElement.pause(),this.__localVideoElement.srcObject=null)}hide(){this.__container.classList.add("d-none")}show(){this.__container.classList.remove("d-none")}handleSelectEvent(t){this.__selectCallbacks.forEach((t=>t(this)))}addCallerSelectListener(t){this.__selectCallbacks.push(t)}setPinnedStatus(t){this.__isPinned=t,t?this.__container.classList.add("pinned"):this.__container.classList.remove("pinned")}isPinned(){return this.__isPinned}}function w(t,i,o,a){let r=this;function l(t,e,i,n){e?(t.classList.add(i),t.classList.remove(n)):(t.classList.add(n),t.classList.remove(i))}this.apiCSRFToken=t,this.waitingRoomTemplate=null,this.conferenceRoomTemplate=null,this.callerSettings=null,this.features=i,this.telehealthSessionData=null,this.videoBar=null,this.ROOM_TYPE_WAITING="waiting",this.ROOM_TYPE_CONFERENCE="conference",this.dbThresholdSetting=-45,this.buttonSettings={microphoneEnabled:!0,cameraEnabled:!0,screensharingEnabled:!1},this.roomNode=null,this.sessionUpdatePollingTime=5e3,this.sessionControlsActiveTime=500,this.sessionControlsIdleTime=5e3,this.lastActiveDate=null,this.room=null,this.roomModal=null,this.inSession=!1,this.__minimizedConferenceRoom=null,this.sessionUpdateInterval=null,this.sessionControlsActiveInterval=null,this.__hasLocalPermisions=!1,this.__bridge=null,this.__localCallSlot=null,this.__slots=[],this.__localCaller=null,this.__remoteCaller=null,this.__remoteCallSlot=null,this.__isShutdown=!0,this.__callerIdx=0,this.__maxSlots=3,this.__presentationScreen=null,this.__focusCallerUuid=null,this.__pinnedCallerUuid=null,this.isMinimized=function(){return!!this.__minimizedConferenceRoom&&this.__minimizedConferenceRoom.isMinimized()},this.allocateSlot=function(t,e){if(!t.getUserData()){let n=!0,o=this.__slots.length;for(var i=0;i<o;i++)if(this.__slots[i].isAvailableForCall(t)){this.__slots[i].attach(t,e,this.getParticipantForCall(t)),n=!1;break}if(n&&o<=this.__maxSlots){let i=new s("participant-list-container",this.__callerIdx++);i.addCallerSelectListener((function(t){r.togglePinnedCallerId(t.getRemotePartyId()),r.updateParticipantDisplays()})),this.__slots.push(i),o++,i.attach(t,e,this.getParticipantForCall(t))}1==o&&this.setCurrentCallerFocusId(t.getRemotePartyId()),this.updateParticipantDisplays()}},this.updateParticipantDisplays=function(){if(this.__isShutdown)return;let t=!1,e=this.__slots.length<=1,i=this.isMinimized(),n=this.__pinnedCallerUuid||this.__focusCallerUuid||null;for(var o=0;o<this.__slots.length;o++)this.__slots[o].getRemotePartyId()==n?(t=!0,this.__presentationScreen.attach(this.__slots[o]),e&&!i?this.__slots[o].hide():this.__slots[o].show()):i&&this.__slots[o].getRemotePartyId()==this.getLocalPartyId()?this.__slots[o].hide():this.__slots[o].show();this.__localCallSlot&&(i?this.__localCallSlot.hide():this.__localCallSlot.show()),t||(this.__localCallSlot.getRemotePartyId()==n?this.__presentationScreen.attach(this.__localCallSlot):this.__presentationScreen.detach()),this.hasRemoteParticipants()||this.__isShutdown||this.toggleRemoteVideo(!1),this.__slots.length?this.buttonSettings.screensharingEnabled=!0:this.buttonSettings.screensharingEnabled=!1,this.resetConferenceVideoBar()},this.isAuthorizedParticipant=function(t){return void 0!==(this.callerSettings.participantList||[]).find((e=>e.uuid==t))},this.getRemoteParticipantList=function(){return(this.callerSettings.participantList||[]).filter((t=>t.uuid!==r.callerSettings.callerUuid))},this.getLocalParticipant=function(){return this.findParticipantForId(r.callerSettings.callerUuid)},this.getParticipantForCall=function(t){return this.findParticipantForId(t.getRemotePartyId())},this.findParticipantForId=function(t){return(this.callerSettings.participantList||[]).find((e=>e.uuid==t))},this.setParticipantInCallRoomStatus=function(t,e){if(this.__isShutdown)return;e="Y"==e?"Y":"N";let i=((this.callerSettings||{}).participantList||[]).find((e=>e.uuid==t));i?i.inRoom=e:console.error("participant was not found in participant list for callerId "+t)},this.getLocalPartyId=function(){return r.callerSettings.callerUuid},this.findCallerSlotWithId=function(t){return t==this.callerSettings.callerUuid?this.__localCallSlot:this.__slots.find((e=>e.getRemotePartyId()===t))},this.togglePinnedCallerId=function(t){if(this.__pinnedCallerUuid){let t=this.findCallerSlotWithId(this.__pinnedCallerUuid);t&&t.isPinned()&&t.setPinnedStatus(!1)}if(t!=this.__pinnedCallerUuid){let e=this.findCallerSlotWithId(t);e?(this.__pinnedCallerUuid=t,e.setPinnedStatus(!0),this.setCurrentCallerFocusId(t)):console.error("Failed to find pinned caller slot with uuid "+t)}else this.__pinnedCallerUuid=null},this.setCurrentCallerFocusId=function(t){this.__focusCallerUuid=t},this.getCurrentCallerFocusId=function(){return this.__focusCallerUuid},this.restartMediaStream=function(){return r.__localCallSlot.hasMediaStream()&&r.__bridge.closeLocalMediaStream(),r.__bridge.getLocalMediaStream().then((t=>r.handleLocalMediaStreamStarted(t))).catch((t=>r.handleLocalMediaStreamFailed(t)))},this.handleLocalMediaStreamStarted=function(t){return r.__localCallSlot.attach(t),r.__hasLocalPermisions=!0,r.toggleJoinButton(r.shouldEnableJoinButton()),r.togglePermissionBox(!1),r.__hasLocalPermisions},this.handleLocalMediaStreamFailed=function(t){return console.error(t),r.__hasLocalPermisions=!1,r.toggleJoinButton(r.shouldEnableJoinButton()),r.togglePermissionBox(!0),r.__hasLocalPermisions},this.startBridge=function(){r.__localCallSlot=new b(document.getElementById("local-video-container"),this.getLocalParticipant()),r.__localCallSlot.setMuted(!0),r.__bridge=new f(r.callerSettings.callerUuid,r.callerSettings.apiKey,r.callerSettings.serviceUrl);let t={onincomingcall:r.handleIncomingCall.bind(r),onbridgeactive:t=>{r.restartMediaStream()},onbridgeinactive:t=>{r.__localCallSlot&&r.__localCallSlot.stop()},onbridgefailure:t=>{r.__localCallSlot&&r.__localCallSlot.stop(),alert(o.BRIDGE_FAILED)}};r.__bridge.startBridge(t),r.__isShutdown=!1},this.setCallHandlers=function(t){t.oncallstarted=t=>{r.handleCallStartedEvent(t)},t.onstreamupdated=(t,e)=>{console.log("onstreamupdated "+r.callerSettings.calleeUuid),r.allocateSlot(t,e)},t.oncallended=t=>{r.handleCallEndedEvent(t)},t.isScreenSharing()||t.attachActivityMonitor(r.dbThresholdSetting,(t=>{r.handleActivityEvent(t)}))},this.makeCall=function(t){const e=r.__bridge.createVideoCall(t);return r.setCallHandlers(e),e.oncallrejected=t=>{console.log(t),console.log("oncallrejected "+r.callerSettings.calleeUuid),r.handleCallEndedEvent(t)},e.start().catch((t=>{alert(o.CALL_CONNECT_FAILED),console.log("call exception "+r.callerSettings.calleeUuid),console.error(t),r.handleCallEndedEvent(e)})),e},this.makeScreenshareCall=function(t){r.__bridge.createScreenSharingCall(t).catch((t=>{alert(o.CALL_CONNECT_FAILED),console.log("call exception "+r.callerSettings.calleeUuid),console.error(t)}))},this.enableMicrophone=function(t){r.__bridge.enableMicrophone(t)},this.enableCamera=function(t){r.__bridge.enableCamera(t)},this.hasLocalPermissionsEnabled=function(){return r.__hasLocalPermisions},this.canReceiveCall=function(t){let e=t.getRemotePartyId();return this.isAuthorizedParticipant(e)?Promise.resolve({call:t,canCall:!0}):Promise.resolve({call:t,canCall:!1})},this.getRemoteScriptLocation=function(){return a},this.getTelehealthLaunchData=function(t){var e=this.getRemoteScriptLocation()+"?action=get_telehealth_launch_data&eid="+encodeURIComponent(t.pc_eid);return window.top.restoreSession(),window.fetch(e,{redirect:"manual"})},this.setupProviderWaitingRoom=function(){let t=this.createModalWithContent(r.waitingRoomTemplate),e=document.getElementById("telehealth-container");r.initWaitingRoomEvents(e),r.roomModal=t,r.roomModal.show()},this.setupWaitingRoom=function(){r.setupProviderWaitingRoom()},this.handleIncomingCall=function(t){this.canReceiveCall(t).then((t=>{if(!t.canCall)return console.log("Call from "+t.call.getRemotePartyId()+" not authorized by server for "+r.callerSettings.callerUuid),void t.call.reject();r.setCallHandlers(t.call),t.call.accept(),console.log("Call accepted from "+t.call.getRemotePartyId()+" for "+r.callerSettings.callerUuid),r.toggleRemoteVideo(!0),r.setParticipantInCallRoomStatus(t.call.getRemotePartyId(),"Y")})).catch((e=>{t.reject()}))},this.init=function(t){t.pc_eid?(r.updateTelehealthFullVH(),window.addEventListener("resize",r.updateTelehealthFullVH),r.telehealthSessionData=t,r.getTelehealthLaunchData(t).then((function(t){if(!t.ok||200!=t.status)throw new Error("Failed to fetch data");return t.json()})).then((t=>{r.inSession=!0,r.callerSettings=t.callerSettings,r.setCurrentCallerFocusId(t.callerSettings.calleeUuid),r.waitingRoomTemplate=t.waitingRoom,r.conferenceRoomTemplate=t.conferenceRoom,r.setupWaitingRoom(),r.startBridge(),r.room=r.ROOM_TYPE_WAITING})).catch((function(t){console.error(t),r.__bridge||(alert(o.SESSION_LAUNCH_FAILED),r.destruct())}))):alert(o.SESSION_LAUNCH_FAILED)},this.cleanupSlots=function(){this.__slots.forEach((t=>{try{t.destruct()}catch(t){console.error("Failed to cleanup slot ",t)}})),this.__slots=[]},this.destruct=function(){if(this.__isShutdown)return void console.log("destruct called multiple times while application has already shutdown.  Ignoring");r.inSession=!1,r.waitingRoomTemplate=null,r.conferenceRoomTemplate=null,r.videoBar&&(r.videoBar.destruct(),r.videoBar=null),r.room==r.ROOM_TYPE_WAITING||(r.room,r.ROOM_TYPE_CONFERENCE),null!==r.sessionUpdateInterval&&(clearInterval(r.sessionUpdateInterval),r.sessionUpdateInterval=null),null!==r.sessionControlsActiveInterval&&(clearInterval(r.sessionControlsActiveInterval),r.sessionControlsActiveInterval=null),r.roomNode&&(r.cleanupParticipantActiveEvents(),r.roomNode=null);let t=document.getElementById("telehealth-container");if(r.cleanupSlots(),r.__bridge&&r.__bridge.shutdown)try{r.__bridge.shutdown()}catch(t){console.error(t)}t&&t.parentNode&&t.parentNode.removeChild(t),r.isMinimized()&&(this.__minimizedConferenceRoom.destruct(),this.__minimizedConferenceRoom=null),window.removeEventListener("resize",r.updateTelehealthFullVH),r.callerSettings=null,r.telehealthSessionData=null,r.__isShutdown=!0},this.updateTelehealthFullVH=function(){let t=window.innerHeight-1;document.documentElement.style.setProperty("--telehealth-full-vh",`${t}px`)},this.initModalEvents=function(t){for(var e=document.getElementsByClassName("btn-telehealth-provider-close"),i=0;i<e.length;i++)e[i].addEventListener("click",r.handleCallHangup)},this.initWaitingRoomEvents=function(t){r.videoBar=new n(t,r.getWaitingRoomVideoBarSettings()),r.toggleJoinButton(r.shouldEnableJoinButton())},this.togglePermissionBox=function(t){let e=document.querySelector("#telehealth-container .permissions-box"),i=document.querySelector("#telehealth-container .permissions-box .restart-media-btn");e&&i?t?(i.addEventListener("click",r.recaptureLocalMedia),e.classList.remove("d-none")):(e.classList.add("d-none"),i.removeEventListener("click",r.recaptureLocalMedia)):console.error("Could not find permissions box dom nodes")},this.recaptureLocalMedia=function(){r.__bridge&&!r.__bridge.isShutdown&&r.__bridge.shutdown(),r.startBridge()},this.shouldEnableJoinButton=function(){return r.hasLocalPermissionsEnabled()},this.toggleJoinButton=function(t){let e=document.querySelectorAll(".btn-comlink-conference-join");if(e&&e.length)for(let i=0;i<e.length;i++)t?(e[i].addEventListener("click",r.startConferenceRoom),e[i].classList.remove("disabled"),e[i].classList.remove("btn-primary"),e[i].classList.add("btn-success"),e[i].disabled=!1):(e[i].removeEventListener("click",r.startConferenceRoom),e[i].classList.add("disabled"),e[i].classList.remove("btn-success"),e[i].classList.add("btn-primary"),e[i].disabled=!0)},this.sessionClose=function(){let t=this;t.isMinimized()?t.destruct():(jQuery("#telehealth-container").on("hidden.bs.modal",(function(){jQuery("#telehealth-container").off("hidden.bs.modal"),t.destruct()})),t.roomModal.hide())},this.confirmSessionClose=function(){r.room==r.ROOM_TYPE_WAITING?r.sessionClose():new e(o,r.telehealthSessionData.pc_eid,r.getRemoteScriptLocation(),(function(){r.sessionClose()})).show()},this.shutdownProviderWaitingRoom=function(){let t=document.getElementById("telehealth-container");if(r.__bridge&&r.__bridge.shutdown)try{r.__bridge.shutdown()}catch(t){console.error(t)}t&&t.parentNode&&t.parentNode.removeChild(t),r.callerSettings=null,r.telehealthSessionData=null},this.createModalWithContent=function(t){let e=window.document.createElement("div");e.innerHTML='<div class="modal fade pl-0" id="telehealth-container" tabindex="-1" aria-hidden="true">\n              <div class="modal-dialog mw-100 ml-2 mr-2 mt-0 mt-md-1 mt-lg-2 mb-0">\n                <div class="modal-content">\n                  <div class="modal-header pt-2 pt-md-3 pb-2 pb-md-3">\n                    <h5 class="modal-title">'+jsText(o.TELEHEALTH_MODAL_TITLE)+`</h5>\n                    <button type="button" class="close btn-telehealth-provider-close" aria-label="Close">\n                      <span aria-hidden="true">&times;</span>\n                    </button>\n                  </div>\n                  <div class="modal-body d-flex">\n                  ${t}\n                  </div>\n                </div>\n              </div>\n            </div>`,window.document.body.appendChild(e.firstElementChild);var i=document.getElementById("telehealth-container");return r.roomModal=new bootstrap.Modal(i,{keyboard:!1,focus:!0,backdrop:"static"}),r.initModalEvents(i),r.roomModal},this.startConferenceRoom=function(){r.startProviderConferenceRoom()},this.startProviderConferenceRoom=function(){let t=document.getElementById("telehealth-container");r.videoBar.destruct();let e=t.querySelector(".modal-body");do{e.removeChild(e.firstChild)}while(e.childNodes.length);if(e.innerHTML=r.conferenceRoomTemplate,r.roomNode=e.querySelector(".conference-room"),!r.roomNode)return console.error("Failed to find node with selector .conference-room from received data"),alert(o.SESSION_LAUNCH_FAILED),void r.sessionClose();r.roomNode.classList.add("active");let i=new b(t.querySelector(".local-participant"),this.getLocalParticipant());i.attach(this.__localCallSlot.getCurrentCallStream()),i.addCallerSelectListener((t=>{r.togglePinnedCallerId(t.getRemotePartyId()),r.updateParticipantDisplays()})),this.__localCallSlot=i,r.videoBar=new n(this.getVideoBarContainer(),r.getFullConferenceVideoBarSettings()),r.inConferenceRoom=!0,r.room=r.ROOM_TYPE_CONFERENCE,this.sessionUpdateInterval=setInterval(r.updateConferenceRoomSession.bind(r),r.sessionUpdatePollingTime),this.__presentationScreen=new S("presentation-screen"),this.sessionControlsActiveInterval=setInterval(r.updateSessionControlsActive.bind(r),r.sessionControlsActiveTime),r.setupParticipantMinimizeControls(t),r.setupParticipantActiveEvents(t),r.updateConferenceRoomSession()},r.updateSessionControlsActive=function(){if(!r.sessionControlsActiveInterval||r.__isShutdown)return;let t=new Date,e=r.lastActiveDate;e&&t.getTime()-e.getTime()>r.sessionControlsIdleTime&&(r.roomNode.classList.remove("active"),r.roomNode.classList.add("idle"),r.lastActive=null)},r.setupParticipantActiveEvents=function(){r.lastActiveDate=new Date,r.roomNode.addEventListener("mousemove",r.updateActive);let t=r.roomNode.querySelector(".remote-video-container");t?t.addEventListener("click",r.updateActive):console.error("Failed to find node with selector '.remote-video-container'")},r.cleanupParticipantActiveEvents=function(){r.roomNode&&r.roomNode.removeEventListener("mousemove",r.updateActive)},r.updateActive=function(){r.lastActiveDate=new Date,r.roomNode&&(r.roomNode.classList.remove("idle"),r.roomNode.classList.add("active"))},r.toggleSidebar=function(){if(r.roomNode){let t=r.roomNode.querySelector(".sidebar");t.classList.contains("minimized")?(t.classList.remove("minimized"),t.classList.add("maximized")):(t.classList.add("minimized"),t.classList.remove("maximized"))}},r.setupParticipantMinimizeControls=function(t){let e=t.querySelector(".btn-list-minimize");e?(e.addEventListener("click",r.toggleSidebar),window.matchMedia("(max-width: 400px)").matches&&r.toggleSidebar()):console.error("Failed to find minimize button with selector .btn-list-minimize")},this.updateLocalParticipantList=function(){let t=r.telehealthSessionData.pc_eid;window.top.restoreSession(),window.fetch(r.getRemoteScriptLocation()+"?action=get_participant_list&pc_eid="+encodeURIComponent(t),{redirect:"manual"}).then((t=>{if(t.ok)return t.json();throw new Error("Failed to receive valid server response from get_participant_list")})).then((t=>{this.callerSettings.participantList=t.participantList})).catch((t=>console.error("Failed to update local participant list. Third party invitations may not be up to date",t)))},this.updateConferenceRoomSession=function(){let t=(r.callerSettings.appointment||{}).eid||{};window.top.restoreSession(),window.fetch(r.getRemoteScriptLocation()+"?action=conference_session_update&pc_eid="+encodeURIComponent(t),{redirect:"manual"}).then((t=>{if(t.ok)return t.json();throw new Error("Failed to update session")})).then((t=>{if(r.sessionUpdateInterval){if("success"!==t.status)throw new Error("Failed to update session");r.__isShutdown,(t.participantList||[]).some((t=>void 0===this.callerSettings.participantList.find((e=>e.role==t.role&&e.id==t.id))))&&this.updateLocalParticipantList()}})).catch((t=>console.error("Conference session update ",t)))},this.cancelConferenceRoomSessionUpdateInterval=function(){r.sessionUpdateInterval&&window.clearInterval(r.sessionUpdateInterval)},this.getDefaultVideoBarSettings=function(){var t=function(){};return{notes:!1,notesCallback:t,microphone:r.buttonSettings.microphoneEnabled,microphoneCallback:r.toggleMicrophone.bind(r),video:r.buttonSettings.cameraEnabled,videoCallback:r.toggleVideo.bind(r),expand:!1,expandCallback:t,hangup:!1,hangupCallback:t,screenshare:r.buttonSettings.screensharingEnabled,screenshareCallback:r.toggleScreenSharing.bind(r)}},this.getWaitingRoomVideoBarSettings=function(){return r.getDefaultVideoBarSettings()},this.getMinimizedConferenceVideoBarSettings=function(){let t=r.getDefaultVideoBarSettings();return t.expandCallback=r.maximizeProviderConferenceCall.bind(r),t.hangupCallback=r.handleCallHangup.bind(r),t.expand=!0,t.notes=!1,t.hangup=!0,r.addSettingsForScreenshare(t),t},this.addSettingsForScreenshare=function(t){t.screenshare=!1,this.__slots.length&&window&&window.navigator&&window.navigator.mediaDevices&&window.navigator.mediaDevices.getDisplayMedia&&(t.screenshare=!0)},this.addSettingsForThirdPartyInvitations=function(t){r.features&&r.features.thirdPartyInvitations?(t.invite=!0,t.inviteCallback=r.handleInviteCallback.bind(r)):t.invite=!1},this.getFullConferenceVideoBarSettings=function(){let t=r.getDefaultVideoBarSettings();return t.hangupCallback=r.handleCallHangup.bind(r),t.notesCallback=r.minimizeProviderConferenceCall.bind(r),t.expand=!1,t.notes=!0,t.hangup=!0,r.addSettingsForThirdPartyInvitations(t),r.addSettingsForScreenshare(t),t},this.handleInviteCallback=function(){new v(this.apiCSRFToken,o,r.telehealthSessionData.pc_eid,r.getRemoteScriptLocation(),comlink.settings.fhirPath,r.callerSettings.participantList,(function(t){t&&(r.callerSettings=t)})).show()},this.handleCallStartedEvent=function(t){r.toggleRemoteVideo(!0)},this.resetConferenceVideoBar=function(){r.videoBar&&r.videoBar.destruct(),r.__isShutdown||(this.isMinimized()?r.videoBar=this.__minimizedConferenceRoom.resetConferenceVideoBar(r.getMinimizedConferenceVideoBarSettings()):r.videoBar=new n(this.getVideoBarContainer(),r.getFullConferenceVideoBarSettings()))},this.getVideoBarContainer=function(){return document.getElementById("telehealth-container").querySelector(".conference-room .telehealth-button-bar")},this.removeCallFromConference=function(t){if(null!=t.getUserData()){let e=t.getUserData();t.isScreenSharing()?e.detachScreenshare():(this.removeSlotForCall(t),r.setParticipantInCallRoomStatus(t.getRemotePartyId(),"N")),this.updateParticipantDisplays()}},this.removeSlotForCall=function(t){if(null!=t.getUserData()){let e=t.getUserData(),i=e.getRemotePartyId();e.destruct(),this.__slots=this.__slots.filter((t=>t!==e)),i==this.__pinnedCallerUuid&&this.togglePinnedCallerId(i),this.__slots.length&&this.getCurrentCallerFocusId()==i&&this.setCurrentCallerFocusId(this.__slots[0].getRemotePartyId())}},this.hasRemoteParticipants=function(){return this.__slots.length>0},this.handleCallEndedEvent=function(t){r.removeCallFromConference(t)},this.handleActivityEvent=function(t){this.setCurrentCallerFocusId(t.getRemotePartyId()),this.updateParticipantDisplays()},this.handleCallHangup=function(){r.isMinimized()&&r.maximizeProviderConferenceCall({}),r.confirmSessionClose()},this.minimizeProviderConferenceCall=function(){let t=document.getElementById("telehealth-container"),e=this.features.minimizeWindow||{enabled:!0,defaultPosition:"bottom-left"};this.__minimizedConferenceRoom=new C(t,e),this.__minimizedConferenceRoom.minimizeConferenceRoom(this.getMinimizedConferenceVideoBarSettings()),this.resetConferenceVideoBar(),r.roomModal.hide(),this.updateParticipantDisplays()},this.maximizeProviderConferenceCall=function(t){this.isMinimized()&&(this.features.minimizeWindow&&(this.features.minimizeWindow.offset=this.__minimizedConferenceRoom.getCurrentOffset()),this.__minimizedConferenceRoom.maximizeConferenceRoom(),this.__minimizedConferenceRoom.destruct(),this.__minimizedConferenceRoom=null,r.roomModal?r.roomModal.show():console.error("Failed to find roomModal")),this.updateParticipantDisplays()},this.toggleMicrophone=function(t){let e=t.target;e.classList.contains("fa")||(e=e.querySelector(".fa"));let i=!r.buttonSettings.microphoneEnabled;r.buttonSettings.microphoneEnabled=i,e.dataset.enabled=i,r.__bridge&&r.__bridge.enableMicrophone?r.__bridge.enableMicrophone(i):console.error("__bridge is not initalized and cannot toggle microphone"),l(e,i,"fa-microphone","fa-microphone-slash")},this.toggleVideo=function(t){let e=t.target;e.classList.contains("fa")||(e=e.querySelector(".fa"));let i=!r.buttonSettings.cameraEnabled;r.buttonSettings.cameraEnabled=i,e.dataset.enabled=i,r.__bridge&&r.__bridge.enableCamera?r.__bridge.enableCamera(i):console.error("app is not initalized and cannot toggle microphone"),l(e,i,"fa-video","fa-video-slash")},this.toggleRemoteVideo=function(t){var e=document.getElementById("telehealth-container").querySelector(".waiting-container");t?(e.classList.add("d-none"),this.__presentationScreen.show()):(e.classList.remove("d-none"),this.__presentationScreen.hide())},this.toggleScreenSharing=function(t){let e=this.getRemoteParticipantList().filter((t=>"Y"==t.inRoom)).map((t=>t.uuid));this.makeScreenshareCall(e)}}function I(t,e,i,n){let o=new w(t,e,i,n),s=o.destruct,a=null,r=null,l=!1;function c(){let t=o.telehealthSessionData.pc_eid;window.top.restoreSession(),window.fetch(n+"?action=patient_appointment_ready&eid="+encodeURIComponent(t),{redirect:"manual"}).then((t=>{if(t.ok)return t.json();throw new Error("Failed to get response back from server")})).then((t=>{if(!o.__shutdown&&a&&t.session){if(l="1"===t.session.providerReady,t.session.participantList){o.callerSettings.participantList=t.session.participantList;let e=o.callerSettings.participantList.find((t=>"provider"==t.role));if(!e)throw new Error("No provider in participant list.  Provider is not ready and cannot continue");o.callerSettings.calleeUuid=e.uuid,o.setCurrentCallerFocusId(e.uuid)}o.toggleJoinButton(o.shouldEnableJoinButton())}})).catch((t=>{let e=document.querySelector(".waiting-room-server-communication");e&&e.classList.remove("d-none"),console.log("Waiting room communication error",t)}))}return o.getFullConferenceVideoBarSettings=function(){let t=o.getDefaultVideoBarSettings();return t.hangupCallback=o.handleCallHangup.bind(o),t.expand=!1,t.notes=!1,t.invite=!1,t.hangup=!0,o.addSettingsForScreenshare(t),t},o.startConferenceRoom=function(){o.stopProviderReadyCheck(),o.startProviderConferenceRoom();let t=o.getRemoteParticipantList();t&&t.forEach((t=>{"Y"==t.inRoom&&o.makeCall(t.uuid)}))},o.canReceiveCall=function(t){let e=t.getRemotePartyId();console.log("Received call ",t);let i=o.isAuthorizedParticipant(e);return Promise.resolve({call:t,canCall:i})},o.handleCallEndedEvent=function(t){try{let e=null;null!=t.getUserData()&&(e=t.getUserData().getRemotePartyId(),o.removeCallFromConference(t))}catch(t){console.error("Failed to remove call on call ended event",t)}o.inSession&&!o.hasProviderParticipant()&&(o.buttonSettings.screensharingEnabled=!1,alert(i.HOST_LEFT),o.replaceConferenceRoomWithWaitingRoom(),o.cancelConferenceRoomSessionUpdateInterval())},o.hasProviderParticipant=function(){return void 0!==o.findCallerSlotWithId(o.callerSettings.calleeUuid)},o.replaceConferenceRoomWithWaitingRoom=function(){o.cleanupSlots(),o.telehealthSessionData,o.roomModal;var t=document.getElementById("telehealth-container"),e=t.querySelector(".modal-body"),i=document.getElementById("local-video");o.videoBar.destruct(),e.innerHTML=o.waitingRoomTemplate;var n=document.getElementById("local-video");n?(n.parentNode.replaceChild(i,n),l=!1,o.initWaitingRoomEvents(t),r=setTimeout((function(){o.startProviderReadyCheck()}),5e3)):console.error("Failed to find child video to replace")},o.handleCallHangup=function(){(o.room==o.ROOM_TYPE_WAITING||confirm(i.CONFIRM_SESSION_CLOSE))&&o.sessionClose()},o.setWaitingRoomModal=function(t){o.roomModal=t},o.setupWaitingRoom=function(){o.setupProviderWaitingRoom(),o.startProviderReadyCheck()},o.clearHostDelayTimeout=function(){r&&(clearTimeout(r),r=null)},o.destruct=function(){o.clearHostDelayTimeout(),o.stopProviderReadyCheck(),window.dlgclose&&window.dlgclose(),s.bind(o)()},o.stopProviderReadyCheck=function(){o.clearHostDelayTimeout(),a&&(clearInterval(a),a=null)},o.startProviderReadyCheck=function(){a=setInterval(c,2e3)},o.shouldEnableJoinButton=function(){return l&&o.hasLocalPermissionsEnabled()},o}!function(e,i,n,o){let s=!1;i.settings=i.settings||{};let a=i.settings.modulePath||"/interface/modules/custom_modules/oe-module-comlink-telehealth/",r=null,l=i.translations||{CALL_CONNECT_FAILED:"Failed to connect the call.",SESSION_LAUNCH_FAILED:"There was an error in launching your telehealth session.  Please try again or contact support",APPOINTMENT_STATUS_UPDATE_FAILED:"There was an error in saving the telehealth appointment status.  Please contact support or update the appointment manually in the calendar",DUPLICATE_SESSION:"You are already in a conference session.  Please hangup the current call to start a new telehealth session",HOST_LEFT:"Host left the call",CONFIRM_SESSION_CLOSE:"Are you sure you want to close this session?",TELEHEALTH_MODAL_TITLE:"TeleHealth Session",TELEHEALTH_MODAL_CONFIRM_TITLE:"Confirm Session Close",UPDATE_APPOINTMENT_STATUS:"Update appointment status",STATUS_NO_SHOW:"No Show",STATUS_CANCELED:"Canceled",STATUS_CHECKED_OUT:"Checked Out",STATUS_SKIP_UPDATE:"Skip Update",CONFIRM:"Confirm",STATUS_NO_UPDATE:"No Change",STATUS_OTHER:"Other"};function c(t){return!0===t?a+"public/index-portal.php":a+"public/index.php"}i.telehealth={showPatientPortalDialog:function(t){let e={pc_eid:t},n=i.settings.apiCSRFToken;s=new I(n,i.settings.features,l,c(!0)),s.init(e)},launchProviderVideoMessage:function(t){if(s){if(s.inSession)return void alert(l.DUPLICATE_SESSION);s.destruct(),s=null}s=new w(i.settings.apiCSRFToken,i.settings.features,l,c(!1)),s.init(t)},launchRegistrationChecker:function(e){r=new t(c(e)),r.checkRegistration()},getTeleHealthScriptLocation:c},e.comlink=i}(window,window.comlink||{},bootstrap,$,window.dlgopen)}();