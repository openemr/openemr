[-*Smarty*-]
[-*****************************************************************************-]
[-* This is the source code for both day/default.html and week/default.html.  *-]
[-* They should always be identical.  If you change one, copy to the other!   *-]
[-*****************************************************************************-]
[-* Copyright (C) 2005 Rod Roark <rod@sunsetsystems.com> and others           *-]
[-*                                                                           *-]
[-* This program is free software; you can redistribute it and/or             *-]
[-* modify it under the terms of the GNU General Public License               *-]
[-* as published by the Free Software Foundation; either version 2            *-]
[-* of the License, or (at your option) any later version.                    *-]
[-*****************************************************************************-]
[-config_load file="default.conf"-]
[-*Load the Language Definitions*-]
[-config_load file="lang.$USER_LANG"-]
[-include file="$TPL_NAME/views/header.html"-]
[-* we want to include out stylesheet for this view*-]
[-fetch file="$TPL_STYLE_PATH/day.css" assign="css"-]
[-eval var=$css-]

<style>
a       { text-decoration:none; }
.tacell { font-size:10pt; background-color:#ddffdd; text-align:right; }
.tucell { font-size:10pt; background-color:#ffbbbb; text-align:right; }
.eacell { font-size:10pt; background-color:#ffffff; }
.eucell { font-size:10pt; background-color:#ffbbbb; }
.nobot  { border-bottom-width:0px; }
.notop  { border-top-width:0px; }
</style>

<script language='JavaScript'>
function newEvt(startampm, starttimeh, starttimem, eventdate, providerid) {
 location = 'index.php?module=PostCalendar&func=submit' +
  '&event_startampm=' + startampm +
  '&event_starttimeh=' + starttimeh +
  '&event_starttimem=' + starttimem +
  '&Date=' + eventdate +
  '&event_userid=' + providerid;
}
function oldEvt(eventdate, eventid) {
 location = 'index.php?module=PostCalendar&func=view&viewtype=details' +
  '&Date=' + eventdate +
  '&eid=' + eventid;
}
function goPid(pid) {
 top.location = '../../patient_file/patient_file.php' +
  '?set_pid=' + pid + '&pid=' + pid;
}
</script>

[-php-]

 // [-if $PRINT_VIEW != 1-]
 // [-*Main Navigation*-]
 // [-include file="$TPL_NAME/views/global/navigation.html"-]
 // [-/if-]

 $A_EVENTS  =& $this->_tpl_vars['A_EVENTS'];
 $S_EVENTS  =& $this->_tpl_vars['S_EVENTS'];
 $providers =& $this->_tpl_vars['providers'];
 $times     =& $this->_tpl_vars['times'];
 $interval  =  $this->_tpl_vars['interval'];
 $viewtype  =  $this->_tpl_vars['VIEW_TYPE'];
 $PREV_WEEK_URL = $this->_tpl_vars['PREV_WEEK_URL'];
 $NEXT_WEEK_URL = $this->_tpl_vars['NEXT_WEEK_URL'];
 $PREV_DAY_URL  = $this->_tpl_vars['PREV_DAY_URL'];
 $NEXT_DAY_URL  = $this->_tpl_vars['NEXT_DAY_URL'];

 $Date =  postcalendar_getDate();
 if (!isset($y)) $y = substr($Date, 0, 4);
 if (!isset($m)) $m = substr($Date, 4, 2);
 if (!isset($d)) $d = substr($Date, 6, 2);

 // echo "<!-- There are " . count($A_EVENTS) . " A_EVENTS days -->\n";

 $MULTIDAY = count($A_EVENTS) > 1;

 $provinfo = getProviderInfo();

 echo "<form action='index.php?module=PostCalendar&func=view' method='post'>\n";
 echo "<center>\n";
 echo "<table border='0' cellpadding='0' cellspacing='0' width='99%'>\n";
 echo " <tr><td colspan='3' height='5'></td></tr>\n";
 echo " <tr>\n";

 // Build the scrolling selection list of providers.
 echo "  <td rowspan='2' align='left' valign='top' width='33%' nowrap>\n";
 echo "   <select multiple size='3' name='pc_username[]'>\n";
 echo "    <option value='__PC_ALL__'>All Users</option>\n";
 foreach ($provinfo as $doc) {
  $username = $doc['username'];
  echo "    <option value='$username'";
  foreach ($providers as $provider)
   if ($provider['username'] == $username) echo " selected";
  echo ">" . $doc['fname'] . " " . $doc['lname'] . "</option>\n";
 }
 echo "   </select>\n";
 echo "  </td>\n";

 // Build the date and view type selectors and the Go button.
 echo "  <td align='center' valign='top' width='34%' nowrap>\n";
 echo "   <select name='jumpmonth'>\n";
 foreach (array('01' => 'Jan', '02' => 'Feb', '03' => 'Mar', '04' => 'Apr',
                '05' => 'May', '06' => 'Jun', '07' => 'Jul', '08' => 'Aug',
                '09' => 'Sep', '10' => 'Oct', '11' => 'Nov', '12' => 'Dec')
          as $key => $value) {
  echo "    <option value='$key'";
  if ($key == $m) echo " selected";
  echo ">$value</option>\n";
 }
 echo "   </select>";
 echo "<select name='jumpday'>\n";
 for ($i = 1; $i <= 31; ++$i) {
  echo "    <option value='$i'";
  if ($i == $d) echo " selected";
  echo ">$i</option>\n";
 }
 echo "   </select>";
 echo "<select name='jumpyear'>\n";
 for ($i = 2005; $i <= 2015; ++$i) {
  echo "    <option value='$i'";
  if ($i == $y) echo " selected";
  echo ">$i</option>\n";
 }
 echo "   </select>\n";
 echo "   <select name='viewtype'>\n";
 foreach (array('day' => 'Day', 'week' => 'Week', 'month' => 'Month', 'year' => 'Year')
          as $key => $value) {
  echo "    <option value='$key'";
  if ($key == $viewtype) echo " selected";
  echo ">$value</option>\n";
 }
 echo "   </select>\n";
 echo "   &nbsp;<input type='submit' name='submit' value='Go' />\n";
 echo "  </td>\n";

 // Show the Add and Search buttons.
 echo "  <td align='right' valign='top' width='33%' nowrap>\n";
 echo "   <input type='button' value='Add' onclick='location=\"index.php?module=PostCalendar&func=submit&Date=$Date&event_starttimeh=23&event_startampm=2\"' />\n";
 echo "   <input type='button' value='Search' onclick='location=\"index.php?module=PostCalendar&func=search\"' />\n";
 echo "  </td>\n";
 echo " </tr>\n";

 // Show the date/range and its previous- and next-day/week selectors.
 echo " <tr>\n";
 echo "  <td align='center' width='34%' nowrap>\n";
 $atmp = array_keys($A_EVENTS);
 if ($MULTIDAY) {
  echo "<a href='$PREV_WEEK_URL'>&lt;&lt;</a>&nbsp;\n";
  echo date("F j Y", strtotime($atmp[0]));
  echo " - ";
  echo date("F j Y", strtotime($atmp[count($atmp)-1]));
  echo "&nbsp;<a href='$NEXT_WEEK_URL'>&gt;&gt;</a>\n";
 } else {
  echo "<a href='$PREV_DAY_URL'>&lt;&lt;</a>&nbsp;\n";
  echo date("l, F j, Y", strtotime($atmp[0]));
  echo "&nbsp;<a href='$NEXT_DAY_URL'>&gt;&gt;</a>\n";
 }
 echo "  </td>\n";
 echo "  <td align='right' width='33%' nowrap>\n";
 echo "   &nbsp;\n";
 echo "  </td>\n";

 echo " </tr>\n";
 echo "</table>\n";
 echo "</center>\n";
 echo "</form>\n";

[-/php-]

[-assign var="dayname" value=$DATE|date_format:"%w"-]
[-assign var="day"     value=$DATE|date_format:"%d"|string_format:"%1d"-]
[-assign var="month"   value=$DATE|date_format:"%m"|string_format:"%1d"-]
[-assign var="year"    value=$DATE|date_format:"%Y"|string_format:"%4d"-]

[-pc_sort_events var="S_EVENTS" sort="time" order="asc" value=$A_EVENTS-]

[-php-]

 echo "<table width='100%' border='1' cellpadding='1' cellspacing='0' >\n";

 // For each day...
 foreach ($A_EVENTS as $date => $events) {
  $need_headers = true;
  $eventdate = substr($date, 0, 4) . substr($date, 5, 2) . substr($date, 8, 2);

  // If multiple days then show a date header for each.
  if ($MULTIDAY) {
   echo " <tr>\n";
   echo "  <td colspan='" . (count($providers) * 2) . "' align='center'>" .
        date("l, F j, Y", strtotime($date)) . "</td>";
   echo " </tr>\n";
  }

  $arr_events = $S_EVENTS[$date];
  list($slotkey, $slotevent) = each($arr_events);

  // This is an array of provider status information for this day,
  // used to properly assign table cell attributes.
  $provstat = array();

  $slotindex = 0;
  $lastslotindex = count($times) - 1;

  // For each time slot...
  foreach ($times as $slottime) {
   $startampm = ($slottime['mer']) == "pm" ? 2 : 1;
   $starttimeh = $slottime['hour'];
   $starttimem = $slottime['minute'];

   // Repeat doc names at 1PM.  This is a kludge; omit it for released code.
   // if ($starttimeh == 13 && $starttimem == 0) $need_headers = true;

   // Get all events just for this time slot now, because we can pick up where
   // we left off and because we don't want to re-scan all events for the day
   // for each table cell.
   //
   $arr_slot = array();
   for (; isset($slotkey); list($slotkey, $slotevent) = each($arr_events)) {
    $starth = substr($slotevent['startTime'], 0, 2);
    $startm = substr($slotevent['startTime'], 3, 2);

    if ($starth > $starttimeh) break;
    if ($startm >= ($starttimem + $interval)) break;
    $arr_slot[$slotkey] = $slotevent;

    $catid = $slotevent['catid'];
    $providerid = $slotevent['aid'];
    $durminutes = ceil($slotevent['duration'] / 60);
    $durslots = ceil($durminutes / $interval);

    // While we're here, collect information for setting cell colors.
    if ($catid == 2) { // in office
     $provstat[$providerid]['in'] = true;
    }
    else if ($catid == 3) { // out of office
     $provstat[$providerid]['in'] = false;
    }
    else if ($catid == 4 || $catid == 8 || $catid == 11) { // unavailable types
     $endindex = $slotindex + $durslots;
     for ($i = $slotindex; $i < $endindex; ++$i) {
      $provstat[$providerid][$i]['res'] = true;
     }
    }
    // if duration > slot size then mark slots for border control.
    if ($durslots > 1) {
     $endindex = $slotindex + $durslots - 1;
     for ($i = $slotindex; $i < $endindex; ++$i) {
      $provstat[$providerid][$i]['ext'] = true;
     }
    }
   }

   // Write a header row with the provider names if appropriate.
   if ($need_headers) {
    $need_headers = false;
    echo " <tr>\n";
    foreach ($providers as $provider) {
     echo "  <td colspan='2' align='center'>";
     echo $provider['fname'][0] . " " . $provider['lname'];
     echo "</td>\n";
    }
    echo " </tr>\n";
   }

   echo " <tr>\n";

   // We are now ready to write the table row for the current time slot.
   // This loops once for each provider to be displayed.
   //
   foreach ($providers as $provider) {
    $providerid = $provider['id'];

    $content = ""; // this will be the event cell content

    $clsuffix = "acell";
    if ($provstat[$providerid][$slotindex]['res'] || ! $provstat[$providerid]['in']) {
      $clsuffix = "ucell";
    }

    // Remove top and/or bottom table cell borders using CSS when events span
    // time slots or when the practitioner is not in-office.  Using "rowspan"
    // would be a difficult and inferior solution to this problem.
    //
    $tdstyle="";
    if ($slotindex < $lastslotindex &&
        ($provstat[$providerid][$slotindex]['ext'] || !$provstat[$providerid]['in'])) {
     $tdstyle .= " nobot";
    }
    if ($slotindex > 0 && ($provstat[$providerid][$slotindex-1]['ext'] ||
        !($provstat[$providerid]['in'] || $provstat[$providerid]['wasin']))) {
     $tdstyle .= " notop";
    }

    $disptimeh = ($starttimeh > 12) ? ($starttimeh - 12) : $starttimeh;

    echo "  <td class='t$clsuffix'";
    if ($slotindex == 0) echo " width='1%'";
    echo ">";
    echo "<a href='javascript:newEvt($startampm,$starttimeh,$starttimem,$eventdate,$providerid)'>";
    echo "$disptimeh:$starttimem";
    echo "</a></td>\n";

    echo "  <td class='e$clsuffix$tdstyle'>";

    // Scan all events for this time slot and generate the associated HTML for
    // this doc.  JavaScript is used in hrefs to reduce the volume of output.
    //
    reset($arr_slot);
    while (list($eventkey, $event) = each($arr_slot)) {
     if ($event['aid'] != $providerid) continue;
     if ($content) $content .= " ";
     $starth = substr($event['startTime'], 0, 2);
     $startm = substr($event['startTime'], 3, 2);
     $eventid = $event['eid'];
     $patientid = $event['pid'];
     $commapos = strpos($event['patient_name'], ",");
     $lname = addslashes(ucfirst(strtolower(substr($event['patient_name'], 0, $commapos))));
     $fname = addslashes(ucfirst(strtolower(substr($event['patient_name'], $commapos + 2))));
     $patient_dob = $event['patient_dob'];
     $patient_age = $event['patient_age'];
     $catid = $event['catid'];
     $catname = $event['catname'];
     $title = "$fname, age $patient_age ($patient_dob) " . addslashes($event['hometext']);
     if ($catid == 2 || $catid == 3 || $catid == 4 || $catid == 8 || $catid == 11) {
      if      ($catid ==  2) $catname = "IN";
      else if ($catid ==  3) $catname = "OUT";
      else if ($catid ==  4) $catname = "VACATION";
      else if ($catid ==  8) $catname = "LUNCH";
      else if ($catid == 11) $catname = "RESERVED";
      // Omit lunch, vacation, etc. if the doc is not in-office.
      if ($provstat[$providerid]['in'] || $catid < 4) {
       $content .= "<a href='javascript:oldEvt($eventdate,$eventid)'>";
       $content .= $catname . "</a>";
      }
     }
     else { // some sort of patient appointment
      $content .= "<a href='javascript:oldEvt($eventdate,$eventid)' title='$catname'>";
      $content .= $startm . "</a>";
      $content .= "<a href='javascript:goPid($patientid)' title='$title'>-";
      if ($catid == 1) $content .= "<strike>";
      $content .= $lname;
      if ($catid == 1) $content .= "</strike>";
      $content .= "</a>";
     }
    } // end while

    if (! $content) $content = "&nbsp;";
    echo $content . "</td>\n";

    // Keep track of whether the doc was in during the previous time slot.
    $provstat[$providerid]['wasin'] = $provstat[$providerid]['in'];

   } // end provider

   echo " </tr>\n";

   ++$slotindex;
  } // end time slot
 } // end day

 echo "</table>\n";

 // [-*footer*-]
 // [-include file="$TPL_NAME/views/global/footer.html"-]
 // [-include file="$TPL_NAME/views/footer.html"-]

[-/php-]

</body>
</html>
