#!/bin/bash

################################################################################
# Vietnamese Physiotherapy Module - Restore Script
################################################################################
# File: restore.sh
# Purpose: Restore Vietnamese PT module data from backups
# Author: AI-Generated (Claude Code)
# Date: 2025-11-22
# Version: 1.0.0
#
# AI-GENERATED CODE: This entire script was generated by Claude Code
#
# Usage:
#   ./restore.sh [options]
#
# Options:
#   --backup-timestamp TS   Restore from specific backup timestamp
#   --backup-dir DIR        Specify backup directory (default: ./backups)
#   --list                  List available backups
#   --verify-only           Verify backup without restoring
#   --help                  Show this help message
#
# Exit Codes:
#   0 - Success
#   1 - Error
################################################################################

set -euo pipefail

# ============================================================================
# Configuration
# ============================================================================

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BACKUP_DIR="${SCRIPT_DIR}/backups"
BACKUP_TIMESTAMP=""
LIST_ONLY=false
VERIFY_ONLY=false
LOG_FILE="${SCRIPT_DIR}/restore_$(date +%Y%m%d_%H%M%S).log"

# Database configuration
DB_HOST="localhost"
DB_USER="openemr"
DB_PASS="openemr123!"
DB_NAME="openemr"

# Parse command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        --backup-timestamp)
            BACKUP_TIMESTAMP="$2"
            shift 2
            ;;
        --backup-dir)
            BACKUP_DIR="$2"
            shift 2
            ;;
        --list)
            LIST_ONLY=true
            shift
            ;;
        --verify-only)
            VERIFY_ONLY=true
            shift
            ;;
        --help)
            head -n 30 "$0" | grep "^#" | sed 's/^# //'
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo "Use --help for usage information"
            exit 1
            ;;
    esac
done

# ============================================================================
# Color Output
# ============================================================================

GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1" | tee -a "$LOG_FILE"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1" | tee -a "$LOG_FILE"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1" | tee -a "$LOG_FILE"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1" | tee -a "$LOG_FILE"
}

# ============================================================================
# List Backups
# ============================================================================

list_available_backups() {
    echo "================================================================================"
    echo "  Available Backups"
    echo "================================================================================"

    if [ ! -d "$BACKUP_DIR" ]; then
        log_error "Backup directory not found: $BACKUP_DIR"
        exit 1
    fi

    # Find unique timestamps
    local timestamps=()
    for file in "$BACKUP_DIR"/*_[0-9][0-9][0-9][0-9][0-9][0-9][0-9][0-9]_[0-9][0-9][0-9][0-9][0-9][0-9].*; do
        if [ -f "$file" ]; then
            local filename=$(basename "$file")
            # Extract timestamp (YYYYMMDD_HHMMSS)
            if [[ $filename =~ _([0-9]{8}_[0-9]{6})\. ]]; then
                local ts="${BASH_REMATCH[1]}"
                if [[ ! " ${timestamps[@]} " =~ " ${ts} " ]]; then
                    timestamps+=("$ts")
                fi
            fi
        fi
    done

    if [ ${#timestamps[@]} -eq 0 ]; then
        log_warning "No backups found in $BACKUP_DIR"
        exit 0
    fi

    # Sort timestamps in reverse order (newest first)
    IFS=$'\n' sorted_timestamps=($(sort -r <<<"${timestamps[*]}"))
    unset IFS

    echo ""
    printf "%-20s %-15s %-40s\n" "Timestamp" "Date/Time" "Files"
    printf "%-20s %-15s %-40s\n" "--------------------" "---------------" "----------------------------------------"

    for ts in "${sorted_timestamps[@]}"; do
        # Parse timestamp for display
        local date_part="${ts:0:8}"
        local time_part="${ts:9:6}"
        local formatted_date="${date_part:0:4}-${date_part:4:2}-${date_part:6:2}"
        local formatted_time="${time_part:0:2}:${time_part:2:2}:${time_part:4:2}"

        # Count files for this timestamp
        local file_count=$(find "$BACKUP_DIR" -name "*_${ts}.*" -type f | wc -l)

        # Check if manifest exists
        local has_manifest=""
        if [ -f "$BACKUP_DIR/backup_manifest_${ts}.txt" ]; then
            has_manifest=" (with manifest)"
        fi

        printf "%-20s %-15s %-40s\n" "$ts" "$formatted_date $formatted_time" "$file_count files$has_manifest"
    done

    echo ""
    echo "To restore a backup, use: ./restore.sh --backup-timestamp <timestamp>"
    echo ""
}

# ============================================================================
# Verify Backup
# ============================================================================

verify_backup() {
    local timestamp=$1

    log_info "Verifying backup: $timestamp"

    local backup_files=(
        "${BACKUP_DIR}/vietnamese_pt_tables_${timestamp}.sql"
        "${BACKUP_DIR}/vietnamese_pt_procedures_${timestamp}.sql"
        "${BACKUP_DIR}/vietnamese_pt_forms_${timestamp}.sql"
        "${BACKUP_DIR}/vietnamese_pt_menu_${timestamp}.sql"
        "${BACKUP_DIR}/vietnamese_pt_acl_${timestamp}.sql"
    )

    # Check for compressed versions
    local found_files=0
    local missing_files=()

    for file in "${backup_files[@]}"; do
        if [ -f "$file" ] || [ -f "${file}.gz" ]; then
            ((found_files++))
        else
            missing_files+=($(basename "$file"))
        fi
    done

    if [ $found_files -eq 0 ]; then
        log_error "No backup files found for timestamp: $timestamp"
        return 1
    fi

    if [ ${#missing_files[@]} -gt 0 ]; then
        log_warning "Some backup files missing: ${missing_files[*]}"
    fi

    log_success "Backup verified: $found_files files found"

    # Show manifest if available
    local manifest_file="${BACKUP_DIR}/backup_manifest_${timestamp}.txt"
    if [ -f "$manifest_file" ]; then
        echo ""
        log_info "Backup manifest:"
        cat "$manifest_file"
    fi

    return 0
}

# ============================================================================
# Restore Functions
# ============================================================================

decompress_if_needed() {
    local file=$1

    if [ -f "${file}.gz" ] && [ ! -f "$file" ]; then
        log_info "Decompressing: $(basename "${file}.gz")"
        gunzip -k "${file}.gz"
    fi
}

restore_tables() {
    local timestamp=$1
    local backup_file="${BACKUP_DIR}/vietnamese_pt_tables_${timestamp}.sql"

    decompress_if_needed "$backup_file"

    if [ ! -f "$backup_file" ]; then
        log_warning "Tables backup not found, skipping"
        return 0
    fi

    log_info "Restoring Vietnamese PT tables..."

    if mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" "$DB_NAME" < "$backup_file" 2>> "$LOG_FILE"; then
        log_success "Tables restored successfully"
        return 0
    else
        log_error "Failed to restore tables"
        return 1
    fi
}

restore_procedures() {
    local timestamp=$1
    local backup_file="${BACKUP_DIR}/vietnamese_pt_procedures_${timestamp}.sql"

    decompress_if_needed "$backup_file"

    if [ ! -f "$backup_file" ]; then
        log_warning "Stored procedures backup not found, skipping"
        return 0
    fi

    log_info "Restoring stored procedures..."

    if mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" "$DB_NAME" < "$backup_file" 2>> "$LOG_FILE"; then
        log_success "Stored procedures restored successfully"
        return 0
    else
        log_error "Failed to restore stored procedures"
        return 1
    fi
}

restore_forms() {
    local timestamp=$1
    local backup_file="${BACKUP_DIR}/vietnamese_pt_forms_${timestamp}.sql"

    decompress_if_needed "$backup_file"

    if [ ! -f "$backup_file" ]; then
        log_warning "Form registrations backup not found, skipping"
        return 0
    fi

    log_info "Restoring form registrations..."

    if mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" "$DB_NAME" < "$backup_file" 2>> "$LOG_FILE"; then
        log_success "Form registrations restored successfully"
        return 0
    else
        log_error "Failed to restore form registrations"
        return 1
    fi
}

restore_menu() {
    local timestamp=$1
    local backup_file="${BACKUP_DIR}/vietnamese_pt_menu_${timestamp}.sql"

    decompress_if_needed "$backup_file"

    if [ ! -f "$backup_file" ]; then
        log_warning "Menu items backup not found, skipping"
        return 0
    fi

    log_info "Restoring menu items..."

    if mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" "$DB_NAME" < "$backup_file" 2>> "$LOG_FILE"; then
        log_success "Menu items restored successfully"
        return 0
    else
        log_error "Failed to restore menu items"
        return 1
    fi
}

restore_acl() {
    local timestamp=$1
    local backup_file="${BACKUP_DIR}/vietnamese_pt_acl_${timestamp}.sql"

    decompress_if_needed "$backup_file"

    if [ ! -f "$backup_file" ]; then
        log_warning "ACL configuration backup not found, skipping"
        return 0
    fi

    log_info "Restoring ACL configuration..."

    if mysql -h "$DB_HOST" -u "$DB_USER" -p"$DB_PASS" "$DB_NAME" < "$backup_file" 2>> "$LOG_FILE"; then
        log_success "ACL configuration restored successfully"
        return 0
    else
        log_error "Failed to restore ACL configuration"
        return 1
    fi
}

# ============================================================================
# Main Restore Flow
# ============================================================================

main() {
    echo "================================================================================"
    echo "  Vietnamese Physiotherapy Module - Restore"
    echo "================================================================================"

    # List backups if requested
    if [ "$LIST_ONLY" = true ]; then
        list_available_backups
        exit 0
    fi

    # Check if backup timestamp is provided
    if [ -z "$BACKUP_TIMESTAMP" ]; then
        log_error "No backup timestamp specified"
        echo "Use --list to see available backups"
        echo "Use --backup-timestamp <timestamp> to restore"
        exit 1
    fi

    echo "  Backup Timestamp: $BACKUP_TIMESTAMP"
    echo "  Backup Directory: $BACKUP_DIR"
    echo "  Log File: $LOG_FILE"
    echo "================================================================================"
    echo ""

    # Verify backup exists
    if ! verify_backup "$BACKUP_TIMESTAMP"; then
        exit 1
    fi

    # Exit if verify-only mode
    if [ "$VERIFY_ONLY" = true ]; then
        log_success "Backup verification complete"
        exit 0
    fi

    # Confirm restoration
    echo ""
    read -p "This will restore database from backup. Continue? (yes/no): " confirm
    if [ "$confirm" != "yes" ]; then
        log_info "Restore cancelled by user"
        exit 0
    fi
    echo ""

    # Perform restoration
    local failed=0

    restore_tables "$BACKUP_TIMESTAMP" || ((failed++))
    restore_procedures "$BACKUP_TIMESTAMP" || ((failed++))
    restore_forms "$BACKUP_TIMESTAMP" || ((failed++))
    restore_menu "$BACKUP_TIMESTAMP" || ((failed++))
    restore_acl "$BACKUP_TIMESTAMP" || ((failed++))

    # Summary
    echo ""
    if [ $failed -eq 0 ]; then
        log_success "Restore completed successfully!"
        echo ""
        echo "Log file: $LOG_FILE"
        exit 0
    else
        log_error "Restore completed with $failed error(s)"
        echo "Check log file: $LOG_FILE"
        exit 1
    fi
}

# Run main restore
main

# AI-GENERATED CODE END
