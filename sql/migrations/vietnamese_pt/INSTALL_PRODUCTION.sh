#!/bin/bash

################################################################################
# Vietnamese Physiotherapy Module - Production Installation Script
################################################################################
# File: INSTALL_PRODUCTION.sh
# Purpose: Comprehensive production installer for Vietnamese PT module
# Author: AI-Generated (Claude Code)
# Date: 2025-11-22
# Version: 1.0.0
#
# AI-GENERATED CODE: This entire script was generated by Claude Code
#
# This script performs a complete production installation of the Vietnamese
# Physiotherapy module including prerequisite checks, database migrations,
# form registration, and verification.
#
# Usage:
#   ./INSTALL_PRODUCTION.sh [options]
#
# Options:
#   --silent        Run in silent mode (no interactive prompts)
#   --dry-run       Preview changes without applying them
#   --skip-backup   Skip database backup (not recommended)
#   --help          Show this help message
#
# Exit Codes:
#   0 - Success
#   1 - General error
#   2 - Prerequisite check failed
#   3 - Migration failed
#   4 - Rollback successful after failure
################################################################################

set -euo pipefail

# ============================================================================
# Configuration
# ============================================================================

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
OPENEMR_ROOT="$(cd "$SCRIPT_DIR/../../.." && pwd)"
LOG_FILE="${SCRIPT_DIR}/installation_$(date +%Y%m%d_%H%M%S).log"
BACKUP_DIR="${SCRIPT_DIR}/backups"
MIGRATION_DIR="${SCRIPT_DIR}"

MODULE_VERSION="1.0.0"
SCHEMA_VERSION="003"
REQUIRED_PHP_VERSION="8.0"
REQUIRED_MYSQL_VERSION="5.7"

# Parse command line arguments
SILENT_MODE=false
DRY_RUN=false
SKIP_BACKUP=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --silent)
            SILENT_MODE=true
            shift
            ;;
        --dry-run)
            DRY_RUN=true
            shift
            ;;
        --skip-backup)
            SKIP_BACKUP=true
            shift
            ;;
        --help)
            head -n 40 "$0" | grep "^#" | sed 's/^# //'
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo "Use --help for usage information"
            exit 1
            ;;
    esac
done

# ============================================================================
# Color Output Functions
# ============================================================================

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

log_info() {
    echo -e "${BLUE}[INFO]${NC} $1" | tee -a "$LOG_FILE"
}

log_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1" | tee -a "$LOG_FILE"
}

log_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1" | tee -a "$LOG_FILE"
}

log_error() {
    echo -e "${RED}[ERROR]${NC} $1" | tee -a "$LOG_FILE"
}

progress_bar() {
    local current=$1
    local total=$2
    local width=50
    local percentage=$((current * 100 / total))
    local filled=$((width * current / total))
    local empty=$((width - filled))

    printf "\r["
    printf "%${filled}s" | tr ' ' '='
    printf "%${empty}s" | tr ' ' ' '
    printf "] %d%%" "$percentage"
}

# ============================================================================
# Prerequisite Checks
# ============================================================================

check_php_version() {
    log_info "Checking PHP version..."

    local php_version=$(php -r "echo PHP_VERSION;")
    local required_version=$REQUIRED_PHP_VERSION

    if [ "$(printf '%s\n' "$required_version" "$php_version" | sort -V | head -n1)" = "$required_version" ]; then
        log_success "PHP version $php_version meets requirement (>= $required_version)"
        return 0
    else
        log_error "PHP version $php_version does not meet requirement (>= $required_version)"
        return 1
    fi
}

check_mysql_connection() {
    log_info "Checking MySQL/MariaDB connection..."

    # Try to connect using OpenEMR configuration
    if mysql --defaults-file=/dev/null -h localhost -u openemr -popenemr123! -e "SELECT 1" &>/dev/null; then
        log_success "Database connection successful"
        return 0
    else
        log_error "Cannot connect to database. Check credentials."
        return 1
    fi
}

check_required_extensions() {
    log_info "Checking required PHP extensions..."

    local required_extensions=("mysqli" "pdo" "pdo_mysql" "json" "mbstring")
    local missing_extensions=()

    for ext in "${required_extensions[@]}"; do
        if ! php -m | grep -q "^$ext$"; then
            missing_extensions+=("$ext")
        fi
    done

    if [ ${#missing_extensions[@]} -eq 0 ]; then
        log_success "All required PHP extensions are installed"
        return 0
    else
        log_error "Missing PHP extensions: ${missing_extensions[*]}"
        return 1
    fi
}

check_openemr_installation() {
    log_info "Checking OpenEMR installation..."

    if [ ! -f "$OPENEMR_ROOT/interface/globals.php" ]; then
        log_error "OpenEMR installation not found at $OPENEMR_ROOT"
        return 1
    fi

    if [ ! -d "$OPENEMR_ROOT/src/Services" ]; then
        log_error "OpenEMR source directory not found"
        return 1
    fi

    log_success "OpenEMR installation validated"
    return 0
}

check_file_permissions() {
    log_info "Checking file permissions..."

    local writable_dirs=(
        "$OPENEMR_ROOT/sites/default/documents"
        "$OPENEMR_ROOT/interface/forms"
        "$OPENEMR_ROOT/library/custom"
    )

    for dir in "${writable_dirs[@]}"; do
        if [ ! -w "$dir" ]; then
            log_warning "Directory not writable: $dir"
        fi
    done

    log_success "File permissions check completed"
    return 0
}

run_prerequisite_checks() {
    log_info "Running prerequisite checks..."
    echo ""

    local checks=(
        "check_php_version"
        "check_mysql_connection"
        "check_required_extensions"
        "check_openemr_installation"
        "check_file_permissions"
    )

    local failed=0
    local total=${#checks[@]}
    local current=0

    for check in "${checks[@]}"; do
        ((current++))
        progress_bar $current $total
        if ! $check >> "$LOG_FILE" 2>&1; then
            ((failed++))
        fi
    done

    echo ""  # New line after progress bar

    if [ $failed -gt 0 ]; then
        log_error "$failed prerequisite check(s) failed. See log: $LOG_FILE"
        return 2
    fi

    log_success "All prerequisite checks passed"
    return 0
}

# ============================================================================
# Backup Functions
# ============================================================================

create_database_backup() {
    if [ "$SKIP_BACKUP" = true ]; then
        log_warning "Skipping database backup (--skip-backup flag set)"
        return 0
    fi

    log_info "Creating database backup..."

    mkdir -p "$BACKUP_DIR"

    local backup_file="${BACKUP_DIR}/vietnamese_pt_backup_$(date +%Y%m%d_%H%M%S).sql"

    local tables=(
        "vietnamese_medical_terms"
        "pt_assessments_bilingual"
        "pt_exercise_prescriptions_bilingual"
        "pt_treatment_plans_bilingual"
        "pt_outcome_measures_bilingual"
        "pt_treatment_sessions_bilingual"
        "pt_assessment_templates_bilingual"
        "pt_configuration"
        "registry"
        "list_options"
    )

    mysqldump -h localhost -u openemr -popenemr123! openemr \
        "${tables[@]}" > "$backup_file" 2>/dev/null || {
        log_warning "Backup created with warnings (some tables may not exist yet)"
    }

    if [ -f "$backup_file" ]; then
        local size=$(du -h "$backup_file" | cut -f1)
        log_success "Database backup created: $backup_file ($size)"
        echo "$backup_file" > "${BACKUP_DIR}/latest_backup.txt"
        return 0
    else
        log_error "Failed to create database backup"
        return 1
    fi
}

# ============================================================================
# Migration Functions
# ============================================================================

apply_migration() {
    local migration_file=$1
    local migration_name=$(basename "$migration_file")

    log_info "Applying migration: $migration_name"

    if [ "$DRY_RUN" = true ]; then
        log_info "[DRY RUN] Would apply: $migration_name"
        return 0
    fi

    if mysql -h localhost -u openemr -popenemr123! openemr < "$migration_file" 2>> "$LOG_FILE"; then
        log_success "Migration applied: $migration_name"
        return 0
    else
        log_error "Migration failed: $migration_name"
        return 1
    fi
}

apply_all_migrations() {
    log_info "Applying database migrations..."

    local migrations=(
        "000_migration_schema.sql"
        "001_add_indexes.sql"
        "002_add_foreign_keys.sql"
        "003_add_menu_items.sql"
    )

    local total=${#migrations[@]}
    local current=0

    for migration in "${migrations[@]}"; do
        ((current++))
        progress_bar $current $total

        local migration_path="${MIGRATION_DIR}/${migration}"

        if [ ! -f "$migration_path" ]; then
            echo ""  # New line after progress bar
            log_warning "Migration file not found: $migration (skipping)"
            continue
        fi

        if ! apply_migration "$migration_path" >> "$LOG_FILE" 2>&1; then
            echo ""  # New line after progress bar
            log_error "Migration failed: $migration"
            return 3
        fi
    done

    echo ""  # New line after progress bar
    log_success "All migrations applied successfully"
    return 0
}

# ============================================================================
# Form Registration
# ============================================================================

register_pt_forms() {
    log_info "Registering PT forms..."

    if [ "$DRY_RUN" = true ]; then
        log_info "[DRY RUN] Would register PT forms"
        return 0
    fi

    local forms=(
        "vietnamese_pt_assessment:Vietnamese PT Assessment:1"
        "vietnamese_pt_exercise:Vietnamese PT Exercise Prescription:1"
        "vietnamese_pt_treatment_plan:Vietnamese PT Treatment Plan:1"
        "vietnamese_pt_outcome:Vietnamese PT Outcome Measures:1"
    )

    for form_spec in "${forms[@]}"; do
        IFS=':' read -r directory name category <<< "$form_spec"

        mysql -h localhost -u openemr -popenemr123! openemr <<SQL 2>> "$LOG_FILE"
INSERT INTO registry (directory, name, state, category, nickname, aco_spec)
VALUES ('$directory', '$name', 1, '$category', '$name', 'encounters|notes')
ON DUPLICATE KEY UPDATE
    name = '$name',
    state = 1,
    category = '$category';
SQL

        log_success "Registered form: $name"
    done

    return 0
}

# ============================================================================
# Post-Installation Tasks
# ============================================================================

update_composer_autoload() {
    log_info "Updating Composer autoload..."

    if [ "$DRY_RUN" = true ]; then
        log_info "[DRY RUN] Would update Composer autoload"
        return 0
    fi

    cd "$OPENEMR_ROOT"

    if command -v composer &> /dev/null; then
        composer dump-autoload -o >> "$LOG_FILE" 2>&1
        log_success "Composer autoload updated"
    else
        log_warning "Composer not found, skipping autoload update"
    fi

    return 0
}

clear_cache() {
    log_info "Clearing cache..."

    if [ "$DRY_RUN" = true ]; then
        log_info "[DRY RUN] Would clear cache"
        return 0
    fi

    local cache_dirs=(
        "$OPENEMR_ROOT/sites/default/documents/smarty/main"
        "$OPENEMR_ROOT/sites/default/documents/smarty/gacl"
    )

    for cache_dir in "${cache_dirs[@]}"; do
        if [ -d "$cache_dir" ]; then
            rm -rf "${cache_dir:?}"/* 2>/dev/null || true
        fi
    done

    log_success "Cache cleared"
    return 0
}

# ============================================================================
# Verification
# ============================================================================

run_verification_tests() {
    log_info "Running verification tests..."

    local failed=0

    # Test 1: Check tables exist
    log_info "Verifying database tables..."
    local required_tables=(
        "vietnamese_medical_terms"
        "pt_assessments_bilingual"
        "pt_exercise_prescriptions_bilingual"
        "pt_treatment_plans_bilingual"
        "pt_outcome_measures_bilingual"
        "pt_configuration"
    )

    for table in "${required_tables[@]}"; do
        if ! mysql -h localhost -u openemr -popenemr123! openemr \
            -e "SHOW TABLES LIKE '$table'" 2>/dev/null | grep -q "$table"; then
            log_error "Table not found: $table"
            ((failed++))
        fi
    done

    # Test 2: Check forms registered
    log_info "Verifying form registrations..."
    local form_count=$(mysql -h localhost -u openemr -popenemr123! openemr \
        -N -e "SELECT COUNT(*) FROM registry WHERE directory LIKE 'vietnamese_pt_%' AND state = 1" 2>/dev/null)

    if [ "$form_count" -lt 4 ]; then
        log_error "Expected 4 forms registered, found $form_count"
        ((failed++))
    else
        log_success "All forms registered ($form_count)"
    fi

    # Test 3: Check stored procedures
    log_info "Verifying stored procedures..."
    local proc_count=$(mysql -h localhost -u openemr -popenemr123! openemr \
        -N -e "SELECT COUNT(*) FROM information_schema.ROUTINES
               WHERE ROUTINE_SCHEMA = 'openemr'
               AND ROUTINE_NAME IN ('get_vietnamese_term', 'get_english_term')" 2>/dev/null)

    if [ "$proc_count" -lt 2 ]; then
        log_warning "Expected 2 stored procedures, found $proc_count"
    else
        log_success "Stored procedures verified ($proc_count)"
    fi

    if [ $failed -eq 0 ]; then
        log_success "All verification tests passed"
        return 0
    else
        log_error "$failed verification test(s) failed"
        return 1
    fi
}

# ============================================================================
# Rollback Function
# ============================================================================

rollback_installation() {
    log_warning "Rolling back installation..."

    local latest_backup="${BACKUP_DIR}/latest_backup.txt"

    if [ -f "$latest_backup" ]; then
        local backup_file=$(cat "$latest_backup")

        if [ -f "$backup_file" ]; then
            log_info "Restoring from backup: $backup_file"
            mysql -h localhost -u openemr -popenemr123! openemr < "$backup_file" 2>> "$LOG_FILE"
            log_success "Database restored from backup"
            return 4
        fi
    fi

    log_error "No backup file found for rollback"
    return 1
}

# ============================================================================
# Generate Installation Report
# ============================================================================

generate_installation_report() {
    local status=$1
    local report_file="${SCRIPT_DIR}/installation_report_$(date +%Y%m%d_%H%M%S).txt"

    cat > "$report_file" <<EOF
================================================================================
Vietnamese Physiotherapy Module - Installation Report
================================================================================
Date: $(date)
Status: $status
Module Version: $MODULE_VERSION
Schema Version: $SCHEMA_VERSION

Installation Details:
- OpenEMR Root: $OPENEMR_ROOT
- Log File: $LOG_FILE
- Backup Directory: $BACKUP_DIR

Summary:
EOF

    if [ "$status" = "SUCCESS" ]; then
        cat >> "$report_file" <<EOF
- All prerequisite checks passed
- Database migrations applied successfully
- PT forms registered
- Verification tests passed
- Installation completed successfully

Next Steps:
1. Access OpenEMR admin interface
2. Configure ACL permissions for Vietnamese PT module
3. Enable PT forms in Form Management
4. Test PT functionality with a patient encounter

For more information, see:
- Documentation/physiotherapy/README.md
- $LOG_FILE
EOF
    else
        cat >> "$report_file" <<EOF
- Installation encountered errors
- See log file for details: $LOG_FILE
- Rollback may have been performed

Troubleshooting:
1. Review log file: $LOG_FILE
2. Check database connectivity
3. Verify file permissions
4. Restore from backup if needed: $BACKUP_DIR

For support, see:
- Documentation/physiotherapy/technical/INSTALLATION.md
EOF
    fi

    log_info "Installation report generated: $report_file"
    cat "$report_file"
}

# ============================================================================
# Main Installation Flow
# ============================================================================

main() {
    echo "================================================================================"
    echo "  Vietnamese Physiotherapy Module - Production Installation"
    echo "================================================================================"
    echo "  Version: $MODULE_VERSION"
    echo "  Schema: $SCHEMA_VERSION"
    echo "  Log: $LOG_FILE"
    echo "================================================================================"
    echo ""

    if [ "$DRY_RUN" = true ]; then
        log_warning "Running in DRY RUN mode - no changes will be made"
        echo ""
    fi

    # Confirm installation
    if [ "$SILENT_MODE" = false ]; then
        read -p "Proceed with installation? (yes/no): " confirm
        if [ "$confirm" != "yes" ]; then
            log_info "Installation cancelled by user"
            exit 0
        fi
        echo ""
    fi

    # Run installation steps
    local install_status="SUCCESS"

    # Step 1: Prerequisite checks
    if ! run_prerequisite_checks; then
        install_status="FAILED"
        generate_installation_report "$install_status"
        exit 2
    fi

    # Step 2: Create backup
    if ! create_database_backup; then
        if [ "$SKIP_BACKUP" = false ]; then
            log_error "Backup failed. Installation aborted."
            exit 1
        fi
    fi

    # Step 3: Apply migrations
    if ! apply_all_migrations; then
        install_status="FAILED"
        log_error "Migration failed. Attempting rollback..."
        rollback_installation
        generate_installation_report "$install_status"
        exit 3
    fi

    # Step 4: Register forms
    if ! register_pt_forms; then
        install_status="FAILED"
        log_error "Form registration failed"
    fi

    # Step 5: Update autoload
    update_composer_autoload

    # Step 6: Clear cache
    clear_cache

    # Step 7: Run verification
    if ! run_verification_tests; then
        install_status="DEGRADED"
        log_warning "Some verification tests failed, but installation may be usable"
    fi

    # Generate report
    echo ""
    generate_installation_report "$install_status"

    if [ "$install_status" = "SUCCESS" ]; then
        log_success "Installation completed successfully!"
        exit 0
    else
        log_error "Installation completed with errors"
        exit 1
    fi
}

# Run main installation
main

# AI-GENERATED CODE END
