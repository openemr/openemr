<?php

/**
 * GuzzleHttpClient - HTTP client wrapper using Guzzle
 *
 * Provides a centralized HTTP client implementation using Guzzle HTTP library
 * to replace direct curl function calls throughout the codebase.
 *
 * @package   OpenEMR
 * @link      https://www.open-emr.org
 * @author    GitHub Copilot <copilot@github.com>
 * @copyright Copyright (c) 2025 GitHub Copilot
 * @license   https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3
 *
 * Code generated by GitHub Copilot AI
 */

namespace OpenEMR\Common\Http;

use GuzzleHttp\Client;
use GuzzleHttp\Exception\GuzzleException;
use GuzzleHttp\Exception\RequestException;
use GuzzleHttp\HandlerStack;
use GuzzleHttp\Psr7\Request;
use Psr\Http\Message\ResponseInterface;

/**
 * HTTP client wrapper using Guzzle
 *
 * Provides a simple interface for making HTTP requests using Guzzle,
 * designed to replace direct curl function calls.
 */
class GuzzleHttpClient
{
    private Client $client;
    private array $defaultOptions;

    /**
     * Constructor
     *
     * @param array $options Default options for all requests
     */
    public function __construct(array $options = [])
    {
        $this->defaultOptions = array_merge([
            'timeout' => 60,
            'connect_timeout' => 30,
            'http_errors' => false, // Don't throw exceptions on HTTP errors (like curl)
            'verify' => true, // SSL verification enabled by default
        ], $options);

        $this->client = new Client($this->defaultOptions);
    }

    /**
     * Make a GET request
     *
     * @param string $url URL to request
     * @param array $options Additional request options
     * @return HttpResponse
     */
    public function get(string $url, array $options = []): HttpResponse
    {
        return $this->request('GET', $url, $options);
    }

    /**
     * Make a POST request
     *
     * @param string $url URL to request
     * @param array $options Additional request options
     * @return HttpResponse
     */
    public function post(string $url, array $options = []): HttpResponse
    {
        return $this->request('POST', $url, $options);
    }

    /**
     * Make a PUT request
     *
     * @param string $url URL to request
     * @param array $options Additional request options
     * @return HttpResponse
     */
    public function put(string $url, array $options = []): HttpResponse
    {
        return $this->request('PUT', $url, $options);
    }

    /**
     * Make a DELETE request
     *
     * @param string $url URL to request
     * @param array $options Additional request options
     * @return HttpResponse
     */
    public function delete(string $url, array $options = []): HttpResponse
    {
        return $this->request('DELETE', $url, $options);
    }

    /**
     * Make an HTTP request
     *
     * @param string $method HTTP method
     * @param string $url URL to request
     * @param array $options Request options
     * @return HttpResponse
     */
    public function request(string $method, string $url, array $options = []): HttpResponse
    {
        try {
            $response = $this->client->request($method, $url, $options);
            return new HttpResponse(
                $response->getStatusCode(),
                (string) $response->getBody(),
                $response->getHeaders(),
                null
            );
        } catch (RequestException $e) {
            // Network error or other request exception
            $response = $e->getResponse();
            if ($response) {
                return new HttpResponse(
                    $response->getStatusCode(),
                    (string) $response->getBody(),
                    $response->getHeaders(),
                    $e->getMessage()
                );
            }
            return new HttpResponse(
                0,
                '',
                [],
                $e->getMessage()
            );
        } catch (GuzzleException $e) {
            // Other Guzzle exceptions
            return new HttpResponse(
                0,
                '',
                [],
                $e->getMessage()
            );
        }
    }

    /**
     * Get the underlying Guzzle client
     *
     * @return Client
     */
    public function getClient(): Client
    {
        return $this->client;
    }
}
