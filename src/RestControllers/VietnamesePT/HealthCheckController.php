<?php

/**
 * Vietnamese Physiotherapy Module - Health Check Controller
 *
 * @package   OpenEMR
 * @link      http://www.open-emr.org
 * @author    AI-Generated (Claude Code)
 * @copyright Copyright (c) 2025 OpenEMR
 * @license   https://github.com/openemr/openemr/blob/master/LICENSE GNU General Public License 3
 *
 * AI-GENERATED CODE: This entire file was generated by Claude Code
 * Purpose: Provides health check endpoints for monitoring Vietnamese PT module status
 */

namespace OpenEMR\RestControllers\VietnamesePT;

use OpenEMR\RestControllers\RestControllerHelper;
use OpenEMR\Services\VietnamesePT\PTAssessmentService;
use OpenEMR\Services\VietnamesePT\PTExercisePrescriptionService;
use OpenEMR\Services\VietnamesePT\PTTreatmentPlanService;
use OpenEMR\Services\VietnamesePT\PTOutcomeMeasureService;
use OpenEMR\Validators\ProcessingResult;

/**
 * Health Check Controller for Vietnamese PT Module
 *
 * Provides endpoints for monitoring module health, component status,
 * and performance metrics.
 */
class HealthCheckController
{
    private const MODULE_VERSION = '1.0.0';
    private const SCHEMA_VERSION = '003';

    /**
     * GET /apis/default/vietnamese-pt/health
     *
     * Returns overall health status of the Vietnamese PT module
     *
     * @return array HTTP response with health status
     */
    public function getHealth()
    {
        $result = new ProcessingResult();
        $startTime = microtime(true);

        try {
            $healthData = [
                'status' => 'healthy',
                'timestamp' => date('c'),
                'checks' => []
            ];

            // 1. Database connectivity check
            $dbCheck = $this->checkDatabaseConnectivity();
            $healthData['checks']['database'] = $dbCheck;

            // 2. Tables existence check
            $tablesCheck = $this->checkRequiredTables();
            $healthData['checks']['tables'] = $tablesCheck;

            // 3. Services instantiation check
            $servicesCheck = $this->checkServices();
            $healthData['checks']['services'] = $servicesCheck;

            // 4. Forms registration check
            $formsCheck = $this->checkFormsRegistration();
            $healthData['checks']['forms'] = $formsCheck;

            // 5. ACL configuration check
            $aclCheck = $this->checkAclConfiguration();
            $healthData['checks']['acl'] = $aclCheck;

            // Determine overall status
            $allHealthy = true;
            foreach ($healthData['checks'] as $check) {
                if ($check['status'] !== 'healthy') {
                    $allHealthy = false;
                    break;
                }
            }

            $healthData['status'] = $allHealthy ? 'healthy' : 'degraded';
            $healthData['response_time_ms'] = round((microtime(true) - $startTime) * 1000, 2);

            $result->setData($healthData);
            return RestControllerHelper::handleProcessingResult($result, 200);
        } catch (\Exception $e) {
            $result->addErrorMessage('Health check failed: ' . $e->getMessage());
            return RestControllerHelper::handleProcessingResult($result, 503);
        }
    }

    /**
     * GET /apis/default/vietnamese-pt/health/detailed
     *
     * Returns detailed component status with performance metrics
     *
     * @return array HTTP response with detailed health information
     */
    public function getDetailedHealth()
    {
        $result = new ProcessingResult();
        $startTime = microtime(true);

        try {
            $detailedData = [
                'status' => 'healthy',
                'timestamp' => date('c'),
                'version' => [
                    'module' => self::MODULE_VERSION,
                    'schema' => self::SCHEMA_VERSION
                ],
                'components' => []
            ];

            // Database component
            $detailedData['components']['database'] = $this->getDetailedDatabaseStatus();

            // Services component
            $detailedData['components']['services'] = $this->getDetailedServicesStatus();

            // Forms component
            $detailedData['components']['forms'] = $this->getDetailedFormsStatus();

            // Widget component
            $detailedData['components']['widget'] = $this->getWidgetStatus();

            // Cache component
            $detailedData['components']['cache'] = $this->getCacheStatus();

            // Performance metrics
            $detailedData['performance'] = $this->getPerformanceMetrics();

            // Determine overall status
            $hasErrors = false;
            foreach ($detailedData['components'] as $component) {
                if (isset($component['status']) && $component['status'] === 'unhealthy') {
                    $hasErrors = true;
                    break;
                }
            }

            $detailedData['status'] = $hasErrors ? 'unhealthy' : 'healthy';
            $detailedData['response_time_ms'] = round((microtime(true) - $startTime) * 1000, 2);

            $result->setData($detailedData);
            return RestControllerHelper::handleProcessingResult($result, 200);
        } catch (\Exception $e) {
            $result->addErrorMessage('Detailed health check failed: ' . $e->getMessage());
            return RestControllerHelper::handleProcessingResult($result, 503);
        }
    }

    /**
     * GET /apis/default/vietnamese-pt/version
     *
     * Returns module version information
     *
     * @return array HTTP response with version information
     */
    public function getVersion()
    {
        $result = new ProcessingResult();

        try {
            $versionData = [
                'module_version' => self::MODULE_VERSION,
                'schema_version' => self::SCHEMA_VERSION,
                'installation_date' => $this->getInstallationDate(),
                'last_migration' => $this->getLastMigration(),
                'php_version' => PHP_VERSION,
                'openemr_version' => $GLOBALS['v_realpatch'] ?? 'unknown'
            ];

            $result->setData($versionData);
            return RestControllerHelper::handleProcessingResult($result, 200);
        } catch (\Exception $e) {
            $result->addErrorMessage('Version check failed: ' . $e->getMessage());
            return RestControllerHelper::handleProcessingResult($result, 500);
        }
    }

    // ========================================================================
    // Private Helper Methods
    // ========================================================================

    /**
     * Check database connectivity
     */
    private function checkDatabaseConnectivity(): array
    {
        $startTime = microtime(true);
        try {
            $result = sqlQuery("SELECT 1 as test");
            $latency = round((microtime(true) - $startTime) * 1000, 2);

            return [
                'status' => 'healthy',
                'latency_ms' => $latency,
                'message' => 'Database connection successful'
            ];
        } catch (\Exception $e) {
            return [
                'status' => 'unhealthy',
                'message' => 'Database connection failed: ' . $e->getMessage()
            ];
        }
    }

    /**
     * Check if all required tables exist
     */
    private function checkRequiredTables(): array
    {
        $requiredTables = [
            'vietnamese_medical_terms',
            'pt_assessments_bilingual',
            'pt_exercise_prescriptions_bilingual',
            'pt_treatment_plans_bilingual',
            'pt_outcome_measures_bilingual',
            'pt_configuration'
        ];

        $missingTables = [];
        foreach ($requiredTables as $table) {
            $result = sqlQuery("SHOW TABLES LIKE ?", [$table]);
            if (empty($result)) {
                $missingTables[] = $table;
            }
        }

        if (empty($missingTables)) {
            return [
                'status' => 'healthy',
                'tables_count' => count($requiredTables),
                'message' => 'All required tables exist'
            ];
        } else {
            return [
                'status' => 'unhealthy',
                'missing_tables' => $missingTables,
                'message' => count($missingTables) . ' required tables missing'
            ];
        }
    }

    /**
     * Check if all services are instantiable
     */
    private function checkServices(): array
    {
        $services = [
            'PTAssessmentService' => PTAssessmentService::class,
            'PTExercisePrescriptionService' => PTExercisePrescriptionService::class,
            'PTTreatmentPlanService' => PTTreatmentPlanService::class,
            'PTOutcomeMeasureService' => PTOutcomeMeasureService::class
        ];

        $failedServices = [];
        foreach ($services as $name => $class) {
            try {
                new $class();
            } catch (\Exception $e) {
                $failedServices[$name] = $e->getMessage();
            }
        }

        if (empty($failedServices)) {
            return [
                'status' => 'healthy',
                'services_count' => count($services),
                'message' => 'All services instantiated successfully'
            ];
        } else {
            return [
                'status' => 'unhealthy',
                'failed_services' => $failedServices,
                'message' => count($failedServices) . ' services failed to instantiate'
            ];
        }
    }

    /**
     * Check if PT forms are registered
     */
    private function checkFormsRegistration(): array
    {
        $requiredForms = [
            'vietnamese_pt_assessment',
            'vietnamese_pt_exercise',
            'vietnamese_pt_treatment_plan',
            'vietnamese_pt_outcome'
        ];

        $registeredForms = [];
        $missingForms = [];

        foreach ($requiredForms as $formName) {
            $result = sqlQuery(
                "SELECT directory FROM registry WHERE directory = ? AND state = 1",
                [$formName]
            );

            if (!empty($result)) {
                $registeredForms[] = $formName;
            } else {
                $missingForms[] = $formName;
            }
        }

        if (empty($missingForms)) {
            return [
                'status' => 'healthy',
                'registered_count' => count($registeredForms),
                'message' => 'All PT forms registered'
            ];
        } else {
            return [
                'status' => 'degraded',
                'registered_count' => count($registeredForms),
                'missing_forms' => $missingForms,
                'message' => count($missingForms) . ' forms not registered'
            ];
        }
    }

    /**
     * Check ACL configuration
     */
    private function checkAclConfiguration(): array
    {
        try {
            $result = sqlQuery(
                "SELECT COUNT(*) as count FROM gacl_aco WHERE section_value = 'vietnamese_pt'"
            );

            $acoCount = $result['count'] ?? 0;

            return [
                'status' => $acoCount > 0 ? 'healthy' : 'degraded',
                'aco_entries' => $acoCount,
                'message' => $acoCount > 0 ? 'ACL configured' : 'ACL not configured'
            ];
        } catch (\Exception $e) {
            return [
                'status' => 'unhealthy',
                'message' => 'ACL check failed: ' . $e->getMessage()
            ];
        }
    }

    /**
     * Get detailed database status
     */
    private function getDetailedDatabaseStatus(): array
    {
        $status = [
            'status' => 'healthy',
            'tables' => [],
            'stored_procedures' => [],
            'indexes' => []
        ];

        try {
            // Check tables with row counts
            $tables = [
                'vietnamese_medical_terms',
                'pt_assessments_bilingual',
                'pt_exercise_prescriptions_bilingual',
                'pt_treatment_plans_bilingual',
                'pt_outcome_measures_bilingual'
            ];

            foreach ($tables as $table) {
                $result = sqlQuery("SELECT COUNT(*) as count FROM `$table`");
                $status['tables'][$table] = [
                    'exists' => true,
                    'row_count' => $result['count'] ?? 0
                ];
            }

            // Check stored procedures
            $procedures = ['get_vietnamese_term', 'get_english_term'];
            foreach ($procedures as $proc) {
                $result = sqlQuery(
                    "SELECT COUNT(*) as count FROM information_schema.ROUTINES
                     WHERE ROUTINE_SCHEMA = DATABASE() AND ROUTINE_NAME = ?",
                    [$proc]
                );
                $status['stored_procedures'][$proc] = $result['count'] > 0;
            }

            // Check critical indexes
            $indexCheck = sqlQuery(
                "SELECT COUNT(*) as count FROM information_schema.STATISTICS
                 WHERE TABLE_SCHEMA = DATABASE()
                 AND TABLE_NAME LIKE 'pt_%bilingual'
                 AND INDEX_NAME LIKE 'idx_%'"
            );
            $status['indexes']['count'] = $indexCheck['count'] ?? 0;

        } catch (\Exception $e) {
            $status['status'] = 'unhealthy';
            $status['error'] = $e->getMessage();
        }

        return $status;
    }

    /**
     * Get detailed services status
     */
    private function getDetailedServicesStatus(): array
    {
        $services = [
            'PTAssessmentService',
            'PTExercisePrescriptionService',
            'PTTreatmentPlanService',
            'PTOutcomeMeasureService',
            'PTMedicalTerminologyService',
            'PTInsuranceIntegrationService',
            'PTSessionNotesService',
            'PTAssessmentTemplateService'
        ];

        $status = [
            'status' => 'healthy',
            'count' => 0,
            'details' => []
        ];

        foreach ($services as $serviceName) {
            $fullClass = "OpenEMR\\Services\\VietnamesePT\\{$serviceName}";
            try {
                if (class_exists($fullClass)) {
                    new $fullClass();
                    $status['details'][$serviceName] = 'available';
                    $status['count']++;
                } else {
                    $status['details'][$serviceName] = 'not_found';
                }
            } catch (\Exception $e) {
                $status['details'][$serviceName] = 'error: ' . $e->getMessage();
                $status['status'] = 'degraded';
            }
        }

        return $status;
    }

    /**
     * Get detailed forms status
     */
    private function getDetailedFormsStatus(): array
    {
        $forms = [
            'vietnamese_pt_assessment',
            'vietnamese_pt_exercise',
            'vietnamese_pt_treatment_plan',
            'vietnamese_pt_outcome'
        ];

        $status = [
            'status' => 'healthy',
            'count' => 0,
            'details' => []
        ];

        foreach ($forms as $formName) {
            $formPath = $GLOBALS['fileroot'] . "/interface/forms/{$formName}";
            $registered = sqlQuery(
                "SELECT state, category FROM registry WHERE directory = ?",
                [$formName]
            );

            $status['details'][$formName] = [
                'path_exists' => file_exists($formPath),
                'registered' => !empty($registered),
                'active' => ($registered['state'] ?? 0) == 1,
                'category' => $registered['category'] ?? null
            ];

            if (!empty($registered) && $registered['state'] == 1) {
                $status['count']++;
            }
        }

        return $status;
    }

    /**
     * Get widget status
     */
    private function getWidgetStatus(): array
    {
        $widgetPath = $GLOBALS['fileroot'] . "/library/custom/vietnamese_pt_widget.php";

        return [
            'status' => file_exists($widgetPath) ? 'healthy' : 'missing',
            'path' => $widgetPath,
            'exists' => file_exists($widgetPath)
        ];
    }

    /**
     * Get cache status
     */
    private function getCacheStatus(): array
    {
        // Basic cache status - can be extended based on caching implementation
        return [
            'status' => 'healthy',
            'type' => 'file',
            'message' => 'No caching issues detected'
        ];
    }

    /**
     * Get performance metrics
     */
    private function getPerformanceMetrics(): array
    {
        $metrics = [];

        try {
            // Test query performance
            $startTime = microtime(true);
            sqlQuery("SELECT COUNT(*) FROM vietnamese_medical_terms");
            $metrics['medical_terms_query_ms'] = round((microtime(true) - $startTime) * 1000, 2);

            $startTime = microtime(true);
            sqlQuery("SELECT COUNT(*) FROM pt_assessments_bilingual");
            $metrics['assessments_query_ms'] = round((microtime(true) - $startTime) * 1000, 2);

            // Memory usage
            $metrics['memory_usage_mb'] = round(memory_get_usage(true) / 1024 / 1024, 2);
            $metrics['memory_peak_mb'] = round(memory_get_peak_usage(true) / 1024 / 1024, 2);

        } catch (\Exception $e) {
            $metrics['error'] = $e->getMessage();
        }

        return $metrics;
    }

    /**
     * Get installation date from configuration
     */
    private function getInstallationDate(): ?string
    {
        try {
            $result = sqlQuery(
                "SELECT config_value FROM pt_configuration WHERE config_key = 'installation_date'"
            );
            return $result['config_value'] ?? null;
        } catch (\Exception $e) {
            return null;
        }
    }

    /**
     * Get last migration from configuration
     */
    private function getLastMigration(): ?string
    {
        try {
            $result = sqlQuery(
                "SELECT config_value FROM pt_configuration WHERE config_key = 'last_migration'"
            );
            return $result['config_value'] ?? null;
        } catch (\Exception $e) {
            return null;
        }
    }
}

// AI-GENERATED CODE END
