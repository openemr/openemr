# Vietnamese Physiotherapy Module - Monitoring Guide

**AI-GENERATED CONTENT**: This documentation was generated by Claude Code

**Version**: 1.0.0
**Date**: 2025-11-22
**Module**: Vietnamese Physiotherapy

---

## Overview

This guide provides comprehensive monitoring setup instructions for the Vietnamese Physiotherapy module, including health checks, performance monitoring, alerting, and log management.

## Table of Contents

1. [Health Check Endpoints](#health-check-endpoints)
2. [Monitoring Tools Integration](#monitoring-tools-integration)
3. [Alert Configuration](#alert-configuration)
4. [Log Management](#log-management)
5. [Performance Metrics](#performance-metrics)
6. [Database Monitoring](#database-monitoring)
7. [Troubleshooting](#troubleshooting)

---

## Health Check Endpoints

### Basic Health Check

**Endpoint**: `GET /apis/default/vietnamese-pt/health`

Returns overall health status of the Vietnamese PT module.

**Response Example**:
```json
{
  "status": "healthy",
  "timestamp": "2025-11-22T10:30:00Z",
  "checks": {
    "database": {
      "status": "healthy",
      "latency_ms": 5,
      "message": "Database connection successful"
    },
    "tables": {
      "status": "healthy",
      "tables_count": 8,
      "message": "All required tables exist"
    },
    "services": {
      "status": "healthy",
      "services_count": 8,
      "message": "All services instantiated successfully"
    },
    "forms": {
      "status": "healthy",
      "registered_count": 4,
      "message": "All PT forms registered"
    },
    "acl": {
      "status": "healthy",
      "aco_entries": 6,
      "message": "ACL configured"
    }
  },
  "response_time_ms": 45.23
}
```

**Status Values**:
- `healthy`: All systems operational
- `degraded`: Some non-critical issues detected
- `unhealthy`: Critical issues requiring attention

### Detailed Health Check

**Endpoint**: `GET /apis/default/vietnamese-pt/health/detailed`

Returns comprehensive component status with performance metrics.

**Response Example**:
```json
{
  "status": "healthy",
  "timestamp": "2025-11-22T10:30:00Z",
  "version": {
    "module": "1.0.0",
    "schema": "003"
  },
  "components": {
    "database": {
      "status": "healthy",
      "tables": {
        "vietnamese_medical_terms": {"exists": true, "row_count": 52},
        "pt_assessments_bilingual": {"exists": true, "row_count": 150},
        "pt_exercise_prescriptions_bilingual": {"exists": true, "row_count": 220},
        "pt_treatment_plans_bilingual": {"exists": true, "row_count": 145},
        "pt_outcome_measures_bilingual": {"exists": true, "row_count": 380}
      },
      "stored_procedures": {
        "get_vietnamese_term": true,
        "get_english_term": true
      },
      "indexes": {"count": 24}
    },
    "services": {
      "status": "healthy",
      "count": 8,
      "details": {
        "PTAssessmentService": "available",
        "PTExercisePrescriptionService": "available",
        "PTTreatmentPlanService": "available",
        "PTOutcomeMeasureService": "available",
        "PTMedicalTerminologyService": "available",
        "PTInsuranceIntegrationService": "available",
        "PTSessionNotesService": "available",
        "PTAssessmentTemplateService": "available"
      }
    },
    "forms": {
      "status": "healthy",
      "count": 4,
      "details": {
        "vietnamese_pt_assessment": {
          "path_exists": true,
          "registered": true,
          "active": true,
          "category": "Clinical"
        },
        "vietnamese_pt_exercise": {
          "path_exists": true,
          "registered": true,
          "active": true,
          "category": "Clinical"
        },
        "vietnamese_pt_treatment_plan": {
          "path_exists": true,
          "registered": true,
          "active": true,
          "category": "Clinical"
        },
        "vietnamese_pt_outcome": {
          "path_exists": true,
          "registered": true,
          "active": true,
          "category": "Clinical"
        }
      }
    },
    "widget": {
      "status": "healthy",
      "exists": true
    },
    "cache": {
      "status": "healthy",
      "type": "file",
      "message": "No caching issues detected"
    }
  },
  "performance": {
    "medical_terms_query_ms": 3.2,
    "assessments_query_ms": 4.1,
    "memory_usage_mb": 12.5,
    "memory_peak_mb": 15.8
  },
  "response_time_ms": 78.45
}
```

### Version Information

**Endpoint**: `GET /apis/default/vietnamese-pt/version`

Returns module version and deployment information.

**Response Example**:
```json
{
  "module_version": "1.0.0",
  "schema_version": "003",
  "installation_date": "2025-11-22 08:00:00",
  "last_migration": "003_add_menu_items.sql",
  "php_version": "8.2.0",
  "openemr_version": "7.0.2"
}
```

---

## Monitoring Tools Integration

### Nagios/Icinga Integration

Create a monitoring check script:

```bash
#!/bin/bash
# /usr/local/nagios/libexec/check_vietnamese_pt.sh

URL="https://your-openemr-instance.com/apis/default/vietnamese-pt/health"
TOKEN="your-api-token"

RESPONSE=$(curl -s -H "Authorization: Bearer $TOKEN" "$URL")
STATUS=$(echo "$RESPONSE" | jq -r '.status')

case $STATUS in
    "healthy")
        echo "OK - Vietnamese PT module is healthy"
        exit 0
        ;;
    "degraded")
        echo "WARNING - Vietnamese PT module is degraded"
        exit 1
        ;;
    "unhealthy")
        echo "CRITICAL - Vietnamese PT module is unhealthy"
        exit 2
        ;;
    *)
        echo "UNKNOWN - Cannot determine Vietnamese PT module status"
        exit 3
        ;;
esac
```

**Nagios Configuration** (`/etc/nagios/objects/vietnamese_pt.cfg`):

```
define command{
    command_name    check_vietnamese_pt
    command_line    /usr/local/nagios/libexec/check_vietnamese_pt.sh
}

define service{
    use                     generic-service
    host_name               openemr-server
    service_description     Vietnamese PT Module Health
    check_command           check_vietnamese_pt
    check_interval          5
    retry_interval          1
    max_check_attempts      3
    notification_interval   30
}
```

### Zabbix Integration

**Zabbix Agent Configuration** (`/etc/zabbix/zabbix_agentd.d/vietnamese_pt.conf`):

```
UserParameter=vietnamese.pt.health,curl -s http://localhost/apis/default/vietnamese-pt/health | jq -r '.status'
UserParameter=vietnamese.pt.response_time,curl -s http://localhost/apis/default/vietnamese-pt/health | jq -r '.response_time_ms'
UserParameter=vietnamese.pt.database_latency,curl -s http://localhost/apis/default/vietnamese-pt/health/detailed | jq -r '.components.database.latency_ms'
```

**Zabbix Template** (import via UI):

```xml
<?xml version="1.0" encoding="UTF-8"?>
<zabbix_export>
    <version>5.0</version>
    <groups>
        <group>
            <name>OpenEMR</name>
        </group>
    </groups>
    <templates>
        <template>
            <template>Vietnamese PT Module</template>
            <name>Vietnamese PT Module</name>
            <groups>
                <group>
                    <name>OpenEMR</name>
                </group>
            </groups>
            <items>
                <item>
                    <name>Vietnamese PT Health Status</name>
                    <key>vietnamese.pt.health</key>
                    <delay>60s</delay>
                    <value_type>TEXT</value_type>
                </item>
                <item>
                    <name>Vietnamese PT Response Time</name>
                    <key>vietnamese.pt.response_time</key>
                    <delay>60s</delay>
                    <value_type>FLOAT</value_type>
                    <units>ms</units>
                </item>
            </items>
            <triggers>
                <trigger>
                    <expression>{Vietnamese PT Module:vietnamese.pt.health.str(unhealthy)}=1</expression>
                    <name>Vietnamese PT Module Unhealthy</name>
                    <priority>HIGH</priority>
                </trigger>
            </triggers>
        </template>
    </templates>
</zabbix_export>
```

### Prometheus Integration

**Prometheus Configuration** (`/etc/prometheus/prometheus.yml`):

```yaml
scrape_configs:
  - job_name: 'vietnamese_pt'
    scrape_interval: 60s
    metrics_path: '/apis/default/vietnamese-pt/health'
    static_configs:
      - targets: ['openemr-server:80']
    relabel_configs:
      - source_labels: [__address__]
        target_label: __param_target
      - source_labels: [__param_target]
        target_label: instance
      - target_label: __address__
        replacement: openemr-server:80
```

**Prometheus Exporter** (custom exporter script):

```python
#!/usr/bin/env python3
# vietnamese_pt_exporter.py

from prometheus_client import start_http_server, Gauge
import requests
import time

# Define metrics
health_status = Gauge('vietnamese_pt_health_status', 'Health status (1=healthy, 0.5=degraded, 0=unhealthy)')
response_time = Gauge('vietnamese_pt_response_time_ms', 'Response time in milliseconds')
database_latency = Gauge('vietnamese_pt_database_latency_ms', 'Database latency in milliseconds')
services_count = Gauge('vietnamese_pt_services_count', 'Number of available services')

def collect_metrics():
    try:
        response = requests.get('http://localhost/apis/default/vietnamese-pt/health')
        data = response.json()

        # Map status to numeric value
        status_map = {'healthy': 1, 'degraded': 0.5, 'unhealthy': 0}
        health_status.set(status_map.get(data['status'], 0))

        response_time.set(data.get('response_time_ms', 0))
        database_latency.set(data['checks']['database'].get('latency_ms', 0))
        services_count.set(data['checks']['services'].get('services_count', 0))

    except Exception as e:
        print(f"Error collecting metrics: {e}")
        health_status.set(0)

if __name__ == '__main__':
    start_http_server(8000)
    while True:
        collect_metrics()
        time.sleep(60)
```

---

## Alert Configuration

### Email Alerts

Configure email notifications for critical events:

```bash
# /etc/cron.d/vietnamese_pt_monitor

*/5 * * * * root /usr/local/bin/check_vietnamese_pt_health.sh

# /usr/local/bin/check_vietnamese_pt_health.sh
#!/bin/bash

STATUS=$(curl -s http://localhost/apis/default/vietnamese-pt/health | jq -r '.status')

if [ "$STATUS" = "unhealthy" ]; then
    echo "ALERT: Vietnamese PT Module is unhealthy" | \
        mail -s "OpenEMR Alert: Vietnamese PT Module Down" admin@example.com
fi
```

### Slack Alerts

Integrate with Slack for real-time notifications:

```bash
#!/bin/bash
# /usr/local/bin/vietnamese_pt_slack_alert.sh

SLACK_WEBHOOK="https://hooks.slack.com/services/YOUR/WEBHOOK/URL"
STATUS=$(curl -s http://localhost/apis/default/vietnamese-pt/health | jq -r '.status')
DETAILS=$(curl -s http://localhost/apis/default/vietnamese-pt/health)

if [ "$STATUS" != "healthy" ]; then
    PAYLOAD=$(cat <<EOF
{
    "text": "Vietnamese PT Module Alert",
    "attachments": [{
        "color": "danger",
        "title": "Status: $STATUS",
        "text": "\`\`\`$DETAILS\`\`\`",
        "footer": "OpenEMR Monitoring",
        "ts": $(date +%s)
    }]
}
EOF
)
    curl -X POST -H 'Content-type: application/json' --data "$PAYLOAD" "$SLACK_WEBHOOK"
fi
```

### Alert Thresholds

Recommended alert thresholds:

| Metric | Warning | Critical |
|--------|---------|----------|
| Response Time | > 500ms | > 2000ms |
| Database Latency | > 100ms | > 500ms |
| Memory Usage | > 500MB | > 1GB |
| Error Rate | > 1% | > 5% |
| Service Availability | < 100% | < 80% |

---

## Log Management

### Log File Locations

Vietnamese PT module logs are located at:

- **Installation logs**: `/var/www/html/openemr/sql/migrations/vietnamese_pt/installation_*.log`
- **Deployment logs**: `/var/www/html/openemr/sql/migrations/vietnamese_pt/deployment_*.log`
- **Backup logs**: `/var/www/html/openemr/sql/migrations/vietnamese_pt/backups/backup_*.log`
- **Application logs**: `/var/www/html/openemr/sites/default/documents/logs_and_misc/logEvents.txt`

### Log Rotation

Configure log rotation (`/etc/logrotate.d/vietnamese_pt`):

```
/var/www/html/openemr/sql/migrations/vietnamese_pt/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 0640 www-data www-data
}
```

### Centralized Logging (ELK Stack)

**Filebeat Configuration** (`/etc/filebeat/filebeat.yml`):

```yaml
filebeat.inputs:
- type: log
  enabled: true
  paths:
    - /var/www/html/openemr/sql/migrations/vietnamese_pt/*.log
  fields:
    application: openemr
    module: vietnamese_pt
  fields_under_root: true

output.elasticsearch:
  hosts: ["localhost:9200"]
  index: "vietnamese-pt-%{+yyyy.MM.dd}"

setup.kibana:
  host: "localhost:5601"
```

**Logstash Filter** (`/etc/logstash/conf.d/vietnamese_pt.conf`):

```
filter {
  if [module] == "vietnamese_pt" {
    grok {
      match => { "message" => "\[%{LOGLEVEL:level}\] %{GREEDYDATA:log_message}" }
    }

    date {
      match => [ "timestamp", "ISO8601" ]
      target => "@timestamp"
    }
  }
}
```

---

## Performance Metrics

### Key Performance Indicators (KPIs)

Monitor these KPIs for optimal performance:

1. **Response Time**
   - Target: < 200ms (95th percentile)
   - Critical: > 2000ms

2. **Database Query Performance**
   - Target: < 50ms (average)
   - Critical: > 500ms

3. **Memory Usage**
   - Target: < 100MB per request
   - Critical: > 500MB

4. **Error Rate**
   - Target: < 0.1%
   - Critical: > 1%

5. **Throughput**
   - Target: > 100 requests/minute
   - Monitor for degradation

### Performance Monitoring Queries

```sql
-- Average response time by endpoint
SELECT
    endpoint,
    AVG(response_time_ms) as avg_response,
    MAX(response_time_ms) as max_response,
    COUNT(*) as request_count
FROM api_logs
WHERE endpoint LIKE '/apis/default/vietnamese-pt/%'
AND timestamp > DATE_SUB(NOW(), INTERVAL 1 HOUR)
GROUP BY endpoint;

-- Slow queries
SELECT
    query,
    execution_time,
    timestamp
FROM slow_query_log
WHERE query LIKE '%pt_%bilingual%'
ORDER BY execution_time DESC
LIMIT 20;

-- Database table sizes
SELECT
    table_name,
    ROUND(((data_length + index_length) / 1024 / 1024), 2) AS size_mb,
    table_rows
FROM information_schema.TABLES
WHERE table_schema = 'openemr'
AND table_name LIKE 'pt_%bilingual'
ORDER BY size_mb DESC;
```

---

## Database Monitoring

### Connection Pool Monitoring

Monitor MySQL connection pool:

```sql
SHOW STATUS LIKE 'Threads_connected';
SHOW STATUS LIKE 'Max_used_connections';
SHOW VARIABLES LIKE 'max_connections';
```

### Index Usage

Monitor index effectiveness:

```sql
SELECT
    t.table_name,
    s.index_name,
    s.cardinality,
    s.seq_in_index
FROM information_schema.STATISTICS s
JOIN information_schema.TABLES t ON s.table_name = t.table_name
WHERE t.table_schema = 'openemr'
AND t.table_name LIKE 'pt_%bilingual'
ORDER BY t.table_name, s.index_name, s.seq_in_index;
```

### Query Performance

Enable slow query log:

```sql
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 1;
SET GLOBAL slow_query_log_file = '/var/log/mysql/slow-query.log';
```

---

## Troubleshooting

### Common Issues

#### 1. Health Check Returns "degraded"

**Diagnosis**:
```bash
curl http://localhost/apis/default/vietnamese-pt/health/detailed | jq '.components'
```

**Common Causes**:
- Missing database tables
- Unregistered forms
- ACL not configured
- Stored procedures missing

**Resolution**:
```bash
# Re-run installation
cd /var/www/html/openemr/sql/migrations/vietnamese_pt
./INSTALL_PRODUCTION.sh
```

#### 2. Slow Response Times

**Diagnosis**:
```sql
-- Check for missing indexes
SELECT
    t.table_name,
    COUNT(DISTINCT s.index_name) as index_count
FROM information_schema.TABLES t
LEFT JOIN information_schema.STATISTICS s ON t.table_name = s.table_name
WHERE t.table_schema = 'openemr'
AND t.table_name LIKE 'pt_%bilingual'
GROUP BY t.table_name;
```

**Resolution**:
```bash
# Apply index migration
mysql -u root -p openemr < /var/www/html/openemr/sql/migrations/vietnamese_pt/001_add_indexes.sql
```

#### 3. Service Instantiation Failures

**Diagnosis**:
```bash
# Check Composer autoload
cd /var/www/html/openemr
composer dump-autoload -o
```

**Resolution**:
```bash
# Rebuild autoload and clear cache
composer dump-autoload -o
rm -rf sites/default/documents/smarty/main/*
```

#### 4. High Memory Usage

**Diagnosis**:
```bash
# Monitor PHP-FPM
cat /var/log/php-fpm/error.log | grep "memory"
```

**Resolution**:
Adjust PHP memory limit in `/etc/php/8.2/fpm/php.ini`:
```ini
memory_limit = 512M
```

---

## Dashboard Templates

### Grafana Dashboard

Import this JSON template for a comprehensive Vietnamese PT monitoring dashboard:

```json
{
  "dashboard": {
    "title": "Vietnamese PT Module",
    "panels": [
      {
        "title": "Health Status",
        "type": "stat",
        "targets": [{
          "expr": "vietnamese_pt_health_status"
        }]
      },
      {
        "title": "Response Time",
        "type": "graph",
        "targets": [{
          "expr": "vietnamese_pt_response_time_ms"
        }]
      },
      {
        "title": "Database Latency",
        "type": "graph",
        "targets": [{
          "expr": "vietnamese_pt_database_latency_ms"
        }]
      }
    ]
  }
}
```

---

## Support

For monitoring issues or questions:

- **Documentation**: See `Documentation/physiotherapy/README.md`
- **Logs**: Check `/var/www/html/openemr/sql/migrations/vietnamese_pt/*.log`
- **Health Check**: `GET /apis/default/vietnamese-pt/health/detailed`

---

**AI-GENERATED CONTENT END**
