#!/usr/bin/env php
<?php

declare(strict_types=1);

use Symfony\Component\Console\Attribute\AsCommand;
use OpenEMR\Modules\Manager\{
    EnableModuleCommand,
    ListModuleCommand,
    ModuleManager,
};
use Symfony\Component\Console\{
    Application,
    CommandLoader\ContainerCommandLoader,
};

chdir(dirname(__DIR__));

require_once 'vendor/autoload.php';

// load DI container
$container = require 'di.php';
$commandMap = [
    'module:enable' => EnableModuleCommand::class,
    'module:list' => ListModuleCommand::class,
];

// add a few system module orinated commands
// for all active modules, filter to those that implement CliModuleInterface
// (recursively?) and feed them in.
$loader = new ContainerCommandLoader($container, $commandMap);
// print_r($loader);

$mm = new ModuleManager();
foreach ($mm->getEnabledModules() as $moduleInfo) {
    print_r($moduleInfo);
    print_r($moduleInfo->getCliCommands());
    foreach ($moduleInfo->getCliCommands() as $commandClass) {
        $commandMap[readCommandName($commandClass)] = $commandClass;
    }
    // Append into the commandMap based on... something. Read the AsCommand
    // attribute of each CliCommand class?
}
var_dump($commandMap);

/**
 * @param class-string $commandClass
 */
function readCommandName(string $commandClass): string
{
    $rc = new ReflectionClass($commandClass);
    $attrs = $rc->getAttributes(AsCommand::class);
    assert(count($attrs) === 1);
    $info = $attrs[0]->newInstance();
    return $info->name;
}

$application = new Application();
$application->setCommandLoader($loader);
// $application->add($container->get(ListModulesCommand::class));
$application->run();
