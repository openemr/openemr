#!/usr/bin/env php
<?php

declare(strict_types=1);

use Psr\Container\ContainerInterface;
use OpenEMR\Modules\Manager\ModuleManager;
use Symfony\Component\Console\{
    Application,
    Attribute\AsCommand,
    CommandLoader\ContainerCommandLoader,
};

require_once __DIR__ . '/../bootstrap.php';

// load DI container
// TODO: figure out how to ensure that module classes get autowired correctly
// This may require writing data to a config file at module enable time
// depending on the DI container used.
$container = require 'di.php';
assert($container instanceof ContainerInterface);

$commandMap = [];
$mm = $container->get(ModuleManager::class);
assert($mm instanceof ModuleManager);
foreach ($mm->getEnabledModules() as $moduleInfo) {
    // print_r($moduleInfo);
    // print_r($moduleInfo->getCliCommands());
    foreach ($moduleInfo->getCliCommands() as $commandClass) {
        $commandMap[readCommandName($commandClass)] = $commandClass;
    }
}
print_r($commandMap);

/**
 * @param class-string $commandClass
 */
function readCommandName(string $commandClass): string
{
    $rc = new ReflectionClass($commandClass);
    $attrs = $rc->getAttributes(AsCommand::class);
    assert(count($attrs) === 1);
    $info = $attrs[0]->newInstance();
    return $info->name;
}

$loader = new ContainerCommandLoader($container, $commandMap);

$application = new Application();
$application->setCommandLoader($loader);
$application->run();
