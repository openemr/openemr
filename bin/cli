#!/usr/bin/env php
<?php

declare(strict_types=1);

use Symfony\Component\Console\Attribute\AsCommand;
use OpenEMR\Modules\Manager\{
    EnableModuleCommand,
    ListModuleCommand,
    ModuleManager,
};
use Symfony\Component\Console\{
    Application,
    CommandLoader\ContainerCommandLoader,
};

require_once __DIR__ . '/../bootstrap.php';

// load DI container
$container = require 'di.php';
$commandMap = [];

$mm = new ModuleManager();
foreach ($mm->getEnabledModules() as $moduleInfo) {
    // print_r($moduleInfo);
    // print_r($moduleInfo->getCliCommands());
    foreach ($moduleInfo->getCliCommands() as $commandClass) {
        $commandMap[readCommandName($commandClass)] = $commandClass;
    }
}
print_r($commandMap);

/**
 * @param class-string $commandClass
 */
function readCommandName(string $commandClass): string
{
    $rc = new ReflectionClass($commandClass);
    $attrs = $rc->getAttributes(AsCommand::class);
    assert(count($attrs) === 1);
    $info = $attrs[0]->newInstance();
    return $info->name;
}

$loader = new ContainerCommandLoader($container, $commandMap);

$application = new Application();
$application->setCommandLoader($loader);
// $application->add($container->get(ListModulesCommand::class));
$application->run();
